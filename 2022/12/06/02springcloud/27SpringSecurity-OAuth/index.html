<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="27SpringSecurity-OAuth认证"><meta name="keywords" content="过滤器,角色,源码分析,权限,用户,资源,OAuth,OAuth2,OAuth认证,github授权认证,gitee授权认证,springsecurity"><meta name="author" content="Bangiao"><meta name="copyright" content="Bangiao"><title>27SpringSecurity-OAuth认证 | Bangiao's Notebooks</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OAuth2%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">OAuth2简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">是什么?</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A4%E7%89%8C%E4%B8%8E%E5%AF%86%E7%A0%81%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.2.</span> <span class="toc-text">令牌与密码的区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E7%A7%8D%E6%8E%88%E6%9D%83%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">四种授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%8E%88%E6%9D%83%E6%96%B9%E5%BC%8F%EF%BC%9A%E6%8E%88%E6%9D%83%E7%A0%81"><span class="toc-number">2.1.</span> <span class="toc-text">第一种授权方式：授权码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E9%9A%90%E8%97%8F%E5%BC%8F-%E7%AE%80%E5%8C%96%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.2.</span> <span class="toc-text">第二种方式：隐藏式(简化模式)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E7%A7%8D%E6%96%B9%E5%BC%8F%EF%BC%9A%E5%AF%86%E7%A0%81%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text">第三种方式：密码式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#GitHub%E6%8E%88%E6%9D%83%E7%99%BB%E5%BD%95"><span class="toc-number">3.</span> <span class="toc-text">GitHub授权登录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%95%E5%B1%82%E9%83%BD%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">3.1.</span> <span class="toc-text">底层都做了什么?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2ClientAutoConfiguration"><span class="toc-number">3.1.1.</span> <span class="toc-text">OAuth2ClientAutoConfiguration</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2ClientRegistrationRepositoryConfiguration%E5%92%8COAuth2WebSecurityConfiguration"><span class="toc-number">3.1.2.</span> <span class="toc-text">OAuth2ClientRegistrationRepositoryConfiguration和OAuth2WebSecurityConfiguration</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2ClientRegistrationRepositoryConfiguration"><span class="toc-number">3.1.2.1.</span> <span class="toc-text">OAuth2ClientRegistrationRepositoryConfiguration</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#OAuth2WebSecurityConfiguration"><span class="toc-number">3.1.2.2.</span> <span class="toc-text">OAuth2WebSecurityConfiguration</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E4%BB%A3%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.1.3.</span> <span class="toc-text">核心代码分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#oauth2Login"><span class="toc-number">3.1.3.1.</span> <span class="toc-text">oauth2Login</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#oauth2Client"><span class="toc-number">3.1.3.2.</span> <span class="toc-text">oauth2Client</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%8E%E6%88%91%E4%BB%AC%E7%9A%84%E7%BD%91%E7%AB%99%E8%B7%B3%E8%BD%AC%E5%88%B0gitee%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">3.1.3.3.</span> <span class="toc-text">从我们的网站跳转到gitee的过程</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://imgsa.baidu.com/forum/pic/item/c8179682d158ccbf63dc944d1bd8bc3eb03541a9.jpg"></div><div class="author-info__name text-center">Bangiao</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/bangiao">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">68</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">634</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">7</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">我的博客</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://juejin.cn/user/4248168662314823">掘金</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30690165">CSDN</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/bangiao/">博客园</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gitee.com/bangiao_admin/projects">Gitee笔记源码</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Bangiao's Notebooks</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章列表</a><a class="site-page" href="/tags">文章标签</a><a class="site-page" href="/categories">文章分类</a><a class="site-page" href="/sources">笔记源码</a><a class="site-page" href="/about">关于</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">27SpringSecurity-OAuth认证</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-12-06</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springcloud/">springcloud</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="OAuth2简介"><a href="#OAuth2简介" class="headerlink" title="OAuth2简介"></a>OAuth2简介</h1><h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么?"></a>是什么?</h2><p><strong>是目前最流行的授权机制，用来授权第三方应用，获取用户数据。</strong></p>
<p><strong>简单说，OAuth 就是一种授权机制。数据的所有者告诉系统，同意授权第三方应用进入系统，获取这些数据。系统从而产生一个短期的进入令牌（token），用来代替密码，供第三方应用使用。</strong></p>
<blockquote>
<p>qq授权登录, 微信授权登录, 微博授权登录, github授权登录等</p>
<p>以上这是都是它的落地实现</p>
</blockquote>
<p>举个例子:</p>
<p>用户想通过QQ登录今日头条，那么今日头条就需要qq的账号密码, 这是不行的, 所以需要另外一种授权机制, 在qq的网站上登录, 然后告知今日头条部分数据(至少告知今日头条我这里登录成功了<code>token</code>), 这样今日头条就根据qq授权返回的信息登录今日头条, 等到下次, 再次访问今日头条后, 今日头条使用<code>token</code>代替qq的账号密码方式登录(一般不需要再次登录了, 只要验证<code>token</code>过期了没有)</p>
<blockquote>
<p>这里讲到了 <code>token</code> , <code>token</code>一般是有过期时间的, 并且通过 <code>token</code> 能够拿到权限列表</p>
</blockquote>
<h2 id="令牌与密码的区别"><a href="#令牌与密码的区别" class="headerlink" title="令牌与密码的区别"></a>令牌与密码的区别</h2><p>令牌（token）与密码（password）的作用是一样的，都可以进入系统，但是有三点差异。</p>
<p>（1）<strong>令牌是短期的，到期会自动失效，用户自己无法修改。</strong>密码一般长期有效，用户不修改，就不会发生变化。</p>
<p>（2）<strong>令牌可以被数据所有者撤销，会立即失效。</strong>以上例而言，屋主可以随时取消快递员的令牌。密码一般不允许被他人撤销。</p>
<p>（3）<strong>令牌有权限范围（scope），比如只能进小区的二号门。</strong>对于网络服务来说，只读令牌就比读写令牌更安全。密码一般是完整权限。</p>
<p>上面这些设计，保证了令牌既可以让第三方应用获得权限，同时又随时可控，不会危及系统安全。这就是 OAuth 2.0 的优点。</p>
<p>注意，只要知道了令牌，就能进入系统。系统一般不会再次确认身份，所以<strong>令牌必须保密，泄漏令牌与泄漏密码的后果是一样的。</strong> 这也是为什么令牌的有效期，一般都设置得很短的原因。</p>
<p>OAuth 2.0 对于如何颁发令牌的细节，规定得非常详细。具体来说，一共分成四种授权类型（authorization grant），即四种颁发令牌的方式，适用于不同的互联网场景。</p>
<blockquote>
<p>所以也需要关注到token的安全问题, 不要泄漏了, 不然就危险了</p>
</blockquote>
<blockquote>
<p><strong>OAuth 的核心就是向第三方应用颁发令牌。</strong></p>
</blockquote>
<h1 id="四种授权模式"><a href="#四种授权模式" class="headerlink" title="四种授权模式"></a>四种授权模式</h1><ul>
<li>授权码（authorization-code）</li>
<li>隐藏式（implicit）</li>
<li>密码式（password）</li>
<li>客户端凭证（client credentials）</li>
</ul>
<blockquote>
<p>不管哪一种授权方式，第三方应用申请令牌之前，都必须先到系统备案，说明自己的身份，然后会拿到两个身份识别码：<code>客户端 ID（client ID）</code>和<code>客户端密钥（client secret）</code>。<strong>这是为了防止令牌被滥用，没有备案过的第三方应用，是不会拿到令牌的。</strong></p>
</blockquote>
<blockquote>
<p>如果你做过微信授权登录一定会熟悉这个流程</p>
</blockquote>
<h2 id="第一种授权方式：授权码"><a href="#第一种授权方式：授权码" class="headerlink" title="第一种授权方式：授权码"></a>第一种授权方式：授权码</h2><p><strong>授权码（authorization code）方式，指的是第三方应用先申请一个授权码，然后再用该码获取令牌。</strong></p>
<p>下面以博客使用qq授权登录的过程为例</p>
<blockquote>
<p>里面的qq网址不对应实际qq网址</p>
<p>下面才是qq授权的实际网址</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://graph.qq.com/oauth2.0/show?<span class="built_in">which</span>=Login&amp;display=pc&amp;response_type=code&amp;client_id=112233445&amp;redirect_uri=https%3A%2F%2Fwww.52pojie.cn%2Fconnect.php%3Fmod%3Dlogin%26op%3Dcallback%26referer%3Dindex.php&amp;state=6d9aaa4d7b6777779d1a36b76c2ddddd&amp;scope=get_user_info%2Cadd_share%2Cadd_t%2Cadd_pic_t%2Cget_repost_list</span><br></pre></td></tr></table></figure>
</blockquote>
<ol>
<li><p>博客提供一个网址给用户, 网址内容: </p>
<ol>
<li>&#96;&#96;&#96;html<br><a target="_blank" rel="noopener" href="https://qq.com/oauth/authorize">https://qq.com/oauth/authorize</a>?<br>  response_type&#x3D;code&amp;<br>  client_id&#x3D;CLIENT_ID&amp;<br>  redirect_uri&#x3D;CALLBACK_URL&amp;<br>  scope&#x3D;read<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. `response_type`: 告知服务端返回类型, 只能是 `code` 或者`token`, 如果是`code` 表明**采用授权码认证模式**</span><br><span class="line"></span><br><span class="line">3. `client_id`：因为认证服务器要知道是哪一个应用在请求授权，所以`client_id`就是**认证服务器给每个应用分配的id**</span><br><span class="line"></span><br><span class="line">4. `scope`：需要获得哪些授权，这个参数的值是由服务提供商定义的，不能随意填写, 这是只是只读</span><br><span class="line"></span><br><span class="line">5. `redirect_uri`：重定向地址, 这里是我们博客的地址, 而且会在博客地址后面添加授权码，让博客获取`code`授权码, 所以这里应该填写我们博客获得`code`的请求地址, 假设地址是: </span><br><span class="line"></span><br><span class="line">   1. ```http</span><br><span class="line">      https://blog.com/callback?code=到时候qq那边给你填写code的具体值</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>用户使用qq的账号密码在qq的授权网址上登录</p>
</li>
<li><p>qq授权用户返回 <code>code</code> 代码, 添加到上面的 <code>redirect_uri</code>地址后面<a target="_blank" rel="noopener" href="https://blog.com/callback?code=AUTHORIZATION_CODE">https://blog.com/callback?code=AUTHORIZATION_CODE</a> , 然后重定向到我们的博客网站上面</p>
</li>
<li><p>博客服务器收到 code 授权码后, 请求新的请求去拿到 <code>token</code></p>
<ol>
<li>&#96;&#96;&#96;html<br><a target="_blank" rel="noopener" href="https://qq.com/oauth/token">https://qq.com/oauth/token</a>?<br> client_id&#x3D;CLIENT_ID&amp;<br> client_secret&#x3D;CLIENT_SECRET&amp;<br> grant_type&#x3D;authorization_code&amp;<br> code&#x3D;AUTHORIZATION_CODE&amp;<br> redirect_uri&#x3D;CALLBACK_URL<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 博客带着在qq上申请到的`client_id`和`client_secret`, `client_secret`就是认证服务器给 `client_id` 分配的密钥, 让认证服务器知道是我们博客正在接收认证</span><br><span class="line"></span><br><span class="line">3. `grant_type`：授权类型，授权码模式默认为 `authorization_code`</span><br><span class="line"></span><br><span class="line">4. `code`：授权码(一次失效), 前一次请求获得的`code`, 这次带上 `code` 去拿到 `token`</span><br><span class="line"></span><br><span class="line">5. `redirect_uri`: 还是回调地址, 这次给你传递的 `token` 以及一些失效信息等数据</span><br><span class="line"></span><br><span class="line">   1. ```json</span><br><span class="line">      &#123;    </span><br><span class="line">        &quot;access_token&quot;:&quot;ACCESS_TOKEN&quot;,</span><br><span class="line">        &quot;token_type&quot;:&quot;bearer&quot;,</span><br><span class="line">        &quot;expires_in&quot;:2592000,</span><br><span class="line">        &quot;refresh_token&quot;:&quot;REFRESH_TOKEN&quot;,</span><br><span class="line">        &quot;scope&quot;:&quot;read&quot;,</span><br><span class="line">        &quot;uid&quot;:100101</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
<blockquote>
<ol>
<li><p>上面的 <code>client_id</code> 和 <code>client_secret</code> 都需要去qq那边申请, 那边可能把<code>client_id</code>叫做 <code>AppId</code>等</p>
</li>
<li><p>获得授权 <code>code</code> 和 <code>token</code> 这两地址中可能还有其他参数, 比如 <code>csrf</code> 哪种校验码等</p>
</li>
<li><p>第二步获得 <code>token</code> 的过程, 是客户端在后台自动发送的, 对用户不可见</p>
</li>
</ol>
</blockquote>
<h2 id="第二种方式：隐藏式-简化模式"><a href="#第二种方式：隐藏式-简化模式" class="headerlink" title="第二种方式：隐藏式(简化模式)"></a>第二种方式：隐藏式(简化模式)</h2><p>有些 Web 应用是纯前端应用，没有后端。这时就不能用上面的方式了，必须将令牌储存在前端。<strong>RFC 6749 就规定了第二种方式，允许直接向前端颁发令牌。这种方式没有授权码这个中间步骤，所以称为（授权码）”隐藏式”（implicit）。</strong></p>
<blockquote>
<p>现在程序员搭建博客网站都流行静态网站，例如Hexo、Jekyll等，这类技术栈有一个共同的特点就是没有后端，开发者不需要将精力放在维护后端网站上，只需要专注于内容创作即可。</p>
</blockquote>
<p>流程</p>
<ol>
<li><p>博客网站上有一个 github 的授权登录按钮, 地址</p>
<ol>
<li><pre><code class="sh">https://github.com/oauth/authorize?
  response_type=token&amp;
  client_id=CLIENT_ID&amp;
  redirect_uri=CALLBACK_URL&amp;
  scope=read&amp;
  _csrf=111
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   2. 基本上和授权码方式一致, 除了 `response_type=token`, 表示直接从授权服务器直接拿 `Access token`, 少了授权码的过程</span><br><span class="line"></span><br><span class="line">2. 用户点击按钮, 跳转到 github, 让用户登录授权, 接着会跳转到 `redirect_uri`的地址, 地址详情大概是这样</span><br><span class="line"></span><br><span class="line">   1. ```sh</span><br><span class="line">      https://blog.com/callback#access_token=xxxxxxxxxxxx&amp;token_type=bearer&amp;expires_in=9999&amp;_csrf=xxx</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>令牌的位置是 URL 锚点（fragment），而不是查询字符串（querystring），这是因为 OAuth 2.0 允许跳转网址是 HTTP 协议，因此存在”中间人攻击”的风险，而浏览器跳转时，锚点不会发到服务器，就减少了泄漏令牌的风险。</p>
</li>
</ol>
</li>
<li><p>接下来客户端向资源服务器发送请求，这个请求不需要携带令牌，资源服务器返回一段JS脚本，客户端执行JS脚本，提取出令牌Access Token。</p>
</li>
</ol>
<blockquote>
<p>这种方式把令牌直接传给前端，是很不安全的。因此，只能用于一些安全要求不高的场景，并且令牌的有效期必须非常短，通常就是会话期间（session）有效，浏览器关掉，令牌就失效了。</p>
</blockquote>
<h2 id="第三种方式：密码式"><a href="#第三种方式：密码式" class="headerlink" title="第三种方式：密码式"></a>第三种方式：密码式</h2><p><strong>如果你高度信任某个应用，RFC 6749 也允许用户把用户名和密码，直接告诉该应用。该应用就使用你的密码，申请令牌，这种方式称为”密码式”（password）。</strong></p>
<p>密码模式的流程比较简单:</p>
<ol>
<li><p>首先用户在第三方应用的登录页面输入登录凭证（用户名&#x2F;密码)</p>
<ol>
<li>&#96;&#96;&#96;sh<br><a target="_blank" rel="noopener" href="https://oauth.qq.com/token">https://oauth.qq.com/token</a>?<br>  grant_type&#x3D;password&amp;<br>  username&#x3D;USERNAME&amp;<br>  password&#x3D;PASSWORD&amp;<br>  client_id&#x3D;CLIENT_ID<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">2. 第三方应用将用户的登录信息发送给授权服务器，获取到令牌Access Token</span><br><span class="line"></span><br><span class="line">3. 授权服务器检查用户的登录信息,如果没有问题,授权服务器以JSON的格式发送令牌Access Token给第三方应用</span><br><span class="line"></span><br><span class="line">## 第四种方式：凭证式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**最后一种方式是凭证式（client credentials），适用于没有前端的命令行应用，即在命令行下请求令牌。**</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">流程:</span><br><span class="line"></span><br><span class="line">1. 客户端发送一个请求到授权服务器</span><br><span class="line"></span><br><span class="line">   1. ```sh</span><br><span class="line">      https://oauth.b.com/token?</span><br><span class="line">        grant_type=client_credentials&amp;</span><br><span class="line">        client_id=CLIENT_ID&amp;</span><br><span class="line">        client_secret=CLIENT_SECRET</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>授权服务器验证通过后，会直接返回Access Token给客户端</p>
</li>
</ol>
<blockquote>
<p>这种方式给出的令牌，是针对客户端使用的，而不是针对用户，即有可能多个用户共享同一个令牌。</p>
</blockquote>
<h1 id="GitHub授权登录"><a href="#GitHub授权登录" class="headerlink" title="GitHub授权登录"></a>GitHub授权登录</h1><blockquote>
<p>说句实话，国内不建议使用github, 因为墙问题, 需要梯子</p>
<p>如果你没没有使用梯子。而是使用fast git或者是别的这种修改hosts的工具。那么可能存在<code>SSL</code>问题。这一点值得注意。</p>
<p>推荐国内使用码云。</p>
</blockquote>
<p>官方文档地址: <a target="_blank" rel="noopener" href="https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app">Creating an OAuth App - GitHub Docs</a></p>
<p>中文版文档地址: <a target="_blank" rel="noopener" href="https://docs.github.com/cn/developers/apps/building-oauth-apps/creating-an-oauth-app">创建 OAuth 应用程序 - GitHub Docs</a></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125311.png" alt="image-20221207111503984"></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125312.png" alt="image-20221207111727045"></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125313.png" alt="image-20221207111603938"></p>
<p>然后把上面的 <code>client_id</code> 和 <code>client_secrets</code> 复制到项目中</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125315.png" alt="image-20221207111842065"></p>
<p>导入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(Principal principal)</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;hello, &quot;</span> + principal.getName();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">security:</span></span><br><span class="line">    <span class="attr">user:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">zhazha</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">&#x27;&#123;noop&#125;123456&#x27;</span></span><br><span class="line">    <span class="attr">oauth2:</span></span><br><span class="line">      <span class="attr">client:</span></span><br><span class="line">        <span class="attr">registration:</span></span><br><span class="line">          <span class="attr">gitee:</span></span><br><span class="line">            <span class="attr">client-name:</span> <span class="string">Gitee</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">b9xxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">61xxxxxxxxxxxxxxxxxxx</span></span><br><span class="line">            <span class="attr">authorization-grant-type:</span> <span class="string">authorization_code</span></span><br><span class="line">            <span class="attr">redirect-uri:</span> <span class="string">&#x27;&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;&#x27;</span></span><br><span class="line">            <span class="attr">scope:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">user_info</span></span><br><span class="line">          <span class="attr">github:</span></span><br><span class="line">            <span class="attr">client-id:</span> <span class="string">efxxxxxxxxxxxxxxxx</span></span><br><span class="line">            <span class="attr">client-secret:</span> <span class="string">20xxxxxxxxxxxxxxxxxxxxxxxxxx</span></span><br><span class="line">        <span class="attr">provider:</span></span><br><span class="line">          <span class="attr">gitee:</span></span><br><span class="line">            <span class="attr">authorization-uri:</span> <span class="string">https://gitee.com/oauth/authorize</span></span><br><span class="line">            <span class="attr">token-uri:</span> <span class="string">https://gitee.com/oauth/token</span></span><br><span class="line">            <span class="attr">user-info-uri:</span> <span class="string">https://gitee.com/api/v5/user</span></span><br><span class="line">            <span class="attr">user-name-attribute:</span> <span class="string">name</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>这里有很多相关配置:</p>
<table>
<thead>
<tr>
<th><code>spring.security.oauth2.client.registration.[registrationId]</code></th>
<th><code>registrationId</code></th>
</tr>
</thead>
<tbody><tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].client-id</code></td>
<td><code>clientId</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].client-secret</code></td>
<td><code>clientSecret</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].client-authentication-method</code></td>
<td><code>clientAuthenticationMethod</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].authorization-grant-type</code></td>
<td><code>authorizationGrantType</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].redirect-uri</code></td>
<td><code>redirectUri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].scope</code></td>
<td><code>scopes</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.registration.[registrationId].client-name</code></td>
<td><code>clientName</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].authorization-uri</code></td>
<td><code>providerDetails.authorizationUri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].token-uri</code></td>
<td><code>providerDetails.tokenUri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].jwk-set-uri</code></td>
<td><code>providerDetails.jwkSetUri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].issuer-uri</code></td>
<td><code>providerDetails.issuerUri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].user-info-uri</code></td>
<td><code>providerDetails.userInfoEndpoint.uri</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].user-info-authentication-method</code></td>
<td><code>providerDetails.userInfoEndpoint.authenticationMethod</code></td>
</tr>
<tr>
<td><code>spring.security.oauth2.client.provider.[providerId].user-name-attribute</code></td>
<td><code>providerDetails.userInfoEndpoint.userNameAttributeName</code></td>
</tr>
</tbody></table>
</blockquote>
<blockquote>
<p>为什么上面可以直接使用 <code>github</code> 呢? 因为他有默认配置<code>CommonOAuth2Provider</code>, 配置了<code>GOOGLE</code>, <code>GITHUB</code>, <code>FACEBOOK</code>和<code>OKTA</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GITHUB &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="keyword">public</span> Builder <span class="title function_">getBuilder</span><span class="params">(String registrationId)</span> &#123;</span><br><span class="line">      ClientRegistration.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> getBuilder(registrationId,</span><br><span class="line">            ClientAuthenticationMethod.CLIENT_SECRET_BASIC, DEFAULT_REDIRECT_URL);</span><br><span class="line">      builder.scope(<span class="string">&quot;read:user&quot;</span>);</span><br><span class="line">      builder.authorizationUri(<span class="string">&quot;https://github.com/login/oauth/authorize&quot;</span>);</span><br><span class="line">      builder.tokenUri(<span class="string">&quot;https://github.com/login/oauth/access_token&quot;</span>);</span><br><span class="line">      builder.userInfoUri(<span class="string">&quot;https://api.github.com/user&quot;</span>);</span><br><span class="line">      builder.userNameAttributeName(<span class="string">&quot;id&quot;</span>);</span><br><span class="line">      builder.clientName(<span class="string">&quot;GitHub&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> builder;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>直接访问 <code>/hello</code> 会重定向到 <code>github</code> 地址:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/login/oauth/authorize?response_type=code&amp;client_id=efyyyyyyyyyyyyy&amp;scope=<span class="built_in">read</span>:user&amp;state=EdJGfXS5W7j6waCQSXzkfxEcrlLdRbJyE8fMe3U2utU%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/github</span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125316.png" alt="image-20221207114213904"></p>
<blockquote>
<p>踩坑: 如果你设置了 FastGit 之类的工具, 可能导致 Github SSL 报错, 在认证的时候需要关闭改功能</p>
</blockquote>
<p>在这里加上 Gitee 网站上的配置吧</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125317.png" alt="image-20221208214353037"></p>
<p>从这个地方入手, 配置好</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125318.png" alt="image-20221208214439247"></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125319.png" alt="image-20221208214458877"></p>
<h2 id="底层都做了什么"><a href="#底层都做了什么" class="headerlink" title="底层都做了什么?"></a>底层都做了什么?</h2><p>首先回忆下OAuth2认证的过程, 大体上有两个重要步骤</p>
<ol>
<li>获得 <code>code</code> 的过程</li>
<li>借助 <code>code</code> 获得 <code>access_token</code> 相关对象的过程</li>
</ol>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125320.png" alt="image-20221209011427525"></p>
<p>在第一个过程中, 客户端发送了三个参数, 然后授权服务器验证成功借助客户端发送的redirect_uri携带 code 参数返回给客户端</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090125321.png" alt="image-20221209012226362"></p>
<p>第二步将上面几个参数一起传递给授权服务器, 其中<code>client-secret</code>参数和<code>client-id</code>参数需要事先去授权服务器创建第三方APP</p>
<blockquote>
<p>一般这个请求由客户端内部自主请求, 用户不会在浏览器看到请求 <code>access_token</code> 的过程</p>
</blockquote>
<h3 id="OAuth2ClientAutoConfiguration"><a href="#OAuth2ClientAutoConfiguration" class="headerlink" title="OAuth2ClientAutoConfiguration"></a><code>OAuth2ClientAutoConfiguration</code></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration(before = SecurityAutoConfiguration.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; EnableWebSecurity.class, ClientRegistration.class &#125;)</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</span></span><br><span class="line"><span class="meta">@Import(&#123; OAuth2ClientRegistrationRepositoryConfiguration.class, OAuth2WebSecurityConfiguration.class &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OAuth2ClientAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>代码从这里开始</p>
<ol>
<li><p><code>@AutoConfiguration(before = SecurityAutoConfiguration.class)</code></p>
<p>表示<code>OAuth2ClientAutoConfiguration</code>自动配置类的加载优先于<code>SecurityAutoConfiguration</code></p>
</li>
<li><p><code>@ConditionalOnClass(&#123; EnableWebSecurity.class, ClientRegistration.class &#125;)</code>保证<code>classpath</code>中导入了spring security依赖和spring oauth认证依赖包</p>
</li>
<li><p><code>@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.SERVLET)</code>保证是servlet项目</p>
</li>
<li><p>导入两个配置类<code>OAuth2ClientRegistrationRepositoryConfiguration</code>和<code>OAuth2WebSecurityConfiguration</code></p>
</li>
</ol>
<blockquote>
<p>下面我们就不分析这么细了</p>
</blockquote>
<h3 id="OAuth2ClientRegistrationRepositoryConfiguration和OAuth2WebSecurityConfiguration"><a href="#OAuth2ClientRegistrationRepositoryConfiguration和OAuth2WebSecurityConfiguration" class="headerlink" title="OAuth2ClientRegistrationRepositoryConfiguration和OAuth2WebSecurityConfiguration"></a><code>OAuth2ClientRegistrationRepositoryConfiguration</code>和<code>OAuth2WebSecurityConfiguration</code></h3><p>现在我们分析这两个类</p>
<h4 id="OAuth2ClientRegistrationRepositoryConfiguration"><a href="#OAuth2ClientRegistrationRepositoryConfiguration" class="headerlink" title="OAuth2ClientRegistrationRepositoryConfiguration"></a><code>OAuth2ClientRegistrationRepositoryConfiguration</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@EnableConfigurationProperties(OAuth2ClientProperties.class)</span></span><br><span class="line"><span class="meta">@Conditional(ClientsConfiguredCondition.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OAuth2ClientRegistrationRepositoryConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean(ClientRegistrationRepository.class)</span></span><br><span class="line">   InMemoryClientRegistrationRepository <span class="title function_">clientRegistrationRepository</span><span class="params">(OAuth2ClientProperties properties)</span> &#123;</span><br><span class="line">      List&lt;ClientRegistration&gt; registrations = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(</span><br><span class="line">            OAuth2ClientPropertiesRegistrationAdapter.getClientRegistrations(properties).values());</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryClientRegistrationRepository</span>(registrations);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><code>@Conditional(ClientsConfiguredCondition.class)</code>满足条件才能加载, 这里的条件主要还是判断能不能拿到<code>registrations</code>变量</li>
<li><code>InMemoryClientRegistrationRepository</code>主要提供了针对<code>ClientRegistration</code>对象的增查功能<ol>
<li><img src="https://jsd.cdn.zzko.cn/gh/b/blog_images@main/blog/202212090022708.png" alt="image-20221209002222618"></li>
<li>注意看接口, 等下会有跟这个接口相关的功能</li>
<li><code>ClientRegistration</code>对象主要保存了认证信息的一些属性, 比如 <code>client_id</code>, <code>redirect_url</code>等</li>
<li>这些数据都被保存在内存中, 说白了, 就是<code>InMemoryClientRegistrationRepository</code>的一个<code>Map</code>属性</li>
</ol>
</li>
</ol>
<blockquote>
<p>核心类: <code>ClientRegistrationRepository</code></p>
<p>这里相当于在OAuth认证过程中开始组装参数的过程, 还没发出第一次获取授权<code>code</code>请求的时候</p>
</blockquote>
<h4 id="OAuth2WebSecurityConfiguration"><a href="#OAuth2WebSecurityConfiguration" class="headerlink" title="OAuth2WebSecurityConfiguration"></a><code>OAuth2WebSecurityConfiguration</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ClientRegistrationRepository.class)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OAuth2WebSecurityConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">   OAuth2AuthorizedClientService <span class="title function_">authorizedClientService</span><span class="params">(ClientRegistrationRepository clientRegistrationRepository)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryOAuth2AuthorizedClientService</span>(clientRegistrationRepository);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">   OAuth2AuthorizedClientRepository <span class="title function_">authorizedClientRepository</span><span class="params">(OAuth2AuthorizedClientService authorizedClientService)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AuthenticatedPrincipalOAuth2AuthorizedClientRepository</span>(authorizedClientService);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">   <span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line">   <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OAuth2SecurityFilterChainConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">      <span class="meta">@Bean</span></span><br><span class="line">      SecurityFilterChain <span class="title function_">oauth2SecurityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());</span><br><span class="line">         http.oauth2Login(Customizer.withDefaults());</span><br><span class="line">         http.oauth2Client();</span><br><span class="line">         <span class="keyword">return</span> http.build();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><p><code>@ConditionalOnBean(ClientRegistrationRepository.class)</code>, 条件判断, 这里将会和上头的<code>InMemoryClientRegistrationRepository</code>对象联动, 改对象的接口就是<code>ClientRegistrationRepository</code>, 主要的目的是提供了找到<code>ClientRegistration</code>的功能</p>
</li>
<li><pre><code class="java">@Bean
@ConditionalOnMissingBean
OAuth2AuthorizedClientService authorizedClientService(ClientRegistrationRepository clientRegistrationRepository) &#123;
    return new InMemoryOAuth2AuthorizedClientService(clientRegistrationRepository);
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   1. `OAuth2AuthorizedClientService`对象提供了针对`OAuth2AuthorizedClient`的增删查功能</span><br><span class="line"></span><br><span class="line">   2. `OAuth2AuthorizedClient`对象主要保存了认证成功的`Client`对象</span><br><span class="line"></span><br><span class="line">      1. 这个`OAuth2AuthorizedClient`对象保存了</span><br><span class="line"></span><br><span class="line">         1. `ClientRegistration`(前面刚说的)</span><br><span class="line"></span><br><span class="line">         2. `principalName`(用户名)</span><br><span class="line"></span><br><span class="line">         3. `accessToken: OAuth2AccessToken`认证成功的`access_token`对象(这个对象保存了scope, token类型, 过期时间, 创建时间)</span><br><span class="line"></span><br><span class="line">         4. `refreshToken: OAuth2RefreshToken`刷新`access_token`值的对象, `access_token`是有过期时间的, 如果认证官方提供了刷新 `access_token` 的功能, 就需要借助`refreshToken`去更新过期的`access_token`</span><br><span class="line"></span><br><span class="line">            &gt; `access_token`存在安全问题, 不能长时间存在, 所以我们需要在每次访问请求时判断 `access_token`是否过期, 以即时更新</span><br><span class="line"></span><br><span class="line">   3. `InMemoryOAuth2AuthorizedClientService`这个对象是`OAuth2AuthorizedClientService`实现类, 将对象保存在属性中</span><br><span class="line"></span><br><span class="line">      1. `authorizedClients: Map&lt;OAuth2AuthorizedClientId, OAuth2AuthorizedClient&gt;`这里面面有两个不熟悉的存放数据的结构</span><br><span class="line">         1. `OAuth2AuthorizedClientId`: 里面保存了`clientRegistrationId`和`principalName`用户名</span><br><span class="line">         2. `OAuth2AuthorizedClient`上面已经研究过了</span><br><span class="line">         3. `InMemoryOAuth2AuthorizedClientService`对象的增删查跟`authorizedClients`对象有关系</span><br><span class="line">      2. `clientRegistrationRepository: ClientRegistrationRepository`这个对象主要负责获取`ClientRegistration`对象, 在`InMemoryOAuth2AuthorizedClientService`这个类中只有读取`ClientRegistration`判断是否为空的功能, 而且是在加载和删除两个函数中</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@Bean</span><br><span class="line">@ConditionalOnMissingBean</span><br><span class="line">OAuth2AuthorizedClientRepository authorizedClientRepository(OAuth2AuthorizedClientService authorizedClientService) &#123;</span><br><span class="line">   return new AuthenticatedPrincipalOAuth2AuthorizedClientRepository(authorizedClientService);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>接口<code>OAuth2AuthorizedClientRepository</code>提供了三个功能: 加载, 保存和删除认证后对象<code>OAuth2AuthorizedClient</code></p>
</li>
<li><p>spring security默认使用该接口的实现类: <code>AuthenticatedPrincipalOAuth2AuthorizedClientRepository</code>, 这里有三个属性<code>authenticationTrustResolver</code>, <code>authorizedClientService</code>和<code>anonymousAuthorizedClientRepository</code></p>
<ol>
<li><code>authenticationTrustResolver</code>属性主要判断是<code>memberMe</code>还是<code>anonymous</code></li>
<li><code>authorizedClientService</code>操作的是在内存中的<code>OAuth2AuthorizedClient</code>对象, 这个属性在构建Bean的时候已经保存进来了</li>
<li><code>anonymousAuthorizedClientRepository</code>属性操作的是<code>Session</code>中的<code>OAuth2AuthorizedClient</code></li>
</ol>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OAuth2SecurityFilterChainConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">   SecurityFilterChain <span class="title function_">oauth2SecurityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());</span><br><span class="line">      http.oauth2Login(Customizer.withDefaults());</span><br><span class="line">      http.oauth2Client();</span><br><span class="line">      <span class="keyword">return</span> http.build();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li><code>@ConditionalOnDefaultWebSecurity</code>如果没有自己web security配置类的话, 下面的配置类才会生效</li>
</ol>
<p>接下来就是核心代码的分析了, 等下, 总结下上面的整个过程</p>
<ol>
<li>首先是<code>ClientRegistrationRepository</code>, 主要是读取我们配置的<code>ClientRegistration</code></li>
<li>然后是<code>OAuth2AuthorizedClientService</code>, 主要修改在内存中的<code>OAuth2AuthorizedClient</code>认证后信息保存对象</li>
<li><code>OAuth2AuthorizedClientRepository</code>, 修改在<code>session</code>中的<code>OAuth2AuthorizedClient</code>对象</li>
<li>最后是<code>SecurityFilterChain</code>, 懂得都懂</li>
</ol>
<p>所以最终就围绕着两个对象, 一个是<code>ClientRegistration</code>, 另一个是<code>OAuth2AuthorizedClient</code></p>
<p>还有<code>OAuth2AuthorizedClient</code>对象明摆着可以自己继承扩展它</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317186.png" alt="image-20221209173154519"></p>
<h3 id="核心代码分析"><a href="#核心代码分析" class="headerlink" title="核心代码分析"></a>核心代码分析</h3><blockquote>
<p>这次的核心代码不使用流程图分析了</p>
</blockquote>
<h4 id="oauth2Login"><a href="#oauth2Login" class="headerlink" title="oauth2Login"></a><code>oauth2Login</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">SecurityFilterChain <span class="title function_">oauth2SecurityFilterChain</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">   http.authorizeRequests((requests) -&gt; requests.anyRequest().authenticated());</span><br><span class="line">   http.oauth2Login(Customizer.withDefaults());</span><br><span class="line">   http.oauth2Client();</span><br><span class="line">   <span class="keyword">return</span> http.build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>OAuth2LoginConfigurer</code>的方法<code>init</code>:</p>
<p>在这个方法中, 我们能够看到<code>OAuth2LoginAuthenticationFilter</code>这个过滤器被创建</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317187.png" alt="image-20221209193005864"></p>
<ol>
<li>该<code>OAuth2LoginAuthenticationFilter</code>里面被设置了两个仓库类, 也就是我们前面强调的两个被操作对象: <code>ClientRegistration</code>和<code>OAuth2AuthorizedClient</code>, 还有一个是该过滤器将要处理的 <code>url</code> 地址<code>/login/oauth2/code/*</code>, 并且创建了个<code>url</code>的匹配器</li>
</ol>
<blockquote>
<p><code>OAuth2LoginAuthenticationFilter</code>这个过滤器比较重要</p>
</blockquote>
<ol start="2">
<li>配置了认证错误后访问的地址: <code>/login?error</code></li>
<li>初始化登出功能</li>
<li>判断是否已经配置了<code>permitAll</code>, 让, 登录页面地址, 登陆地址和错误地址加入到白名单中, 允许访问, 这里<code>permitAll = false</code></li>
<li>配置默认授权入口点, 该入口点主要功能在https和http之间切换</li>
<li>还创建了<code>OAuth2LoginAuthenticationProvider</code>提供认证使用</li>
<li>最后配置<code>DefaultLoginPageGeneratingFilter</code>对象, 启动 oauth认证, 添加认证地址, 登录和失败地址</li>
</ol>
<h4 id="oauth2Client"><a href="#oauth2Client" class="headerlink" title="oauth2Client"></a><code>oauth2Client</code></h4><p>核心类:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OAuth2AuthorizationCodeAuthenticationProvider</span><br><span class="line">OAuth2AuthorizationRequestRedirectFilter</span><br><span class="line">OAuth2AuthorizationCodeGrantFilter</span><br></pre></td></tr></table></figure>





<p>现在我们开始跟流程分析</p>
<h4 id="从我们的网站跳转到gitee的过程"><a href="#从我们的网站跳转到gitee的过程" class="headerlink" title="从我们的网站跳转到gitee的过程"></a>从我们的网站跳转到<code>gitee</code>的过程</h4><p>首先打开登录首页后, 点击<code>Gitee</code>按钮, 访问<code>/oauth2/authorization/gitee</code>地址准备跳转到<code>gitee</code></p>
<ol>
<li><p><code>OAuth2AuthorizationRequestRedirectFilter</code>拦截下来的</p>
<ol>
<li><blockquote>
<p>第一波跳转主要是为了从我们的网站跳转到 授权网站的地址, 准备拿到 <code>code</code>授权码</p>
</blockquote>
</li>
</ol>
</li>
<li><p>首先进入的是<code>doFilterInternal</code>函数</p>
</li>
<li><p><code>resolve</code>函数解析得到<code>OAuth2AuthorizationRequest</code>对象</p>
<ol>
<li>这里明显可以看出用于存放前端解析出来的数据</li>
</ol>
</li>
<li><p>调用<code>return resolve(request, &quot;gitee&quot;, &quot;login&quot;)</code></p>
</li>
<li><p><code>this.clientRegistrationRepository.findByRegistrationId(&quot;gitee&quot;)</code>获取<code>ClientRegistration</code>对象</p>
<ol>
<li><p>调用的是这个对象<code>InMemoryClientRegistrationRepository</code>也就是从内存中读取数据</p>
</li>
<li><pre><code class="json">&#123;
     &quot;registrationId&quot;: &quot;gitee&quot;,
     &quot;clientId&quot;: &quot;b9xxxxxxxxxxxxxxxxxxxxxxx&quot;,
     &quot;clientSecret&quot;: &quot;61xxxxxxxxxxxxxxxxxxxxxx&quot;,
     &quot;clientAuthenticationMethod&quot;: &#123;
          &quot;value&quot;: &quot;client_secret_basic&quot;
     &#125;,
     &quot;authorizationGrantType&quot;: &#123;
          &quot;value&quot;: &quot;authorization_code&quot;
     &#125;,
     &quot;redirectUri&quot;: &quot;&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;&quot;,
     &quot;scopes&quot;: [
          &quot;user_info&quot;
     ],
     &quot;providerDetails&quot;: &#123;
          &quot;authorizationUri&quot;: &quot;https://gitee.com/oauth/authorize&quot;,
          &quot;tokenUri&quot;: &quot;https://gitee.com/oauth/token&quot;,
          &quot;userInfoEndpoint&quot;: &#123;
               &quot;uri&quot;: &quot;https://gitee.com/api/v5/user&quot;,
               &quot;authenticationMethod&quot;: &#123;
                    &quot;value&quot;: &quot;header&quot;
               &#125;,
               &quot;userNameAttributeName&quot;: &quot;name&quot;
          &#125;,
          &quot;configurationMetadata&quot;: &#123;&#125;
     &#125;,
     &quot;clientName&quot;: &quot;Gitee&quot;
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">6. 将上面的对象传递给 `getBuilder`函数</span><br><span class="line"></span><br><span class="line">   1. 判断是不是`AuthorizationGrantType.AUTHORIZATION_CODE`类型, 是</span><br><span class="line"></span><br><span class="line">   2. 获得`OAuth2AuthorizationRequest.authorizationCode()`然后给attribute, key = &quot;registration_id&quot;, value 等于`gitee`</span><br><span class="line"></span><br><span class="line">   3. 判断 `scope` 是否为空, 这里不为空, 我配置了 `user_info`, 但是它还有判断OpenID, 这里我们没有启动</span><br><span class="line"></span><br><span class="line">      1. ```java</span><br><span class="line">         if (!CollectionUtils.isEmpty(clientRegistration.getScopes())</span><br><span class="line">               &amp;&amp; clientRegistration.getScopes().contains(OidcScopes.OPENID))</span><br></pre></td></tr></table></figure>
</code></pre>
</li>
<li><p>直接返回<code>OAuth2AuthorizationRequest.Builder builder</code></p>
</li>
</ol>
</li>
<li><p><code>String redirectUriStr = expandRedirectUri(request, clientRegistration, &quot;login&quot;)</code></p>
<ol>
<li><p>这个方法开头直接创建一个Map集合<code>uriVariables</code></p>
</li>
<li><p>拿到<code>http://localhost:8080/oauth2/authorization/gitee</code>, 并且创建一个<code>UriComponents</code>对象</p>
</li>
<li><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317188.png" alt="image-20221210024138069"></p>
</li>
<li><p>最终这个变量内容大致是这样:</p>
<ol>
<li>&#96;&#96;&#96;json<br>{<br> “basePort”: “:8080”,<br> “baseUrl”: “<a href="http://localhost:8080&quot;">http://localhost:8080&quot;</a>,<br> “basePath”: “”,<br> “baseHost”: “localhost”,<br> “registrationId”: “gitee”,<br> “baseScheme”: “http”,<br> “action”: “login”<br>}<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">      2. `clientRegistration.getRedirectUri()`拿到`&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;`</span><br><span class="line"></span><br><span class="line">   5. 最终返回这个字符串`http://localhost:8080/login/oauth2/code/gitee`</span><br><span class="line"></span><br><span class="line">8. 接着就是`OAuth2AuthorizationRequest.Builder.builder`的过程了,这个过程创建了`OAuth2AuthorizationRequest`对象, 在这个`build`中构建了一个对象</span><br><span class="line"></span><br><span class="line">   1. ```json</span><br><span class="line">      &#123;</span><br><span class="line">           &quot;authorizationUri&quot;: &quot;https://gitee.com/oauth/authorize&quot;,</span><br><span class="line">           &quot;responseType&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;code&quot;</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;clientId&quot;: &quot;b9xxxxxxxxxxxxxxxxx&quot;,</span><br><span class="line">           &quot;redirectUri&quot;: &quot;http://localhost:8080/login/oauth2/code/gitee&quot;,</span><br><span class="line">           &quot;scopes&quot;: [</span><br><span class="line">                &quot;user_info&quot;</span><br><span class="line">           ],</span><br><span class="line">           &quot;state&quot;: &quot;jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594=&quot;,</span><br><span class="line">           &quot;additionalParameters&quot;: &#123;&#125;,</span><br><span class="line">           &quot;authorizationRequestUri&quot;: &quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b9xxxxxxxxxxxxxxxxxxxx&amp;scope=user_info&amp;state=jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;,</span><br><span class="line">           &quot;attributes&quot;: &#123;</span><br><span class="line">                &quot;registration_id&quot;: &quot;gitee&quot;</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>涉及到的类<img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317189.png" alt="image-20221210030219379"></p>
</li>
</ol>
</li>
<li><p>现在在<code>OAuth2AuthorizationRequestRedirectFilter#doFilterInternal</code>函数调用<code>sendRedirectForAuthorization</code>函数</p>
</li>
<li><p>&#96;&#96;&#96;java<br>sendRedirectForAuthorization(HttpServletRequest request, HttpServletResponse response,<br>  OAuth2AuthorizationRequest authorizationRequest)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1. 继续判断是不是`code`授权码方式, 是</span><br><span class="line"></span><br><span class="line">2. `this.authorizationRequestRepository.saveAuthorizationRequest(authorizationRequest, request, response);`</span><br><span class="line"></span><br><span class="line">3. 跳转到这个类`HttpSessionOAuth2AuthorizationRequestRepository`</span><br><span class="line"></span><br><span class="line">4. 拿到`state`, 但因为不是多`OAuth2AuthorizationRequest`所以没有执行, 否则存储到`session`中的数据是`Map&lt;String, OAuth2AuthorizationRequest&gt;`对象, 将 `state`作为`key`, 那个`Map`作为`value`存储`authorizationRequests.put(state, authorizationRequest);`</span><br><span class="line"></span><br><span class="line">5. `request.getSession().setAttribute(this.sessionAttributeName, authorizationRequest);`,  `key = &quot;org.springframework.security.oauth2.client.web.HttpSessionOAuth2AuthorizationRequestRepository.AUTHORIZATION_REQUEST&quot;, value = &quot;authorizationRequest&quot;` 对象存储到`Session`中, 上面的</span><br><span class="line"></span><br><span class="line">6. `authorizationRequest`对象的`JSON`是</span><br><span class="line"></span><br><span class="line">   1. ```json</span><br><span class="line">      &#123;</span><br><span class="line">           &quot;authorizationUri&quot;: &quot;https://gitee.com/oauth/authorize&quot;,</span><br><span class="line">           &quot;responseType&quot;: &#123;</span><br><span class="line">                &quot;value&quot;: &quot;code&quot;</span><br><span class="line">           &#125;,</span><br><span class="line">           &quot;clientId&quot;: &quot;b9aaaaaaaaaaaaaaaaaaa&quot;,</span><br><span class="line">           &quot;redirectUri&quot;: &quot;http://localhost:8080/login/oauth2/code/gitee&quot;,</span><br><span class="line">           &quot;scopes&quot;: [</span><br><span class="line">                &quot;user_info&quot;</span><br><span class="line">           ],</span><br><span class="line">           &quot;state&quot;: &quot;jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594=&quot;,</span><br><span class="line">           &quot;additionalParameters&quot;: &#123;&#125;,</span><br><span class="line">           &quot;authorizationRequestUri&quot;: &quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b9aaaaaaaaaaaaaaaa&amp;scope=user_info&amp;state=jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;,</span><br><span class="line">           &quot;attributes&quot;: &#123;</span><br><span class="line">                &quot;registration_id&quot;: &quot;gitee&quot;</span><br><span class="line">           &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<ol start="7">
<li><p><code>DefaultRedirectStrategy#sendRedirect(req, res, &quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b9aaaaaaaaaaaaaaaaaa&amp;scope=user_info&amp;state=jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;)</code></p>
</li>
<li><p><code>redirectUrl = response.encodeRedirectURL(redirectUrl)</code>解码上面的地址</p>
</li>
<li><p>重定向到上面的解码出来的<code>url</code></p>
<ol>
<li>&#96;&#96;&#96;sh<br><a target="_blank" rel="noopener" href="https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b9aaaaa&amp;scope=user_info&amp;state=jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594=&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee">https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b9aaaaa&amp;scope=user_info&amp;state=jBAXBNes_M6Oj-SsunPf4UVYEXXNWCPM0hGlZSa7594%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee</a><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### `gitee`账户密码登录成功跳转回来的过程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 紧接着是`OAuth2LoginAuthenticationFilter#attemptAuthentication`过滤器</span><br><span class="line"></span><br><span class="line">- ![image-20221210032226672](https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317190.png)</span><br><span class="line"></span><br><span class="line">- ```java</span><br><span class="line">  // 是否认证, 认证的话直接跳过, 否则抛出异常</span><br><span class="line">  if (!OAuth2AuthorizationResponseUtils.isAuthorizationResponse(params)) &#123;</span><br><span class="line">     OAuth2Error oauth2Error = new OAuth2Error(OAuth2ErrorCodes.INVALID_REQUEST);</span><br><span class="line">     throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
</ol>
</li>
</ol>
<ul>
<li><p><code>HttpSessionOAuth2AuthorizationRequestRepository</code>中删除<code>OAuth2AuthorizationRequest</code>对象</p>
</li>
<li><p>&#96;&#96;&#96;java<br>@Override<br>public OAuth2AuthorizationRequest removeAuthorizationRequest(HttpServletRequest request) {<br>&#x2F;&#x2F; 拿到 state 的值<br>String stateParameter &#x3D; this.getStateParameter(request);<br>if (stateParameter &#x3D;&#x3D; null) {<br>    return null;<br>}<br>&#x2F;&#x2F; new HashMap 本来是需要从 session 中拿的<br>Map&lt;String, OAuth2AuthorizationRequest&gt; authorizationRequests &#x3D; this.getAuthorizationRequests(request);<br>OAuth2AuthorizationRequest originalRequest &#x3D; authorizationRequests.remove(stateParameter);<br>if (authorizationRequests.size() &#x3D;&#x3D; 0) {<br>    &#x2F;&#x2F; 从 session中删除 org.springframework.security.oauth2.client.web.HttpSessionOAuth2AuthorizationRequestRepository.AUTHORIZATION_REQUEST<br>    request.getSession().removeAttribute(this.sessionAttributeName);<br>}<br>else if (authorizationRequests.size() &#x3D;&#x3D; 1) {<br>    request.getSession().setAttribute(this.sessionAttributeName,<br>                                      authorizationRequests.values().iterator().next());<br>}<br>else {<br>    request.getSession().setAttribute(this.sessionAttributeName, authorizationRequests);<br>}<br>return originalRequest;<br>}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">`OAuth2LoginAuthenticationFilter`</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">```java</span><br><span class="line">@Override</span><br><span class="line">public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)</span><br><span class="line">      throws AuthenticationException &#123;</span><br><span class="line">   // 前面这几行代码分析过了, 就拿到了 code 和 state, 这两个参数需要从gitee那边返回过来</span><br><span class="line">   // 这里拿到了 OAuth2AuthorizationRequest</span><br><span class="line">    // 这里拿到了认证的请求</span><br><span class="line">   OAuth2AuthorizationRequest authorizationRequest = this.authorizationRequestRepository</span><br><span class="line">         .removeAuthorizationRequest(request, response);</span><br><span class="line">   if (authorizationRequest == null) &#123;</span><br><span class="line">      OAuth2Error oauth2Error = new OAuth2Error(AUTHORIZATION_REQUEST_NOT_FOUND_ERROR_CODE);</span><br><span class="line">      throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span><br><span class="line">   &#125;</span><br><span class="line">    // 这里拿到认证的类型也就是registrationId, 这里类似于 id , 值是 gitee</span><br><span class="line">   String registrationId = authorizationRequest.getAttribute(OAuth2ParameterNames.REGISTRATION_ID);</span><br><span class="line">    // 从仓库中拿到 ClientRegistration 对象</span><br><span class="line">    // 这里两个值的区别可以看图一</span><br><span class="line">    // 说白了就是拿到我们在 application.yml配置的数据, 或者在OAuth2ClientRegistrationRepositoryConfiguration这列默认配置的ClientRegistrationRepository Bean对象, 而这个Bean对象默认也是读取的我们application.yml中配置的数据 @ConfigurationProperties(prefix = &quot;spring.security.oauth2.client&quot;)</span><br><span class="line">    // 那么拿到 application.yml 配置的目的是什么? 简单, 拿到 clientId 和 clientSecret等这些用于后续获取 token 的凭证</span><br><span class="line">   ClientRegistration clientRegistration = this.clientRegistrationRepository.findByRegistrationId(registrationId);</span><br><span class="line">   if (clientRegistration == null) &#123;</span><br><span class="line">      OAuth2Error oauth2Error = new OAuth2Error(CLIENT_REGISTRATION_NOT_FOUND_ERROR_CODE,</span><br><span class="line">            &quot;Client Registration not found with Id: &quot; + registrationId, null);</span><br><span class="line">      throw new OAuth2AuthenticationException(oauth2Error, oauth2Error.toString());</span><br><span class="line">   &#125;</span><br><span class="line">   // @formatter:off</span><br><span class="line">    // http://localhost:8080/login/oauth2/code/gitee?code=b2c3e1ad96f15e5637dfec4fea0083cd3dc030ce4121bdcadc018dd92010be4c&amp;state=96qngadtGyUrAUx_UONNl4iOL0uSRI5pnC0nY-Jd8b4%3D</span><br><span class="line">    // 从上面的字符串中获取 http://localhost:8080/login/oauth2/code/gitee 路径</span><br><span class="line">   String redirectUri = UriComponentsBuilder.fromHttpUrl(UrlUtils.buildFullRequestUrl(request))</span><br><span class="line">         .replaceQuery(null)</span><br><span class="line">         .build()</span><br><span class="line">         .toUriString();</span><br><span class="line">   // @formatter:on</span><br><span class="line">    // 在这里获得了认证的响应信息, 可以看 json一</span><br><span class="line">    // 这个对象有重定向地址: http://localhost:8080/login/oauth2/code/gitee</span><br><span class="line">    // state: 类似csrf, 防止跨站session攻击</span><br><span class="line">    // code: 我们需要的核心 code, 第一次请求 gitee 所获得的授权码</span><br><span class="line">   OAuth2AuthorizationResponse authorizationResponse = OAuth2AuthorizationResponseUtils.convert(params,</span><br><span class="line">         redirectUri);</span><br><span class="line">    // 这行代码最终获得 WebAuthenticationDetails</span><br><span class="line">    // 很熟悉的一个类, 在我们图片认证的时候, 学习过这个类</span><br><span class="line">    // 主要的目的是存放额外信息, 我们也可以将我们的 token 从 request 中拿出来存放到这里</span><br><span class="line">   Object authenticationDetails = this.authenticationDetailsSource.buildDetails(request);</span><br><span class="line">    // 看json2 </span><br><span class="line">    // 其他东西都懂, 需要关注一点: authenticated: false</span><br><span class="line">   OAuth2LoginAuthenticationToken authenticationRequest = new OAuth2LoginAuthenticationToken(clientRegistration,</span><br><span class="line">         new OAuth2AuthorizationExchange(authorizationRequest, authorizationResponse));</span><br><span class="line">    // 保存额外信息, 如果你有自定义该对象添加 token 属性的话, 需要继承两个类</span><br><span class="line">    // 一个是: WebAuthenticationDetailsSource</span><br><span class="line">    // 另一个是: WebAuthenticationDetails</span><br><span class="line">    // 第三步: http.oauth2Login().authenticationDetailsSource(你自定义的WebAuthenticationDetailsSource对象);</span><br><span class="line">   authenticationRequest.setDetails(authenticationDetails);</span><br><span class="line">    // 认证代码, 走的是 OAuth2LoginAuthenticationProvider 的 authenticate 函数</span><br><span class="line">    // 现在我们拿着 clientId clientSecret 和 code 去认证</span><br><span class="line">    // 详情看 下面 代码1</span><br><span class="line">   OAuth2LoginAuthenticationToken authenticationResult = (OAuth2LoginAuthenticationToken) this</span><br><span class="line">         .getAuthenticationManager().authenticate(authenticationRequest);</span><br><span class="line">   OAuth2AuthenticationToken oauth2Authentication = this.authenticationResultConverter</span><br><span class="line">         .convert(authenticationResult);</span><br><span class="line">   Assert.notNull(oauth2Authentication, &quot;authentication result cannot be null&quot;);</span><br><span class="line">   oauth2Authentication.setDetails(authenticationDetails);</span><br><span class="line">   OAuth2AuthorizedClient authorizedClient = new OAuth2AuthorizedClient(</span><br><span class="line">         authenticationResult.getClientRegistration(), oauth2Authentication.getName(),</span><br><span class="line">         authenticationResult.getAccessToken(), authenticationResult.getRefreshToken());</span><br><span class="line">   // 使用InMemoryOAuth2AuthorizedClientService保存 图二 的对象 </span><br><span class="line">   this.authorizedClientRepository.saveAuthorizedClient(authorizedClient, oauth2Authentication, request, response);</span><br><span class="line">   return oauth2Authentication;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>那么拿到的这个<code>oauth2Authentication</code>对象又在哪里保存呢?</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317191.png" alt="image-20221211002959386"></p>
<p><code>this.securityContextRepository.saveContext(context, request, response)</code>这行代码的接口是这个:</p>
<p><code>SecurityContextRepository</code>, 意味着我们可以实现该接口对<code>SecurityContext</code>进行增删改查</p>
<p>图一:</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317192.png" alt="image-20221210160244517"></p>
<p>图二:</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317193.png" alt="image-20221211002342262"></p>
<p>json1:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96qngadtGyUrAUx_UONNl4iOL0uSRI5pnC0nY-Jd8b4=&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b2xxxx&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>json2:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;clientRegistration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;registrationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientSecret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6176e926f9ce31d1008e8339b6d3fad1849bf3f8124c692355ec6e07efa25241&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientAuthenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;client_secret_basic&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationGrantType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authorization_code&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;providerDetails&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;tokenUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;userInfoEndpoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;authenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                         <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;userNameAttributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;configurationMetadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gitee&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorizationExchange&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;authorizationRequest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;responseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;code&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;user_info&quot;</span></span><br><span class="line">               <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96qngadtGyUrAUx_UONNl4iOL0uSRI5pnC0nY-Jd8b4=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;additionalParameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;authorizationRequestUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&amp;scope=user_info&amp;state=96qngadtGyUrAUx_UONNl4iOL0uSRI5pnC0nY-Jd8b4%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;registration_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationResponse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;96qngadtGyUrAUx_UONNl4iOL0uSRI5pnC0nY-Jd8b4=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b2c3e1ad96f15e5637dfec4fea0083cd3dc030ce4121bdcadc018dd92010be4c&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authenticated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>代码1:</p>
<p><code>OAuth2LoginAuthenticationProvider#authenticate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">    <span class="comment">// 看下面对象详解</span></span><br><span class="line">   <span class="type">OAuth2LoginAuthenticationToken</span> <span class="variable">loginAuthenticationToken</span> <span class="operator">=</span> (OAuth2LoginAuthenticationToken) authentication;</span><br><span class="line">   <span class="comment">// </span></span><br><span class="line">   <span class="keyword">if</span> (loginAuthenticationToken.getAuthorizationExchange().getAuthorizationRequest().getScopes()</span><br><span class="line">         .contains(<span class="string">&quot;openid&quot;</span>)) &#123;</span><br><span class="line">      <span class="comment">// This is an OpenID Connect Authentication Request so return null</span></span><br><span class="line">      <span class="comment">// and let OidcAuthorizationCodeAuthenticationProvider handle it instead</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   OAuth2AuthorizationCodeAuthenticationToken authorizationCodeAuthenticationToken;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// 这里进行OAuth2AuthorizationCodeAuthenticationProvider#authenticate</span></span><br><span class="line">       <span class="comment">// 认证器的认证过程, 详细代码看下面 代码2</span></span><br><span class="line">      authorizationCodeAuthenticationToken = (OAuth2AuthorizationCodeAuthenticationToken) <span class="built_in">this</span>.authorizationCodeAuthenticationProvider</span><br><span class="line">            .authenticate(<span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationCodeAuthenticationToken</span>(</span><br><span class="line">                  loginAuthenticationToken.getClientRegistration(),</span><br><span class="line">                  loginAuthenticationToken.getAuthorizationExchange()));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (OAuth2AuthorizationException ex) &#123;</span><br><span class="line">      <span class="type">OAuth2Error</span> <span class="variable">oauth2Error</span> <span class="operator">=</span> ex.getError();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OAuth2AuthenticationException</span>(oauth2Error, oauth2Error.toString(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">OAuth2AccessToken</span> <span class="variable">accessToken</span> <span class="operator">=</span> authorizationCodeAuthenticationToken.getAccessToken();</span><br><span class="line">    <span class="comment">// 拿到扩展参数</span></span><br><span class="line">   Map&lt;String, Object&gt; additionalParameters = authorizationCodeAuthenticationToken.getAdditionalParameters();</span><br><span class="line">    <span class="comment">// 获得用户详细信息, 通过https://gitee.com/api/v5/user方法获得, 这个方法的最终目的是</span></span><br><span class="line">    <span class="comment">// 创建 DefaultOAuth2User 对象, 该对象用于存放一些认证后的数据, 比如认证后的authority对象信息, 可以根据authority查找json格式</span></span><br><span class="line">   <span class="type">OAuth2User</span> <span class="variable">oauth2User</span> <span class="operator">=</span> <span class="built_in">this</span>.userService.loadUser(<span class="keyword">new</span> <span class="title class_">OAuth2UserRequest</span>(</span><br><span class="line">         loginAuthenticationToken.getClientRegistration(), accessToken, additionalParameters));</span><br><span class="line">   Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; mappedAuthorities = <span class="built_in">this</span>.authoritiesMapper</span><br><span class="line">         .mapAuthorities(oauth2User.getAuthorities());</span><br><span class="line">   <span class="type">OAuth2LoginAuthenticationToken</span> <span class="variable">authenticationResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2LoginAuthenticationToken</span>(</span><br><span class="line">         loginAuthenticationToken.getClientRegistration(), loginAuthenticationToken.getAuthorizationExchange(),</span><br><span class="line">         oauth2User, mappedAuthorities, accessToken, authorizationCodeAuthenticationToken.getRefreshToken());</span><br><span class="line">   authenticationResult.setDetails(loginAuthenticationToken.getDetails());</span><br><span class="line">    <span class="comment">// 最终返回了一个完整的结果 OAuth2LoginAuthenticationToken对象, 可以搜索OAuth2LoginAuthenticationToken查看json</span></span><br><span class="line">    <span class="comment">// 回到 OAuth2LoginAuthenticationFilter 类继续分析源码</span></span><br><span class="line">   <span class="keyword">return</span> authenticationResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>OAuth2LoginAuthenticationToken</code>对象详解 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> OAuth2User principal;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ClientRegistration clientRegistration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> OAuth2AuthorizationExchange authorizationExchange;</span><br><span class="line"><span class="comment">// 存放 token 的地方, 其中还包括 过期时间等</span></span><br><span class="line"><span class="keyword">private</span> OAuth2AccessToken accessToken;</span><br><span class="line"><span class="comment">// 存放 刷新 token 的 refreshToken, 主要在 token即将过期时刷新 token</span></span><br><span class="line"><span class="keyword">private</span> OAuth2RefreshToken refreshToken;</span><br></pre></td></tr></table></figure>



<p>代码2:</p>
<p><code>OAuth2AuthorizationCodeAuthenticationProvider#authenticate</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">   <span class="type">OAuth2AuthorizationCodeAuthenticationToken</span> <span class="variable">authorizationCodeAuthentication</span> <span class="operator">=</span> (OAuth2AuthorizationCodeAuthenticationToken) authentication;</span><br><span class="line">    <span class="comment">// 可以看 json3</span></span><br><span class="line">    <span class="comment">// redirectUri: 认证成功跳转地址</span></span><br><span class="line">    <span class="comment">// state: csrf</span></span><br><span class="line">    <span class="comment">// code: 授权码</span></span><br><span class="line">   <span class="type">OAuth2AuthorizationResponse</span> <span class="variable">authorizationResponse</span> <span class="operator">=</span> authorizationCodeAuthentication.getAuthorizationExchange()</span><br><span class="line">         .getAuthorizationResponse();</span><br><span class="line">   <span class="keyword">if</span> (authorizationResponse.statusError()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationException</span>(authorizationResponse.getError());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">OAuth2AuthorizationRequest</span> <span class="variable">authorizationRequest</span> <span class="operator">=</span> authorizationCodeAuthentication.getAuthorizationExchange()</span><br><span class="line">         .getAuthorizationRequest();</span><br><span class="line">    <span class="comment">// 两个 state 是否不相同?</span></span><br><span class="line">   <span class="keyword">if</span> (!authorizationResponse.getState().equals(authorizationRequest.getState())) &#123;</span><br><span class="line">       <span class="comment">// 意味着 state 不同, 所以认证失败</span></span><br><span class="line">      <span class="type">OAuth2Error</span> <span class="variable">oauth2Error</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2Error</span>(INVALID_STATE_PARAMETER_ERROR_CODE);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationException</span>(oauth2Error);</span><br><span class="line">   &#125;</span><br><span class="line">    <span class="comment">// 在这里能够拿到 access_token</span></span><br><span class="line">    <span class="comment">// 可以看下面该函数的代码, 就不给标签了, 直接搜索getTokenResponse方法就行了</span></span><br><span class="line">   <span class="type">OAuth2AccessTokenResponse</span> <span class="variable">accessTokenResponse</span> <span class="operator">=</span> <span class="built_in">this</span>.accessTokenResponseClient.getTokenResponse(</span><br><span class="line">         <span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationCodeGrantRequest</span>(authorizationCodeAuthentication.getClientRegistration(),</span><br><span class="line">               authorizationCodeAuthentication.getAuthorizationExchange()));</span><br><span class="line">    <span class="comment">// 最终创建了一个OAuth2AuthorizationCodeAuthenticationToken对象, 详细json在下面</span></span><br><span class="line">   <span class="type">OAuth2AuthorizationCodeAuthenticationToken</span> <span class="variable">authenticationResult</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationCodeAuthenticationToken</span>(</span><br><span class="line">         authorizationCodeAuthentication.getClientRegistration(),</span><br><span class="line">         authorizationCodeAuthentication.getAuthorizationExchange(), accessTokenResponse.getAccessToken(),</span><br><span class="line">         accessTokenResponse.getRefreshToken(), accessTokenResponse.getAdditionalParameters());</span><br><span class="line">   authenticationResult.setDetails(authorizationCodeAuthentication.getDetails());</span><br><span class="line">   <span class="keyword">return</span> authenticationResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>json3:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jbwPYnA2_5YSHgqzqR8vPYlnu4kAWKvyH0oJ0sEoj6k=&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;da6924d9f6258508嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻嘻&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> OAuth2AccessTokenResponse <span class="title function_">getTokenResponse</span><span class="params">(</span></span><br><span class="line"><span class="params">      OAuth2AuthorizationCodeGrantRequest authorizationCodeGrantRequest)</span> &#123;</span><br><span class="line">    <span class="comment">// 这个RequestEntity的json在下面</span></span><br><span class="line">   RequestEntity&lt;?&gt; request = <span class="built_in">this</span>.requestEntityConverter.convert(authorizationCodeGrantRequest);</span><br><span class="line">   ResponseEntity&lt;OAuth2AccessTokenResponse&gt; response = getResponse(request);</span><br><span class="line">   <span class="type">OAuth2AccessTokenResponse</span> <span class="variable">tokenResponse</span> <span class="operator">=</span> response.getBody();</span><br><span class="line">   <span class="keyword">if</span> (CollectionUtils.isEmpty(tokenResponse.getAccessToken().getScopes())) &#123;</span><br><span class="line">      tokenResponse = OAuth2AccessTokenResponse.withResponse(tokenResponse).scopes(authorizationCodeGrantRequest.getClientRegistration().getScopes())</span><br><span class="line">            .build();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> tokenResponse;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ResponseEntity&lt;OAuth2AccessTokenResponse&gt; <span class="title function_">getResponse</span><span class="params">(RequestEntity&lt;?&gt; request)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// RestTemplate 请求网址, 并返回 access_token </span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.restOperations.exchange(request, OAuth2AccessTokenResponse.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (RestClientException ex) &#123;</span><br><span class="line">        <span class="type">OAuth2Error</span> <span class="variable">oauth2Error</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OAuth2Error</span>(INVALID_TOKEN_RESPONSE_ERROR_CODE,</span><br><span class="line">                                                  <span class="string">&quot;An error occurred while attempting to retrieve the OAuth 2.0 Access Token Response: &quot;</span></span><br><span class="line">                                                  + ex.getMessage(),</span><br><span class="line">                                                  <span class="literal">null</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">OAuth2AuthorizationException</span>(oauth2Error, ex);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>RequestEntity</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;method&quot;</span><span class="punctuation">:</span> <span class="string">&quot;POST&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;class org.springframework.util.LinkedMultiValueMap&quot;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;headers&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;Accept&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;application/json;charset=UTF-8&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Content-Type&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;application/x-www-form-urlencoded;charset=UTF-8&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;Authorization&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;Basic Yjk5YzNiODE0MzE3NjRliNmQzZmFkMTg0OWJmM2Y4MTI0YzY5MjM1NWVjNmUwN2VmYTI1MjQx&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;body&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;grant_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;authorization_code&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;f1a5xxxxxxxxxxxxxxxxxxxxxxxxx6&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;redirect_uri&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span></span><br><span class="line">          <span class="punctuation">]</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317194.png" alt="RestTemplate的代码"></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317195.png" alt="image-20221210221943523"></p>
<p><code>response</code>读取出来的值在上面的<code>OAuth2AccessTokenResponseHttpMessageConverter</code>中读取出Map的类型</p>
<p>紧接着在<code>DefaultMapOAuth2AccessTokenResponseConverter</code>将<code>Map</code>转化成<code>OAuth2AccessTokenResponse</code></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317197.png" alt="image-20221210222513471"></p>
<p>中间那个循环是读取额外的数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : source.entrySet()) &#123;</span><br><span class="line">   <span class="keyword">if</span> (!TOKEN_RESPONSE_PARAMETER_NAMES.contains(entry.getKey())) &#123;</span><br><span class="line">      additionalParameters.put(entry.getKey(), entry.getValue());</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317198.png" alt="image-20221210222650340"></p>
<p>最终构建一个<code>OAuth2AccessTokenResponse</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> OAuth2AccessTokenResponse.withToken(accessToken)</span><br><span class="line">      .tokenType(accessTokenType)</span><br><span class="line">      .expiresIn(expiresIn)</span><br><span class="line">      .scopes(scopes)</span><br><span class="line">      .refreshToken(refreshToken)</span><br><span class="line">      .additionalParameters(additionalParameters)</span><br><span class="line">      .build();</span><br></pre></td></tr></table></figure>



<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5b3d2ce87024ca03e0e3202ce0f615f1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670684157755</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expiresAt&quot;</span><span class="punctuation">:</span> <span class="number">1670770557755</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf03cec7eb91228a12038274df8e0d9e1e199420bcff7af9cda4c09f762f9d42&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670684157755</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;additionalParameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="number">1670681932</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<p><code>OAuth2AuthorizationCodeAuthenticationToken</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;additionalParameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="number">1670681932</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;clientRegistration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;registrationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85cxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientSecret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6176e926f9ce31d1008e8339b6d3fad1849bf3f8124c692355ec6e07efxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientAuthenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;client_secret_basic&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationGrantType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authorization_code&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;providerDetails&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;tokenUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;userInfoEndpoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;authenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                         <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;userNameAttributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;configurationMetadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gitee&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorizationExchange&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;authorizationRequest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;responseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;code&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85xxxxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;user_info&quot;</span></span><br><span class="line">               <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FjPtf1-jguz9oYL7jB0Gl5l-m5aiGkdvCwkJBoe8Rcc=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;additionalParameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;authorizationRequestUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c78xxxxx&amp;scope=user_info&amp;state=FjPtf1-jguz9oYL7jB0Gl5l-m5aiGkdvCwkJBoe8Rcc%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;registration_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationResponse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;FjPtf1-jguz9oYL7jB0Gl5l-m5aiGkdvCwkJBoe8Rcc=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d68b35ed60e347c4e5ce369667fcb9b1a265376e37fe47c43af9d886e149xxxx&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5b3d2ce87024ca03e0e3202ce0f6xxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670684874250</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expiresAt&quot;</span><span class="punctuation">:</span> <span class="number">1670771274250</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bf03cec7eb91228a12038274df8e0d9e1e199420bcff7af9cda4c09f762fxxxx&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670684874250</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authenticated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>这里还需要注意这个接口<code>OAuth2AccessTokenResponseClient</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultAuthorizationCodeTokenResponseClient</span></span><br><span class="line">      <span class="keyword">implements</span> <span class="title class_">OAuth2AccessTokenResponseClient</span>&lt;OAuth2AuthorizationCodeGrantRequest&gt;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OAuth2AccessTokenResponseClient</span>&lt;T <span class="keyword">extends</span> <span class="title class_">AbstractOAuth2AuthorizationGrantRequest</span>&gt; &#123;</span><br><span class="line">	OAuth2AccessTokenResponse <span class="title function_">getTokenResponse</span><span class="params">(T authorizationGrantRequest)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将响应的结果丢给了<code>OAuth2AccessTokenResponse</code></p>
<p><code>authority</code>对象信息:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">     <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;authority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ROLE_USER&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1596464</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;login&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://foruda.gitee.com/avatar/1667523163cccccccc/1596464_bbbbbb.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;html_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;followers_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/followers&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;following_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/following_url&#123;/other_user&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;gists_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/gists&#123;/gist_id&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;starred_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/starred&#123;/owner&#125;&#123;/repo&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;subscriptions_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/subscriptions&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;organizations_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/orgs&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;repos_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/repos&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/events&#123;/privacy&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;received_events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/received_events&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;User&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;bio&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;public_repos&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;public_gists&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;followers&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;following&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;stared&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;watched&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2017-10-24T22:36:18+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-12-10T22:18:46+08:00&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br></pre></td></tr></table></figure>

<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202212111317199.png" alt="image-20221210235736418"></p>
<p><code>OAuth2LoginAuthenticationToken</code>:</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">     <span class="attr">&quot;principal&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;authorities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;authority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ROLE_USER&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                         <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1596464</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;login&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://foruda.gitee.com/avatar/1667523163808534539/1596464_bb_1667523163.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;html_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;followers_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/followers&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;following_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/following_url&#123;/other_user&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;gists_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/gists&#123;/gist_id&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;starred_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/starred&#123;/owner&#125;&#123;/repo&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;subscriptions_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/subscriptions&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;organizations_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/orgs&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;repos_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/repos&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/events&#123;/privacy&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;received_events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/received_events&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;User&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;bio&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;public_repos&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;public_gists&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;followers&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;following&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;stared&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;watched&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2017-10-24T22:36:18+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">                         <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-12-10T22:18:46+08:00&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1596464</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;login&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://foruda.gitee.com/avatar/1667523163808534539/1596464_bb_1667523163.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;html_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;followers_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/followers&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;following_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/following_url&#123;/other_user&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;gists_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/gists&#123;/gist_id&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;starred_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/starred&#123;/owner&#125;&#123;/repo&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;subscriptions_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/subscriptions&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;organizations_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/orgs&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;repos_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/repos&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/events&#123;/privacy&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;received_events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/received_events&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;User&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;bio&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;public_repos&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;public_gists&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;followers&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;following&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;stared&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;watched&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2017-10-24T22:36:18+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-12-10T22:18:46+08:00&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;clientRegistration&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;registrationId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientSecret&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6176e926f9ce31d1008e8339b6d3fad1849bf3f8124c692355ec6e07efa25241&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientAuthenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;client_secret_basic&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationGrantType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;authorization_code&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&#123;baseUrl&#125;/login/oauth2/code/&#123;registrationId&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;providerDetails&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;tokenUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/token&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;userInfoEndpoint&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;uri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/user&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;authenticationMethod&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                         <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;header&quot;</span></span><br><span class="line">                    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;userNameAttributeName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;configurationMetadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;clientName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Gitee&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorizationExchange&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;authorizationRequest&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authorizationUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;responseType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;code&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;clientId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                    <span class="string">&quot;user_info&quot;</span></span><br><span class="line">               <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JQ6LxN6nKuMm1N_koLhbNohRE2M4Ia_mp8w9fLB8XPY=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;additionalParameters&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;authorizationRequestUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/oauth/authorize?response_type=code&amp;client_id=b99c3b81431764f6402e8a7ef90d15da5ccb1c657189bf4341b03f85c781082a&amp;scope=user_info&amp;state=JQ6LxN6nKuMm1N_koLhbNohRE2M4Ia_mp8w9fLB8XPY%3D&amp;redirect_uri=http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;registration_id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;gitee&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;authorizationResponse&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;redirectUri&quot;</span><span class="punctuation">:</span> <span class="string">&quot;http://localhost:8080/login/oauth2/code/gitee&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="string">&quot;JQ6LxN6nKuMm1N_koLhbNohRE2M4Ia_mp8w9fLB8XPY=&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8476fbea204fe4c8ddad1998db3de95e7ef7292b1eea5e0130af1da5a987262d&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;accessToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenType&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Bearer&quot;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;scopes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">               <span class="string">&quot;user_info&quot;</span></span><br><span class="line">          <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;9fe30883b78e462783a1fb6dc43ae548&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670687488075</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;expiresAt&quot;</span><span class="punctuation">:</span> <span class="number">1670773888075</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;refreshToken&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;tokenValue&quot;</span><span class="punctuation">:</span> <span class="string">&quot;d8e80c6f006544b95ef8ead5833407ed65207a278e3b30dd02d9b5817742a5ce&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;issuedAt&quot;</span><span class="punctuation">:</span> <span class="number">1670687488075</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authorities&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">          <span class="punctuation">&#123;</span></span><br><span class="line">               <span class="attr">&quot;authority&quot;</span><span class="punctuation">:</span> <span class="string">&quot;ROLE_USER&quot;</span><span class="punctuation">,</span></span><br><span class="line">               <span class="attr">&quot;attributes&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1596464</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;login&quot;</span><span class="punctuation">:</span> <span class="string">&quot;bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;b&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;avatar_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://foruda.gitee.com/avatar/1667523163808534539/1596464_bb_1667523163.png&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;html_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/bb&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;followers_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/followers&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;following_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/following_url&#123;/other_user&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;gists_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/gists&#123;/gist_id&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;starred_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/starred&#123;/owner&#125;&#123;/repo&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;subscriptions_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/subscriptions&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;organizations_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/orgs&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;repos_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/repos&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/events&#123;/privacy&#125;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;received_events_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://gitee.com/api/v5/users/bb/received_events&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;User&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;bio&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;public_repos&quot;</span><span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;public_gists&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;followers&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;following&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;stared&quot;</span><span class="punctuation">:</span> <span class="number">22</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;watched&quot;</span><span class="punctuation">:</span> <span class="number">49</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2017-10-24T22:36:18+08:00&quot;</span><span class="punctuation">,</span></span><br><span class="line">                    <span class="attr">&quot;updated_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2022-12-10T22:18:46+08:00&quot;</span></span><br><span class="line">               <span class="punctuation">&#125;</span></span><br><span class="line">          <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="punctuation">&#123;</span><span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;details&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;remoteAddress&quot;</span><span class="punctuation">:</span> <span class="string">&quot;127.0.0.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;sessionId&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2C9A6826BD775356B0C3E5F6F49CD827&quot;</span></span><br><span class="line">     <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">     <span class="attr">&quot;authenticated&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<p>最后就是跳转到默认的首页, 完事, 基本分析完毕</p>
<p>看起来好像很复杂</p>
<blockquote>
<p>字数太多了, 下期再来改改 gitee 授权认证的代码, 现在的授权认证都是spring security默认配置的, 但实际上我们需要自定义, 在很多情况下</p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Bangiao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://bangiao.github.io/2022/12/06/02springcloud/27SpringSecurity-OAuth/">https://bangiao.github.io/2022/12/06/02springcloud/27SpringSecurity-OAuth/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/">过滤器</a><a class="post-meta__tags" href="/tags/%E8%A7%92%E8%89%B2/">角色</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a><a class="post-meta__tags" href="/tags/%E6%9D%83%E9%99%90/">权限</a><a class="post-meta__tags" href="/tags/%E7%94%A8%E6%88%B7/">用户</a><a class="post-meta__tags" href="/tags/%E8%B5%84%E6%BA%90/">资源</a><a class="post-meta__tags" href="/tags/OAuth/">OAuth</a><a class="post-meta__tags" href="/tags/OAuth2/">OAuth2</a><a class="post-meta__tags" href="/tags/OAuth%E8%AE%A4%E8%AF%81/">OAuth认证</a><a class="post-meta__tags" href="/tags/github%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81/">github授权认证</a><a class="post-meta__tags" href="/tags/gitee%E6%8E%88%E6%9D%83%E8%AE%A4%E8%AF%81/">gitee授权认证</a><a class="post-meta__tags" href="/tags/springsecurity/">springsecurity</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/12/06/02springcloud/28SpringSecurity-Oauth/"><i class="fa fa-chevron-left">  </i><span>28SpringSecurity-OAuth认证</span></a></div><div class="next-post pull-right"><a href="/2022/12/03/07kotlin/kotlin%E7%9A%84%E9%9B%86%E5%90%88%E6%93%8D%E4%BD%9C/"><span>kotlin的集合操作</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2022 By Bangiao</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">这是博客github仓库地址：<a target="_blank" rel="noopener" href="https://github.com/bangiao/bangiao.github.io">bangiao.github.io</a>，欢迎访问!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>