<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="012SpringCloud系列——SpringSecurity学习(七)"><meta name="keywords" content="过滤器,认证,授权,登录,角色,SpringSecurity,源码分析"><meta name="author" content="Bangiao"><meta name="copyright" content="Bangiao"><title>012SpringCloud系列——SpringSecurity学习(七) | Bangiao's Notebooks</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Security%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">Spring Security简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.</span> <span class="toc-text">是什么?</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">1.1.1.</span> <span class="toc-text">核心功能是什么?</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81"><span class="toc-number">1.1.2.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%88%E6%9D%83"><span class="toc-number">1.1.3.</span> <span class="toc-text">授权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.1.4.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B4%E4%BD%93%E6%9E%B6%E6%9E%84"><span class="toc-number">1.2.</span> <span class="toc-text">整体架构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="toc-number">1.2.1.</span> <span class="toc-text">认证和授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81-1"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%88%E6%9D%83-1"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">授权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#web"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">web</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E6%95%B0%E6%8D%AE%E4%BF%9D%E5%AD%98"><span class="toc-number">1.2.1.4.</span> <span class="toc-text">登录数据保存</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%A4%E8%AF%81-2"><span class="toc-number">2.</span> <span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8"><span class="toc-number">2.1.</span> <span class="toc-text">快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E6%B5%81%E7%A8%8B%E7%AE%80%E8%A6%81%E5%88%86%E6%9E%90"><span class="toc-number">2.1.1.</span> <span class="toc-text">源码流程简要分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%83%8C%E5%90%8E%E5%81%9A%E4%BA%86%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.2.</span> <span class="toc-text">背后做了什么?</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%94%A8%E6%88%B7%E8%B4%A6%E5%8F%B7%E5%AF%86%E7%A0%81%E7%9A%84%E7%94%9F%E6%88%90"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">默认用户账号密码的生成</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E9%A1%B5%E9%9D%A2%E7%94%9F%E6%88%90"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">默认页面生成</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95"><span class="toc-number">2.1.2.2.1.</span> <span class="toc-text">登录</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%87%BA"><span class="toc-number">2.1.2.2.2.</span> <span class="toc-text">登出</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%99%BB%E5%BD%95%E8%A1%A8%E5%8D%95"><span class="toc-number">2.2.</span> <span class="toc-text">自定义登录表单</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8-1"><span class="toc-number">2.2.1.</span> <span class="toc-text">快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%BB%86%E8%8A%82"><span class="toc-number">2.2.1.1.</span> <span class="toc-text">配置细节</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E9%99%86%E6%88%90%E5%8A%9F"><span class="toc-number">2.2.1.1.1.</span> <span class="toc-text">登陆成功</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#defaultSuccessUrl-%E5%92%8C-successForwardUrl%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.2.1.1.1.1.</span> <span class="toc-text">defaultSuccessUrl 和 successForwardUrl的区别</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-number">2.2.1.1.1.2.</span> <span class="toc-text">相关源码简单分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E5%A4%B1%E8%B4%A5"><span class="toc-number">2.2.1.1.2.</span> <span class="toc-text">登录失败</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="toc-number">2.2.1.1.2.1.</span> <span class="toc-text">源码简单分析</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B3%A8%E9%94%80%E7%99%BB%E5%BD%95"><span class="toc-number">2.2.1.1.3.</span> <span class="toc-text">注销登录</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BB%E5%BD%95%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E8%8E%B7%E5%8F%96"><span class="toc-number">2.3.</span> <span class="toc-text">登录用户数据获取</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9SecurityContextHolder%E5%AD%98%E5%82%A8%E7%9A%84%E4%BD%8D%E7%BD%AE"><span class="toc-number">2.3.1.</span> <span class="toc-text">修改SecurityContextHolder存储的位置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SecurityContextPersistenceFilter-%E5%B7%B2%E5%BC%83%E7%94%A8"><span class="toc-number">2.3.2.</span> <span class="toc-text">SecurityContextPersistenceFilter(已弃用)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8E%E5%BD%93%E5%89%8D%E8%AF%B7%E6%B1%82%E5%AF%B9%E8%B1%A1%E4%B8%AD%E8%8E%B7%E5%8F%96"><span class="toc-number">2.4.</span> <span class="toc-text">从当前请求对象中获取</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://imgsa.baidu.com/forum/pic/item/c8179682d158ccbf63dc944d1bd8bc3eb03541a9.jpg"></div><div class="author-info__name text-center">Bangiao</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/bangiao">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">20</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">81</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">我的博客</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://juejin.cn/user/4248168662314823">掘金</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30690165">CSDN</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/bangiao/">博客园</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gitee.com/bangiao_admin/projects">Gitee笔记源码</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Bangiao's Notebooks</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章列表</a><a class="site-page" href="/tags">文章标签</a><a class="site-page" href="/categories">文章分类</a><a class="site-page" href="/sources">笔记源码</a><a class="site-page" href="/about">关于</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">012SpringCloud系列——SpringSecurity学习(七)</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-11-15</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springcloud/">springcloud</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="Spring-Security简介"><a href="#Spring-Security简介" class="headerlink" title="Spring Security简介"></a>Spring Security简介</h1><h2 id="是什么"><a href="#是什么" class="headerlink" title="是什么?"></a>是什么?</h2><p>是一个安全管理框架</p>
<h3 id="核心功能是什么"><a href="#核心功能是什么" class="headerlink" title="核心功能是什么?"></a>核心功能是什么?</h3><ul>
<li><p>认证</p>
</li>
<li><p>授权</p>
</li>
</ul>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130347536.png" alt="image-20221113034753386"></p>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><p>spring security提供了: </p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130349711.png" alt="image-20221113034919624"></p>
<p>还可以依靠第三方依赖来自定义</p>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><p>无论采用了上面哪种认证方式，都不影响在Spring Security中使用授权功能。<code>SpringSecurity</code>支持<strong>基于URL的请求授权、支持方法访问授权、支持SpEL访问控制、支持域对象安全(ACL)，同时也支持动态权限配置、支持RBAC权限模型等</strong>，总之，我们常见的权限管理需求，Spring Security基本上都是支持的。</p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>SpringSecurity</code>还提供了HTTP防火墙功能, 拦截大量非法请求, 防止网络攻击.</p>
<h2 id="整体架构"><a href="#整体架构" class="headerlink" title="整体架构"></a>整体架构</h2><h3 id="认证和授权"><a href="#认证和授权" class="headerlink" title="认证和授权"></a>认证和授权</h3><h4 id="认证-1"><a href="#认证-1" class="headerlink" title="认证"></a>认证</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Authentication</span> <span class="keyword">extends</span> <span class="title class_">Principal</span>, Serializable &#123;</span><br><span class="line"></span><br><span class="line">   Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line">   <span class="comment">// 获取用户密码</span></span><br><span class="line">   Object <span class="title function_">getCredentials</span><span class="params">()</span>;</span><br><span class="line">   <span class="comment">// 获取用户携带的详细信息, 可能是当前请求之类等</span></span><br><span class="line">   Object <span class="title function_">getDetails</span><span class="params">()</span>;</span><br><span class="line">   <span class="comment">// 用来获取当前用户，例如是一个用户名或者一个用户对象。</span></span><br><span class="line">   Object <span class="title function_">getPrincipal</span><span class="params">()</span>;</span><br><span class="line">   <span class="comment">// 当前用户是否认证成功。</span></span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当用户使用用户名&#x2F;密码登录或使用 <code>Remember-me</code>登录时，都会对应一个不同的<code>Authentication</code>实例。</p>
<p>Spring Security中的认证工作主要由<code>AuthenticationManager</code>接口来负责，下面来看一下该接口的定义:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationManager</span> &#123;</span><br><span class="line">	Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>AuthenticationManager</code> 只有一个<code>authenticate</code>方法可以用来做认证，该方法有三个不同的返回值:</p>
<ul>
<li>返回<code>Authentication</code>，表示认证成功。</li>
<li>抛出<code>AuthenticationException</code>异常，表示用户输入了无效的凭证。</li>
<li>返回null，表示不能断定。</li>
</ul>
<p><code>AuthenticationManager</code>最主要的实现类是<code>ProviderManager</code>，<code>ProviderManager</code>管理了众多的<code>AuthenticationProvider</code>实例，<code>AuthenticationProvider</code>有点类似于<code>AuthenticationManager</code>，但是<code>AuthenticationProvider</code>多了一个 <code>supports</code>方法用来判断是否支持给定的<code>Authentication</code>类型。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130413003.png" alt="image-20221113041314895"></p>
<p>由于<code>Authentication</code>拥有众多不同的实现类，这些不同的实现类又由不同的<code>AuthenticationProvider</code> 来处理，所以<code>AuthenticationProvider</code> 会有一个<code>supports</code>方法，用来判断当前的<code>Authentication Provider</code>是否支持对应的<code>Authentication</code>。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130423552.png" alt="image-20221113042305473"></p>
<p>在一次完整的认证流程中，可能会同时存在多个<code>AuthenticationProvider</code>（例如，项目同时支持<code>form</code>表单登录和短信验证码登录)，多个<code>AuthenticationProvider</code>统一由<code>ProviderManager</code>来管理。同时，<code>ProviderManager</code>具有一个可选的<code>parent</code>，如果所有的 <code>AuthenticationProvider</code>都认证失败，那么就会调用<code>parent</code>进行认证。<code>parent</code>相当于一个备用认证方式，即各个<code>AuthenticationProvider</code>都无法处理认证问题的时候，就由<code>parent</code>出场收拾残局。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130440410.png" alt="spring-security认证流程图"></p>
<h4 id="授权-1"><a href="#授权-1" class="headerlink" title="授权"></a>授权</h4><p>当完成认证后，接下来就是授权了。在Spring Security的授权体系中，有两个关键接口:</p>
<ul>
<li><code>AccessDecisionManager</code></li>
<li><code>AccessDecisionVoter</code></li>
</ul>
<p><code>AccessDecisionVoter</code>是一个投票器，投票器会检查用户是否具备应有的角色，进而投出赞成、反对或者弃权票: <code>AccessDecisionManager</code>则是一个决策器，来决定此次访问是否被允许。<code>AccessDecisionVoter</code>和 <code>AccessDecisionManager</code>都有众多的实现类，在.<code>AccessDecisionManager</code>中会挨个遍历<code>AccessDecisionVoter</code>，进而决定是否允许用户访问，因而<code>AccessDecisionVoter</code>和<code>AccessDecisionManager</code> 两者的关系类似于<code>AuthenticationProvider</code> 和<code>ProvidenManager</code>的关系。</p>
<p>在Spring Security 中，用户请求一个资源（通常是一个网络接口或者一个Java方法）所需要的角色会被封装成一个<code>ConfigAttribute</code>对象，在<code>ConfigAttribute</code>中只有一个<code>getAttribute</code>方法,该方法返回一个String字符串,就是角色的名称。一般来说,角色名称都带有一个<code>ROLE_</code>前缀，投票器<code>AccessDecisionVoter</code> 所做的事情，其实就是比较用户所具备的角色和请求某个资源所需的 <code>ConfigAttribute</code>之间的关系。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130447408.png" alt="授权过程"></p>
<h4 id="web"><a href="#web" class="headerlink" title="web"></a>web</h4><p><code>SpringSecurity</code>的过滤器列表:</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130451077.png" alt="image-20221113045141957"></p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130452065.png" alt="image-20221113045206974"></p>
<p>开发者所见到的Spring Security提供的功能，都是通过这些过滤器来实现的，这些过滤器按照既定的优先级排列，最终形成一个过滤器链。开发者也可以自定义过滤器，并通过<code>@Order</code>注解去调整自定义过滤器在过滤器链中的位置。</p>
<p>需要注意的是，默认过滤器并不是直接放在 Web 项目的原生过滤器链中，而是通过一个<code>FilterChainProxy</code>来统一管理。Spring Security 中的过滤器链通过<code>FilterChainProxy</code>嵌入到Web项目的原生过滤器链中，如下图所示。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130455255.png" alt="image-20221113045512172"></p>
<p>在Spring Security 中，这样的过滤器链不仅仅只有一个，可能会有多个，如下图所示。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130456252.png" alt="image-20221113045607173"></p>
<p>当存在多个过滤器链时，多个过滤器链之间要指定优先级，当请求到达后，会从<code>FilterChainProxy</code>进行分发，先和哪个过滤器链匹配上，就用哪个过滤器链进行处理。当系统中存在多个不同的认证体系时，那么使用多个过滤器链就非常有效。</p>
<p><code>FilterChainProxy</code>作为一个顶层管理者，将统一管理Security Filter。<code>FilterChainProxy</code>本身将通过Spring框架提供的<code>DelegatingFilterProxy</code>整合到原生过滤器链中，所以上图所示的框架还可以做进一步的优化，如下图所示。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130459245.png" alt="image-20221113045944165"></p>
<h4 id="登录数据保存"><a href="#登录数据保存" class="headerlink" title="登录数据保存"></a>登录数据保存</h4><p>如果不使用 <code>Spring Security</code>这一类的安全管理框架，大部分的开发者可能会将登录用户数据保存在<code>Session</code>中, </p>
<p>事实上,Spring Security也是这么做的.</p>
<p>但是,为了使用方便, Spring Security在此基础上还做了一些改进，其中最主要的一个变化就是<strong>线程绑定</strong>。</p>
<p>当用户登录成功后,Spring Security会<strong>将登录成功的用户信息保存到<code>SecurityContextHolder</code>中</strong>。<code>SecurityContextHolder</code> 中的<strong>数据保存默认是通过<code>ThreadLocal</code><strong>来实现的，使用<code>ThreadLocal</code>创建的变量只能被当前线程访问，不能被其他线程访问和修改，</strong>也就是用户数据和请求线程绑定在一起</strong>。</p>
<p>当登录请求处理完毕后，Spring Security 会将<code>SecurityContextHolder</code>中的数据拿出来保存到<code>Session</code>中，同时将<code>SecurityContextHolder</code> 中的数据清空。</p>
<p>以后每当有请求到来时，Spring Security就会先从<code>Session</code>中取出用户登录数据，保存到<code>SecurityContextHolder</code>中，方便在该请求的后续处理过程中使用</p>
<p>同时在请求结束时将<code>SecurityContextHolder</code> 中的数据拿出来保存到<code>Session</code>中，然后将<code>SecurityContextHolder</code>中的数据清空。</p>
<p>这一策略非常方便用户在 <code>Controller</code> 或者<code>Service</code>层获取当前登录用户数据</p>
<p>但是带来的另外一个问题就是，在子线程中想要获取用户登录数据就比较麻烦。</p>
<p>Spring Security对此也提供了相应的解决方案，如果开发者使用<code>@Async</code>注解来开启异步任务的话，那么只需要添加如下配置，使用Spring Security提供的异步任务代理，就可以在异步任务中从 <code>SecurityContextHolder</code>里边获取当前登录用户的信息:</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211130509741.png" alt="image-20221113050955659"></p>
<h1 id="认证-2"><a href="#认证-2" class="headerlink" title="认证"></a>认证</h1><h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2><ol>
<li>添加依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>创建controller</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">	</span><br><span class="line">    <span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">    	<span class="keyword">return</span> <span class="string">&quot;hello spring security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>接下来访问 &#x2F;hello 等 任意 url 都会跳转到 &#x2F;login , 对包括 &#x2F;login, 他会重定向一次, 可以考虑将 login 也给加入到白名单</p>
<p>而由于密码没有配置, 默认 是 user 密码默认为 UUID , 输出在启动控制台中, 需要你去查找</p>
<h3 id="源码流程简要分析"><a href="#源码流程简要分析" class="headerlink" title="源码流程简要分析"></a>源码流程简要分析</h3><p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113085111296.png" alt="image-20221113085111296"></p>
<p>客户端向服务端发送了两次请求, 第一次访问 &#x2F;hello , 被 spring security 的过滤器 FilterSecurityIntercepotor 拦截, 抛出异常给 ExceptionTranslationFilter 重定向客户端url为 &#x2F;login(get请求)</p>
<p>客户端写入账号和密码之后, 发出 &#x2F;login(post请求) 进行账号密码认证</p>
<blockquote>
<p>这里不要搞乱了:</p>
<ul>
<li><p>get形式的 &#x2F;login 地址是登录页面</p>
</li>
<li><p>post形式的 &#x2F;login 地址为登陆页面的form表单请求地址, 是真正的认证账户密码地址</p>
</li>
</ul>
</blockquote>
<h3 id="背后做了什么"><a href="#背后做了什么" class="headerlink" title="背后做了什么?"></a>背后做了什么?</h3><p>虽然上面做了最简单的配置, 但是 SpringSecurity 在背后做了很多的事情</p>
<ul>
<li>开启 SpringSecurity 自动配置, 然后创建一个 <code>springSecurityFilterChain</code> 的过滤器, 并注入Spring容器中, 这个过滤器负责几乎所有的安全管理, 包括 认证, 授权等(<code>springSecurityFilterChain</code>代理了SpringSecurity的过滤器链)</li>
<li>创建一个UserDetailsService实例，UserDetailsService负责提供用户数据，默认的用户数据是基于内存的用户，用户名为user，密码则是随机生成的UUID字符串。</li>
<li>给用户生成一个默认的登录页面。</li>
<li>开启CSRF攻击防御。</li>
<li>开启会话固定攻击防御。集成X-XSS-Protection。</li>
<li>集成X-Frame-Options 以防止单击劫持。</li>
</ul>
<h4 id="默认用户账号密码的生成"><a href="#默认用户账号密码的生成" class="headerlink" title="默认用户账号密码的生成"></a>默认用户账号密码的生成</h4><p>Spring Security中定义了<code>UserDetails</code> 接口来<strong>规范开发者自定义的用户对象</strong>，<strong>这样方便一些旧系统、用户表已经固定的系统集成到Spring Security 认证体系中。</strong><br>UserDetails接口定义如下:</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113093539557.png" alt="image-20221113093539557"></p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113093558047.png" alt="image-20221113093558047"></p>
<p>这是用户对象的定义，而负责提供用户数据源的接口是<code>UserDetailsService</code> ,<code>UserDetailsService</code>中只有一个查询用户的方法，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">	UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><code>loadUserByUsername</code>有一个参数是<code>username</code>，这是用户在认证时传入的用户名，最常见的就是用户在登录表单中输入的用户名（实际开发时还可能存在其他情况，例如使用<code>CAS单点登录</code>时, <code>username</code>并非表单输入的用户名,而是<code>CAS Server</code>认证成功后回调的用户名参数)，开发者在这里拿到用户名之后，再去数据库中查询用户，最终返回一个<code>UserDetails</code>实例。<br>在实际项目中，一般需要开发者自定义<code>UserDetailsService</code> 的实现。如果开发者没有自定义<code>UserDetailsService</code> 的实现，<code>Spring Security</code>也为 <code>UserDetailsService</code> 提供了很多默认实现</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113094645604.png" alt="image-20221113094645604"></p>
<ul>
<li><code>UserDetailsManager</code> 在 <code>UserDetailsService</code> 的基础上，继续定义了添加用户、更新用户、删除用户、修改密码以及判断用户是否存在共5种方法。</li>
<li><code>JdbcDaolmpl</code>在 <code>UserDetailsService</code> 的基础上，通过<code>spring-jdbc</code>实现了从数据库中查询用户的方法。</li>
<li><code>InMemoryUserDetailsManager</code>实现了<code>UserDetailsManager</code>中关于用户的增删改查方法,不过都是基于内存的操作，数据并没有持久化。</li>
<li><code>JdbcUserDetailsManager</code>继承自<code>JdbcDaolmpl</code>同时又实现了<code>UserDetailsManager</code>接口，因此可以通过<code>JdbcUserDetailsManager</code>实现对用户的增删改查操作，这些操作都会持久化到数据库中。不过<code>JdbcUserDetailsManager</code>有一个局限性,就是操作数据库中用户的SQL都是提前写好的，不够灵活，因此在实际开发中<code>JdbcUserDetailsManager</code>使用并不多。</li>
<li><code>CachingUserDetailsService</code> 的特点是会将<code>UserDetailsService</code>缓存起来。</li>
<li><code>UserDetailsServiceDelegator</code> 则是提供了<code>UserDetailsService</code> 的懒加载功能。</li>
<li><code>ReactiveUserDetailsServiceAdapter</code>是<code>webflux-web-security</code>模块定义的<code>UserDetailsService</code>实现。</li>
</ul>
<p>在上面快速入门的情况下, SpringSecurity 默认使用的是 <code>InMemoryUserDetailsManager</code>, 将账号密码保存在内存中, 在这里可以看到</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfiguration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(AuthenticationManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ObjectPostProcessor.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(</span></span><br><span class="line"><span class="meta">		value = &#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,</span></span><br><span class="line"><span class="meta">				AuthenticationManagerResolver.class &#125;,</span></span><br><span class="line"><span class="meta">		type = &#123; &quot;org.springframework.security.oauth2.jwt.JwtDecoder&quot;,</span></span><br><span class="line"><span class="meta">				&quot;org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector&quot;,</span></span><br><span class="line"><span class="meta">				&quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot;,</span></span><br><span class="line"><span class="meta">				&quot;org.springframework.security.saml2.provider.service.registration.RelyingPartyRegistrationRepository&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">NOOP_PASSWORD_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;&#123;noop&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Pattern</span> <span class="variable">PASSWORD_ALGORITHM_PATTERN</span> <span class="operator">=</span> Pattern.compile(<span class="string">&quot;^\\&#123;.+&#125;.*$&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(UserDetailsServiceAutoConfiguration.class);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="meta">@Lazy</span></span><br><span class="line">	<span class="keyword">public</span> InMemoryUserDetailsManager <span class="title function_">inMemoryUserDetailsManager</span><span class="params">(SecurityProperties properties,</span></span><br><span class="line"><span class="params">			ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder)</span> &#123;</span><br><span class="line">        <span class="comment">// private String name = &quot;user&quot;;</span></span><br><span class="line">        <span class="comment">// private String password = UUID.randomUUID().toString();</span></span><br><span class="line">		SecurityProperties.<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> properties.getUser();</span><br><span class="line">        <span class="comment">// 获得角色列表</span></span><br><span class="line">		List&lt;String&gt; roles = user.getRoles();</span><br><span class="line">        <span class="comment">// 创建内存中保存的 用户名和密码</span></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(</span><br><span class="line">				User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))</span><br><span class="line">						.roles(StringUtils.toStringArray(roles)).build());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在密码前面加上 &#123;noop&#125;</span></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">getOrDeducePassword</span><span class="params">(SecurityProperties.User user, PasswordEncoder encoder)</span> &#123;</span><br><span class="line">		<span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> user.getPassword();</span><br><span class="line">        <span class="comment">// 看看有没有在密码前面添加了密码类型字符串前缀 &#123;xxxx&#125;</span></span><br><span class="line">		<span class="keyword">if</span> (encoder != <span class="literal">null</span> || PASSWORD_ALGORITHM_PATTERN.matcher(password).matches()) &#123;</span><br><span class="line">			<span class="keyword">return</span> password;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 为密码添加 &#123;noop&#125; 密文前缀</span></span><br><span class="line">		<span class="keyword">return</span> NOOP_PASSWORD_PREFIX + password;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113095506501.png" alt="image-20221113095506501"></p>
<p>可以看出这些条件下才会启动该自动配置类, 配置用户名和密码</p>
<ul>
<li><p>需要在<code>classpath</code>中有<code>AuthenticationManager.class</code>, 还需要<code>org.springframework.security.config.annotation.ObjectPostProcessor</code>在SpringBean容器中</p>
</li>
<li><p>在Spring容器中没有配置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class, AuthenticationManagerResolver.class</span><br></pre></td></tr></table></figure>

<p>和一些其他类的情况下, 则加载<code>UserDetailsServiceAutoConfiguration</code></p>
</li>
</ul>
<p>看上面的源码可以发现</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113102414123.png" alt="image-20221113102414123"></p>
<p>password就是UUID, 用户名为 user</p>
<p>在这里可以发现</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113102532200.png" alt="image-20221113102532200"></p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113102617171.png" alt="image-20221113102617171"></p>
<p>在 <code>application.yml</code> 中可以配置 用户名和密码</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113102909110.png" alt="image-20221113102909110"></p>
<h4 id="默认页面生成"><a href="#默认页面生成" class="headerlink" title="默认页面生成"></a>默认页面生成</h4><h5 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h5><p>在上面的案例中，一共存在两个默认页面，一个就是<code>/login</code>的登录页面，另外一个则是注销登录页面。当用户登录成功之后，在浏览器中输入<code>http://localhost:8080/logout</code>就可以看到注销登录页面，如图所示。</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113103209198.png" alt="image-20221113103209198"></p>
<p>现在的目的就是找找, 这两个网页在哪生成的</p>
<p>在前面的过滤器链可以发现这两个过滤器</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113103500301.png" alt="image-20221113103500301"></p>
<p>通过过滤器的名字就可以分辨出<code>DefaultLoginPageGeneratingFilter</code>过滤器用来生成默认的登录页面，<code>DefaultLogoutPageGeneratingFilter</code>过滤器则用来生成默认的注销页面。</p>
<p>先来看<code>DefaultLoginPageGeneratingFilter</code>。作为<code>Spring Security</code>过滤器链中的一员，在第一次请求<code>hello</code>接口的时候，就会经过<code>DefaultLoginPageGeneratingFilter</code>过滤器，但是由于<code>/hello</code>接口和登录无关，因此 <code>DefaultLoginPageGeneratingFilter</code>过滤器并未干涉<code>hello</code>接口。等到第二次重定向到<code>/login</code>页面的时候，这个时候就和 <code>DefaultLoginPageGeneratingFilter</code>有关系了，此时请求就会在<code>DefaultLoginPageGeneratingFilter</code> 中进行处理，生成登录页面返回给客户端。</p>
<p>我们来看一下<code>DefaultLoginPageGeneratingFilter</code> 的源码，源码比较长，这里仅列出核心部分:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">// 过滤器将会被 chain 自动调用</span></span><br><span class="line">    doFilter((HttpServletRequest) request, (HttpServletResponse) response, chain);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">    <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">loginError</span> <span class="operator">=</span> isErrorPage(request);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">logoutSuccess</span> <span class="operator">=</span> isLogoutSuccess(request);</span><br><span class="line">    <span class="keyword">if</span> (isLoginUrlRequest(request) || loginError || logoutSuccess) &#123;</span><br><span class="line">        <span class="comment">// 核心代码, 这里生成了SpringSecurity的默认 /login 网页</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">loginPageHtml</span> <span class="operator">=</span> generateLoginPageHtml(request, loginError, logoutSuccess);</span><br><span class="line">        response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">        response.setContentLength(loginPageHtml.getBytes(StandardCharsets.UTF_8).length);</span><br><span class="line">        <span class="comment">// 将网页源码写入</span></span><br><span class="line">        response.getWriter().write(loginPageHtml);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 下一个 Filter</span></span><br><span class="line">    chain.doFilter(request, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113110544532.png" alt="image-20221113110544532"></p>
<blockquote>
<p> 对了 _csrf 在这里被设置了</p>
</blockquote>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113111029887.png" alt="image-20221113111029887"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">renderHiddenInputs</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; input : <span class="built_in">this</span>.resolveHiddenInputs.apply(request).entrySet()) &#123;</span><br><span class="line">        sb.append(<span class="string">&quot;&lt;input name=\&quot;&quot;</span>);</span><br><span class="line">        sb.append(input.getKey());</span><br><span class="line">        sb.append(<span class="string">&quot;\&quot; type=\&quot;hidden\&quot; value=\&quot;&quot;</span>);</span><br><span class="line">        sb.append(input.getValue());</span><br><span class="line">        sb.append(<span class="string">&quot;\&quot; /&gt;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这里需要分析这段代码, 才能发现 csrf 被设置了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultLoginPageConfigurer</span>&lt;H <span class="keyword">extends</span> <span class="title class_">HttpSecurityBuilder</span>&lt;H&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractHttpConfigurer</span>&lt;DefaultLoginPageConfigurer&lt;H&gt;, H&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里将 csrf 的值设置, 或者说提供了一个Function接口, 提供了 csrf</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">DefaultLoginPageGeneratingFilter</span> <span class="variable">loginPageGeneratingFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultLoginPageGeneratingFilter</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(H http)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.loginPageGeneratingFilter.setResolveHiddenInputs(DefaultLoginPageConfigurer.<span class="built_in">this</span>::hiddenInputs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; <span class="title function_">hiddenInputs</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="comment">// 这里就是获取 csrf 的 value</span></span><br><span class="line">		<span class="type">CsrfToken</span> <span class="variable">token</span> <span class="operator">=</span> (CsrfToken) request.getAttribute(CsrfToken.class.getName());</span><br><span class="line">		<span class="keyword">return</span> (token != <span class="literal">null</span>) ? Collections.singletonMap(token.getParameterName(), token.getToken())</span><br><span class="line">				: Collections.emptyMap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(H http)</span> &#123;</span><br><span class="line">		<span class="type">AuthenticationEntryPoint</span> <span class="variable">authenticationEntryPoint</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		ExceptionHandlingConfigurer&lt;?&gt; exceptionConf = http.getConfigurer(ExceptionHandlingConfigurer.class);</span><br><span class="line">		<span class="keyword">if</span> (exceptionConf != <span class="literal">null</span>) &#123;</span><br><span class="line">			authenticationEntryPoint = exceptionConf.getAuthenticationEntryPoint();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.loginPageGeneratingFilter.isEnabled() &amp;&amp; authenticationEntryPoint == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.loginPageGeneratingFilter = postProcess(<span class="built_in">this</span>.loginPageGeneratingFilter);</span><br><span class="line">			http.addFilter(<span class="built_in">this</span>.loginPageGeneratingFilter);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>这个类省略了很多代码</p>
</blockquote>
<p>在上面设置好的 Function 函数之后, 然后在</p>
<p><code>DefaultLoginPageGeneratingFilter#renderHiddenInputs</code>这个函数中使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">renderHiddenInputs</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">   <span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">   <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; input : <span class="built_in">this</span>.resolveHiddenInputs.apply(request).entrySet()) &#123;</span><br><span class="line">      sb.append(<span class="string">&quot;&lt;input name=\&quot;&quot;</span>);</span><br><span class="line">      sb.append(input.getKey());</span><br><span class="line">      sb.append(<span class="string">&quot;\&quot; type=\&quot;hidden\&quot; value=\&quot;&quot;</span>);</span><br><span class="line">      sb.append(input.getValue());</span><br><span class="line">      sb.append(<span class="string">&quot;\&quot; /&gt;\n&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最后促成了前端页面的</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113111827392.png" alt="image-20221113111827392"></p>
<p>另外这里配置了登录地址和登出地址</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/image-20221113110822317.png" alt="image-20221113110822317"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(UsernamePasswordAuthenticationFilter authFilter,</span></span><br><span class="line"><span class="params">      AbstractAuthenticationProcessingFilter openIDFilter)</span> &#123;</span><br><span class="line">   <span class="comment">// 这里初始化了 /login 地址</span></span><br><span class="line">   <span class="built_in">this</span>.loginPageUrl = DEFAULT_LOGIN_PAGE_URL;</span><br><span class="line">    <span class="comment">// 这里设置了 登出 的地址</span></span><br><span class="line">   <span class="built_in">this</span>.logoutSuccessUrl = DEFAULT_LOGIN_PAGE_URL + <span class="string">&quot;?logout&quot;</span>;</span><br><span class="line">   <span class="comment">// 这里设置了登录错误的地址</span></span><br><span class="line">   <span class="built_in">this</span>.failureUrl = DEFAULT_LOGIN_PAGE_URL + <span class="string">&quot;?&quot;</span> + ERROR_PARAMETER_NAME;</span><br><span class="line">   <span class="keyword">if</span> (authFilter != <span class="literal">null</span>) &#123;</span><br><span class="line">      initAuthFilter(authFilter);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (openIDFilter != <span class="literal">null</span>) &#123;</span><br><span class="line">      initOpenIdFilter(openIDFilter);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="登出"><a href="#登出" class="headerlink" title="登出"></a>登出</h5><p>如果你仔细看<code>DefaultLoginPageConfigurer</code>类的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">DefaultLoginPageConfigurer</span>&lt;H <span class="keyword">extends</span> <span class="title class_">HttpSecurityBuilder</span>&lt;H&gt;&gt;</span><br><span class="line">		<span class="keyword">extends</span> <span class="title class_">AbstractHttpConfigurer</span>&lt;DefaultLoginPageConfigurer&lt;H&gt;, H&gt; &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">DefaultLoginPageGeneratingFilter</span> <span class="variable">loginPageGeneratingFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultLoginPageGeneratingFilter</span>();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">DefaultLogoutPageGeneratingFilter</span> <span class="variable">logoutPageGeneratingFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultLogoutPageGeneratingFilter</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(H http)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.loginPageGeneratingFilter.setResolveHiddenInputs(DefaultLoginPageConfigurer.<span class="built_in">this</span>::hiddenInputs);</span><br><span class="line">		<span class="built_in">this</span>.logoutPageGeneratingFilter.setResolveHiddenInputs(DefaultLoginPageConfigurer.<span class="built_in">this</span>::hiddenInputs);</span><br><span class="line">		http.setSharedObject(DefaultLoginPageGeneratingFilter.class, <span class="built_in">this</span>.loginPageGeneratingFilter);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Map&lt;String, String&gt; <span class="title function_">hiddenInputs</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">		<span class="type">CsrfToken</span> <span class="variable">token</span> <span class="operator">=</span> (CsrfToken) request.getAttribute(CsrfToken.class.getName());</span><br><span class="line">		<span class="keyword">return</span> (token != <span class="literal">null</span>) ? Collections.singletonMap(token.getParameterName(), token.getToken())</span><br><span class="line">				: Collections.emptyMap();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(H http)</span> &#123;</span><br><span class="line">		<span class="type">AuthenticationEntryPoint</span> <span class="variable">authenticationEntryPoint</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">		ExceptionHandlingConfigurer&lt;?&gt; exceptionConf = http.getConfigurer(ExceptionHandlingConfigurer.class);</span><br><span class="line">		<span class="keyword">if</span> (exceptionConf != <span class="literal">null</span>) &#123;</span><br><span class="line">			authenticationEntryPoint = exceptionConf.getAuthenticationEntryPoint();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.loginPageGeneratingFilter.isEnabled() &amp;&amp; authenticationEntryPoint == <span class="literal">null</span>) &#123;</span><br><span class="line">			<span class="built_in">this</span>.loginPageGeneratingFilter = postProcess(<span class="built_in">this</span>.loginPageGeneratingFilter);</span><br><span class="line">			http.addFilter(<span class="built_in">this</span>.loginPageGeneratingFilter);</span><br><span class="line">			LogoutConfigurer&lt;H&gt; logoutConfigurer = http.getConfigurer(LogoutConfigurer.class);</span><br><span class="line">			<span class="keyword">if</span> (logoutConfigurer != <span class="literal">null</span>) &#123;</span><br><span class="line">				http.addFilter(<span class="built_in">this</span>.logoutPageGeneratingFilter);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>将会看到 登出 过滤器源码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultLogoutPageGeneratingFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">RequestMatcher</span> <span class="variable">matcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, <span class="string">&quot;GET&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> Function&lt;HttpServletRequest, Map&lt;String, String&gt;&gt; resolveHiddenInputs = (request) -&gt; Collections.emptyMap();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.matcher.matches(request)) &#123;</span><br><span class="line">			renderLogout(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			filterChain.doFilter(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">renderLogout</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">		sb.append(<span class="string">&quot;&lt;!DOCTYPE html&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;&lt;html lang=\&quot;en\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;  &lt;head&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;meta charset=\&quot;utf-8\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1, shrink-to-fit=no\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;meta name=\&quot;description\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;meta name=\&quot;author\&quot; content=\&quot;\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;title&gt;Confirm Log Out?&lt;/title&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;link href=\&quot;https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css\&quot; &quot;</span></span><br><span class="line">				+ <span class="string">&quot;rel=\&quot;stylesheet\&quot; integrity=\&quot;sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M\&quot; &quot;</span></span><br><span class="line">				+ <span class="string">&quot;crossorigin=\&quot;anonymous\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;link href=\&quot;https://getbootstrap.com/docs/4.0/examples/signin/signin.css\&quot; &quot;</span></span><br><span class="line">				+ <span class="string">&quot;rel=\&quot;stylesheet\&quot; crossorigin=\&quot;anonymous\&quot;/&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;  &lt;/head&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;  &lt;body&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;     &lt;div class=\&quot;container\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;      &lt;form class=\&quot;form-signin\&quot; method=\&quot;post\&quot; action=\&quot;&quot;</span> + request.getContextPath()</span><br><span class="line">				+ <span class="string">&quot;/logout\&quot;&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;        &lt;h2 class=\&quot;form-signin-heading\&quot;&gt;Are you sure you want to log out?&lt;/h2&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(renderHiddenInputs(request)</span><br><span class="line">				+ <span class="string">&quot;        &lt;button class=\&quot;btn btn-lg btn-primary btn-block\&quot; type=\&quot;submit\&quot;&gt;Log Out&lt;/button&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;      &lt;/form&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;    &lt;/div&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;  &lt;/body&gt;\n&quot;</span>);</span><br><span class="line">		sb.append(<span class="string">&quot;&lt;/html&gt;&quot;</span>);</span><br><span class="line">		response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">		response.getWriter().write(sb.toString());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setResolveHiddenInputs</span><span class="params">(Function&lt;HttpServletRequest, Map&lt;String, String&gt;&gt; resolveHiddenInputs)</span> &#123;</span><br><span class="line">		Assert.notNull(resolveHiddenInputs, <span class="string">&quot;resolveHiddenInputs cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.resolveHiddenInputs = resolveHiddenInputs;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String <span class="title function_">renderHiddenInputs</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">		<span class="type">StringBuilder</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">		<span class="keyword">for</span> (Map.Entry&lt;String, String&gt; input : <span class="built_in">this</span>.resolveHiddenInputs.apply(request).entrySet()) &#123;</span><br><span class="line">			sb.append(<span class="string">&quot;&lt;input name=\&quot;&quot;</span>);</span><br><span class="line">			sb.append(input.getKey());</span><br><span class="line">			sb.append(<span class="string">&quot;\&quot; type=\&quot;hidden\&quot; value=\&quot;&quot;</span>);</span><br><span class="line">			sb.append(input.getValue());</span><br><span class="line">			sb.append(<span class="string">&quot;\&quot; /&gt;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> sb.toString();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>从上述源码中可以看出，请求到来之后，会先判断是否是注销请求<code>/logout</code>，如果是<code>/logout</code>请求，则渲染一个注销请求的页面返回给客户端，渲染过程和前面登录页面的渲染过程类似,也是字符串拼接（这里省略了字符串拼接，读者可以参考<code>DefaultLogoutPageGeneratingFilter</code>的源码)﹔否则请求继续往下走，执行下一个过滤器。</p>
<h2 id="自定义登录表单"><a href="#自定义登录表单" class="headerlink" title="自定义登录表单"></a>自定义登录表单</h2><h3 id="快速入门-1"><a href="#快速入门-1" class="headerlink" title="快速入门"></a>快速入门</h3><p>在<code>resources/templates</code>创建<code>login.html</code>页面, 自定义我们自己的网页</p>
<blockquote>
<p>由于我们在 <code>templates</code> 创建<code>html</code>, 所以需要在<code>controller</code>下创建 <code>mapping</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">	<span class="meta">@GetMapping(&quot;/login&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;zh-CN&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>form-login<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/font-awesome-4.7.0/css/font-awesome.min.css&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">href</span>=<span class="string">&quot;css/style.css&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;materialContainer&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;box&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>form-登录<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;name&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--	            &lt;input type=&quot;text&quot; name=&quot;username&quot; id=&quot;name&quot;&gt;--&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">id</span>=<span class="string">&quot;name&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;pass&quot;</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--	            &lt;input type=&quot;password&quot; name=&quot;password&quot; id=&quot;pass&quot;&gt;--&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;pwd&quot;</span> <span class="attr">id</span>=<span class="string">&quot;pass&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;button login&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span>&gt;</span>登录<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">&quot;fa fa-check&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	        <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;session.SPRING_SECURITY_LAST_EXCEPTION&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;javascript:&quot;</span> <span class="attr">class</span>=<span class="string">&quot;pass-forgot&quot;</span>&gt;</span>忘记密码？<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;overbox&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;material-button alt-2&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;shape&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;title&quot;</span>&gt;</span>form-注册<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;regname&quot;</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;regname&quot;</span> <span class="attr">id</span>=<span class="string">&quot;regname&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;regpass&quot;</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;regpass&quot;</span> <span class="attr">id</span>=<span class="string">&quot;regpass&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;input&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">&quot;reregpass&quot;</span>&gt;</span>确认密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;reregpass&quot;</span> <span class="attr">id</span>=<span class="string">&quot;reregpass&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;spin&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;button&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">span</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;js/index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>



<blockquote>
<p>值得注意的是, 我们将表单登录的<code>action</code>地址修改为 <code>doLogin</code>, 将原先的 <code>username</code>和<code>password</code>修改为<code>name</code>和<code>pwd</code></p>
</blockquote>
<p>我们对 <code>login.html</code> 的修改, 需要告知 spring security </p>
<p>配置SpringSecurity配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> httpSecurity.authorizeHttpRequests()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">        .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">        .defaultSuccessUrl(<span class="string">&quot;/index&quot;</span>)</span><br><span class="line">        .failureUrl(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">        .usernameParameter(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        .passwordParameter(<span class="string">&quot;pwd&quot;</span>)</span><br><span class="line">        .permitAll()</span><br><span class="line">        .and()</span><br><span class="line">        .csrf()</span><br><span class="line">        .disable()</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>authorizeRequests()</code>方法表示开启权限配置（该方法的含义其实比较复杂，我们在后面还会再次介绍该方法)，<code>.anyRequest().authenticated()</code>表示所有的请求都要认证之后才能访问。</li>
<li>有的读者会对<code>and()</code>方法表示疑惑，<code>and()</code>方法会返回<code>HttpSecurityBuilder</code>对象的一个子类(实际上就是<code>HttpSecurity</code>)，所以 <code>and()</code>方法相当于又回到<code>HttpSecurity</code>实例，重新开启新一轮的配置。如果觉得<code>and</code>(方法很难理解，也可以不用<code>and()</code>方法，在<code>.anyRequest().authenticated()</code>配置完成后直接用分号(;）结束，然后通过 <code>http.formLogin()</code>继续配置表单登录。</li>
<li><code>formLogin()</code>表示开启表单登录配置，<code>loginPage</code>用来配置登录页面地址<code>loginProcessingUrl</code>用来配置登录接口地址; <code>defaultSuccessUrl</code>表示登录成功后的跳转地址; <code>failureUrl</code>表示登录失败后的跳转地址; <code>usernameParameter</code>表示登录用户名的参数名称; <code>passwordParameter</code>表示登录密码的参数名称;  <code>permitAll</code> 表示跟登录相关的页面和接口不做拦截，直接通过。需要注意的是，<code>loginProcessingUrl</code>、<code>usernameParameter</code>、<code>passwordParameter</code>需要和<code>login.html</code>中登录表单的配置一致。</li>
<li>最后的<code>csrf().disable()</code>表示禁用<code>CSRF防御功能</code>，<code>Spring Security</code>自带了<code>CSRF</code>防御机制,但是我们这里为了测试方便,先将<code>CSRF</code>防御机制关闭,后续将会详细介绍<code>CSRF</code>攻击与防御问题。</li>
</ul>
<h4 id="配置细节"><a href="#配置细节" class="headerlink" title="配置细节"></a>配置细节</h4><p>当然，前面的配置比较粗糙，这里还有一些配置的细节需要和读者分享一下。<br>在前面的配置中，我们用<code>defaultSuccessUrl</code>表示用户登录成功后的跳转地址，用<code>failureUrl</code>表示用户登录失败后的跳转地址。关于登录成功和登录失败，除了这两个方法可以配置之外，还有另外两个方法也可以配置。</p>
<h5 id="登陆成功"><a href="#登陆成功" class="headerlink" title="登陆成功"></a>登陆成功</h5><p>当用户登录成功之后，除了<code>defaultSuccessUnl</code> 方法可以实现登录成功后的跳转之外，<code>successForwardUrl</code>也可以实现登录成功后的跳转</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .successForwardUrl(&quot;/&quot;)</span></span><br><span class="line">.defaultSuccessUrl(<span class="string">&quot;/&quot;</span>, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<h6 id="defaultSuccessUrl-和-successForwardUrl的区别"><a href="#defaultSuccessUrl-和-successForwardUrl的区别" class="headerlink" title="defaultSuccessUrl 和 successForwardUrl的区别"></a><code>defaultSuccessUrl</code> 和 <code>successForwardUrl</code>的区别</h6><ul>
<li><code>defaultSuccessUrl</code>表示当用户登录成功之后，会自动重定向到登录之前的地址上，如果用户本身就是直接访问的登录页面，则登录成功后就会重定向到<code>defaultSuccessUrl</code>指定的页面中。例如，用户在未认证的情况下，访问了<code>hello</code>页面，此时会自动重定向到登录页面，当用户登录成功后，就会自动重定向到<code>/hello</code>页面; 而用户如果一开始就访问登录页面，则登录成功后就会自动重定向到<code>defaulItSuccessUrl</code>所指定的页面中。</li>
<li><code>successForwardUrl</code>则不会考虑用户之前的访问地址，只要用户登录成功，就会通过服务器端跳转到<code>successForwardUrl</code>所指定的页面。</li>
<li><code>defaultSuccessUrl</code>有一个重载方法，如果重载方法的第二个参数传入<code>true</code>，则<code>defaultSuccessUrl</code>的效果与<code>successForwardUrl</code>类似，即不考虑用户之前的访问地址，只要登录成功，就重定向到<code>defaultSuccessUrl</code>所指定的页面。不同之处在于，<code>defaultSuccessUrl</code>是通过重定向实现的跳转（客户端跳转)，而<code>successForwardUrl</code>则是通过服务器端跳转实现的。</li>
</ul>
<h6 id="相关源码简单分析"><a href="#相关源码简单分析" class="headerlink" title="相关源码简单分析"></a>相关源码简单分析</h6><p>无论是<code>defaultSuccessUrl</code>还是<code>successForwardUrl</code>,最终所配置的都是<code>AuthenticationSuccessHandler</code>接口的实例。<br><code>Spring Security</code>中专门提供了<code>AuthenticationSuccessHandler</code>接口用来处理登录成功事项:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain,</span></span><br><span class="line"><span class="params">			Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">		chain.doFilter(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>由上述代码可以看到，<code>AuthenticationSuccessHandler</code>接口中一共定义了两个方法，其中一个是 <code>default</code>方法，此方法是<code>Spring Security 5.2</code>开始加入进来的，在处理特定的认证请求<code>Authentication Filter</code>中会用到; 另外一个非 <code>default</code>方法，则用来处理登录成功的具体事项，其中<code>request</code>和<code>response</code>参数好理解，<code>authentication</code>参数保存了登录成功的用户信息。我们将在后面的章节中详细介绍 <code>authentication</code>参数。</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140307647.png" alt="image-20221114030734539"></p>
<p>这个接口的函数超级简单</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140309293.png" alt="image-20221114030913206"></p>
<p>你在用户认证成功之后, 就会调用上面的那个函数, 紧接着上面的默认函数会调用下面的函数, 该函数是个接口, 将会有实现类</p>
<p><code>AuthenticationSuccessHandler</code>接口共有三个实现类, 如图所示</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blogimage-20221113191332026.png" alt="image-20221113191332026"></p>
<ul>
<li><code>ForwardAuthenticationSuccessHandler</code></li>
</ul>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140311357.png" alt="image-20221114031131230"></p>
<p>成功就转发</p>
<ul>
<li><code>SavedRequestAwareAuthenticationSuccessHandler</code></li>
</ul>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140312669.png" alt="image-20221114031233549"></p>
<p><code>SavedRequestAwareAuthenticationSuccessHandler</code> 在 <code>SimpleUrlAuthenticationSuccessHandler</code> 的基础上增加了请求缓存的功能，可以记录之前请求的地址，进而在登录成功后重定向到一开始访问的地址。</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140320251.png" alt="image-20221114032000138"></p>
<ul>
<li><code>SimpleUrlAuthenticationSuccessHandler</code></li>
</ul>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140318471.png" alt="image-20221114031804364"></p>
<p>这个是默认的, 如果你没有配置任何相关配置时, 将会使用它</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140318977.png" alt="image-20221114031852842"></p>
<p>我们来重点分析<code>SavedRequestAwareAuthenticationSuccessHandler</code>和 <code>ForwardAuthenticationSuccessHandler</code>的实现。</p>
<p>当通过<code>defaultSuccessUrl</code>来设置登录成功后重定向的地址时，实际上对应的实现类就是<code>SavedRequestAwareAuthenticationSuccessHandler</code>，由于该类的源码比较长，这里列出来一部分核心代码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="keyword">extends</span> <span class="title class_">SimpleUrlAuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">Log</span> <span class="variable">logger</span> <span class="operator">=</span> LogFactory.getLog(<span class="built_in">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">RequestCache</span> <span class="variable">requestCache</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpSessionRequestCache</span>();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			Authentication authentication)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 从缓存中拿请求, 但是没有, 说明用户在登录之前没有访问的地址</span></span><br><span class="line">		<span class="type">SavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> <span class="built_in">this</span>.requestCache.getRequest(request, response);</span><br><span class="line">		<span class="keyword">if</span> (savedRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 走SimpleUrlAuthenticationSuccessHandler默认重定向地址 </span></span><br><span class="line">			<span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 拿到请求 ?target=/hello 参数的 /hello </span></span><br><span class="line">		<span class="type">String</span> <span class="variable">targetUrlParameter</span> <span class="operator">=</span> getTargetUrlParameter();</span><br><span class="line">        <span class="comment">// 如果使用默认的targetUrl, 则targetUrlParameter设置无意义</span></span><br><span class="line">        <span class="comment">// 还是和前面一样, 直接走SimpleUrlAuthenticationSuccessHandler默认重定向地址</span></span><br><span class="line">		<span class="keyword">if</span> (isAlwaysUseDefaultTargetUrl()</span><br><span class="line">				|| (targetUrlParameter != <span class="literal">null</span> &amp;&amp; StringUtils.hasText(request.getParameter(targetUrlParameter)))) &#123;</span><br><span class="line">			<span class="built_in">this</span>.requestCache.removeRequest(request, response);</span><br><span class="line">			<span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		clearAuthenticationAttributes(request);</span><br><span class="line">		<span class="comment">// Use the DefaultSavedRequest URL</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">targetUrl</span> <span class="operator">=</span> savedRequest.getRedirectUrl();</span><br><span class="line">		getRedirectStrategy().sendRedirect(request, response, targetUrl);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRequestCache</span><span class="params">(RequestCache requestCache)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.requestCache = requestCache;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li><code>String targetUrlParameter = getTargetUrlParameter();</code><ul>
<li>接下来会获取一个<code>targetUrlParameter</code>，这个是用户显式指定的、希望登录成功后重定向的地址，例如用户发送的登录请求是<code>http:/localhost:8080/doLogin?target=/hello</code>，这就表示当用户登录成功之后，希望自动重定向到<code>/hello</code>这个接口。<code>getTargetUrlParameter</code>就是要获取重定向地址参数的<code>key</code>，也就是上面的<code>target</code>，拿到<code>target</code>之后，就可以获取到重定向地址了。完整逻辑看下图</li>
<li><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140334498.png" alt="image-20221114033424360"></li>
</ul>
</li>
</ul>
<p>如果前面的条件都不满足，那么最终会从缓存请求<code>savedRequest</code> 中获取重定向地址，然后进行重定向操作。如下图:</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140336993.png" alt="image-20221114033632889"></p>
<p>整体逻辑非常简单</p>
<p>看这段代码我们可以自定义一个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title function_">defaultSuccessUrl</span><span class="params">(String defaultSuccessUrl, <span class="type">boolean</span> alwaysUse)</span> &#123;</span><br><span class="line">   <span class="type">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SavedRequestAwareAuthenticationSuccessHandler</span>();</span><br><span class="line">   handler.setDefaultTargetUrl(defaultSuccessUrl);</span><br><span class="line">   handler.setAlwaysUseDefaultTargetUrl(alwaysUse);</span><br><span class="line">   <span class="built_in">this</span>.defaultSuccessHandler = handler;</span><br><span class="line">   <span class="keyword">return</span> successHandler(handler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 当然实际开发中不会这么用</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SavedRequestAwareAuthenticationSuccessHandler <span class="title function_">successHandler</span><span class="params">()</span> &#123;</span><br><span class="line">   <span class="type">SavedRequestAwareAuthenticationSuccessHandler</span> <span class="variable">savedRequestAwareAuthenticationSuccessHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SavedRequestAwareAuthenticationSuccessHandler</span>();</span><br><span class="line">   savedRequestAwareAuthenticationSuccessHandler.setDefaultTargetUrl(<span class="string">&quot;/index&quot;</span>);</span><br><span class="line">   savedRequestAwareAuthenticationSuccessHandler.setTargetUrlParameter(<span class="string">&quot;target&quot;</span>);</span><br><span class="line">   <span class="keyword">return</span> savedRequestAwareAuthenticationSuccessHandler;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>或者效仿这个</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">SavedRequest</span> <span class="variable">savedRequest</span> <span class="operator">=</span> <span class="built_in">this</span>.requestCache.getRequest(request, response);</span><br><span class="line">    <span class="keyword">if</span> (savedRequest == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">targetUrlParameter</span> <span class="operator">=</span> <span class="built_in">this</span>.getTargetUrlParameter();</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.isAlwaysUseDefaultTargetUrl() &amp;&amp; (targetUrlParameter == <span class="literal">null</span> || !StringUtils.hasText(request.getParameter(targetUrlParameter)))) &#123;</span><br><span class="line">            <span class="built_in">this</span>.clearAuthenticationAttributes(request);</span><br><span class="line">            <span class="type">String</span> <span class="variable">targetUrl</span> <span class="operator">=</span> savedRequest.getRedirectUrl();</span><br><span class="line">            <span class="built_in">this</span>.getRedirectStrategy().sendRedirect(request, response, targetUrl);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.requestCache.removeRequest(request, response);</span><br><span class="line">            <span class="built_in">super</span>.onAuthenticationSuccess(request, response, authentication);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实现一个自定义的前后端分离的项目</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.successHandler((request, response, authentication) -&gt; &#123;</span><br><span class="line">   HashMap&lt;String, Object&gt; retHashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">   retHashMap.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;登录成功&quot;</span>);</span><br><span class="line">   retHashMap.put(<span class="string">&quot;status&quot;</span>, HttpStatus.OK.value());</span><br><span class="line">   retHashMap.put(<span class="string">&quot;authentication&quot;</span>, authentication);</span><br><span class="line">   response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">   <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> objectMapper.writeValueAsString(retHashMap);</span><br><span class="line">   response.getWriter().write(s);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h5 id="登录失败"><a href="#登录失败" class="headerlink" title="登录失败"></a>登录失败</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> SecurityFilterChain <span class="title function_">securityWebFilterChain</span><span class="params">(HttpSecurity httpSecurity, ObjectMapper objectMapper)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="keyword">return</span> httpSecurity.authorizeHttpRequests()</span><br><span class="line">        .anyRequest()</span><br><span class="line">        .authenticated()</span><br><span class="line">        .and()</span><br><span class="line">        .formLogin()</span><br><span class="line">        .loginPage(<span class="string">&quot;/login&quot;</span>)</span><br><span class="line">        .省略 ...</span><br><span class="line">        .failureUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 登录失败</span></span><br><span class="line">        .permitAll()</span><br><span class="line">        .and()</span><br><span class="line">        .build();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>.failureUrl(&quot;/login&quot;)</code> 这种是重定向, 无法携带错误信息</p>
<p>可以改成转发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.failureForwardUrl(<span class="string">&quot;/login&quot;</span>) <span class="comment">// 转发, 可以携带错误信息</span></span><br></pre></td></tr></table></figure>





<h6 id="源码简单分析"><a href="#源码简单分析" class="headerlink" title="源码简单分析"></a>源码简单分析</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ForwardAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String forwardUrl;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">ForwardAuthenticationFailureHandler</span><span class="params">(String forwardUrl)</span> &#123;</span><br><span class="line">		Assert.isTrue(UrlUtils.isValidRedirectUrl(forwardUrl), () -&gt; <span class="string">&quot;&#x27;&quot;</span> + forwardUrl + <span class="string">&quot;&#x27; is not a valid forward URL&quot;</span>);</span><br><span class="line">        <span class="comment">// 设置转发地址</span></span><br><span class="line">		<span class="built_in">this</span>.forwardUrl = forwardUrl;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">			AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">// 设置错误信息 key = &quot;SPRING_SECURITY_LAST_EXCEPTION&quot; value = 异常</span></span><br><span class="line">		request.setAttribute(WebAttributes.AUTHENTICATION_EXCEPTION, exception);</span><br><span class="line">        <span class="comment">// 转发地址</span></span><br><span class="line">		request.getRequestDispatcher(<span class="built_in">this</span>.forwardUrl).forward(request, response);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>注意看, 他的接口<code>AuthenticationFailureHandler</code></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140409564.png" alt="image-20221114040945454"></p>
<ul>
<li><code>SimpleUrlAuthenticationFailureHandler</code> 默认的处理逻辑就是通过重定向跳转到登录页面，当然也可以通过配置<code>forwardToDestination</code>属性将重定向改为服务器端跳转，<code>failureUrl</code>方法的底层实现逻辑就是<code>SimpleUrlAuthenticationFailureHandler</code>。</li>
<li><code>ExceptionMappingAuthenticationFailureHandler</code>可以实现根据不同的异常类型，映射到不同的路径。</li>
<li><code>ForwardAuthenticationFailureHandler</code>表示通过服务器端跳转来重新回到登录页面，<code>failureForwardUrl</code>方法的底层实现逻辑就是<code>ForwardAuthenticationFailureHandler</code>。</li>
<li><code>AuthenticationEntryPointFailureHandler</code>是<code>Spring Security 5.2</code>新引进的处理类，可以通过<code>AuthenticationEntryPoint</code>来处理登录异常。</li>
<li><code>DelegatingAuthenticationFailureHandler</code> 可以实现为不同的异常类型配置不同的登录失败处理回调。</li>
</ul>
<blockquote>
<p>源码就不分析了, 记得转发也可以设置前后端分析, 基本代码和重定向那边一致</p>
</blockquote>
<h5 id="注销登录"><a href="#注销登录" class="headerlink" title="注销登录"></a>注销登录</h5><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140424284.png" alt="image-20221114042414165"></p>
<ul>
<li>通过.logout(方法开启注销登录配置。</li>
<li>logoutUrl指定了注销登录请求地址，默认是GET请求，路径为&#x2F;logout。</li>
<li>invalidateHttpSession表示是否使session失效，默认为true。</li>
<li>clearAuthentication表示是否清除认证信息，默认为true。(5)logoutSuccessUrl表示注销登录后的跳转地址。</li>
</ul>
<p>设置多个注销登录地址</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(<span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout1&quot;</span>, <span class="string">&quot;GET&quot;</span>), <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;logout2&quot;</span>, <span class="string">&quot;GET&quot;</span>))) <span class="comment">// 设置多个推出登录地址</span></span><br></pre></td></tr></table></figure>



<h2 id="登录用户数据获取"><a href="#登录用户数据获取" class="headerlink" title="登录用户数据获取"></a>登录用户数据获取</h2><p>登录成功之后，在后续的业务逻辑中，开发者可能还需要获取登录成功的用户对象，如果不使用任何安全管理框架，那么可以将用户信息保存在<code>HtpSession</code> 中，以后需要的时候直接从 <code>HttpSession</code>中获取数据。在 Spring Security中，用户登录信息本质上还是保存在<code>HttpSession</code>中，但是为了方便使用，Spring Security对<code>HtpSession</code>中的用户信息进行了封装，封装之后，开发者若再想获取用户登录数据就会有两种不同的思路:<br>(1）从 <code>SecurityContextHolder</code>中获取。<br>(2）从当前请求对象中获取。</p>
<p>这里列出来的两种方式是主流的做法，开发者也可以使用一些非主流的方式获取登录成功后的用户信息，例如直接从<code>HttpSession</code> 中获取用户登录数据。<br>无论是哪种获取方式，都离不开一个重要的对象: <code>Authentication</code>。在Spring Security 中，<code>Authentication</code>对象主要有两方面的功能:</p>
<p>(1）作为<code>AuthenticationManager</code> 的输入参数，提供用户身份认证的凭证，当它作为一个输入参数时，它的<code>isAuthenticated</code>方法返回<code>false</code>，表示用户还未认证。<br>(2)代表已经经过身份认证的用户,此时的<code>Authentication</code>可以从<code>SecurityContext</code>中获取。</p>
<p>一个<code>Authentication</code>对象主要包含三个方面的信息:</p>
<p>(1) <code>principal</code>:定义认证的用户。如果用户使用用户名&#x2F;密码的方式登录，<code>principal</code> 通常就是一个<code>UserDetails</code>对象。<br>(2) <code>credentials</code>:登录凭证，一般就是指密码。当用户登录成功之后，登录凭证会被自动擦除，以防止泄漏。<br>(3）<code>authorities</code>:用户被授予的权限信息。</p>
<p>Java中本身提供了<code>Principal</code> 接口用来描述认证主体，<code>Principal</code>可以代表一个公司、个人或者<code>登录ID</code>。Spring Security中定义了<code>Authentication</code>接口用来规范登录用户信息，<code>Authentication</code>继承自<code>Principal</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Authentication</span> <span class="keyword">extends</span> <span class="title class_">Principal</span>, Serializable &#123;</span><br><span class="line">    </span><br><span class="line">	Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line">	</span><br><span class="line">	Object <span class="title function_">getCredentials</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	Object <span class="title function_">getDetails</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	Object <span class="title function_">getPrincipal</span><span class="params">()</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<ul>
<li><code>getAuthorities</code>方法:用来获取用户权限。</li>
<li><code>getCredentials</code> 方法:用来获取用户凭证，一般来说就是密码。</li>
<li><code>getDetails</code>方法:用来获取用户的详细信息，可能是当前的请求之类。</li>
<li><code>getPrincipal</code>方法:用来获取当前用户信息，可能是一个用户名，也可能是一个用户对象。</li>
<li><code>isAuthenticated</code>方法:当前用户是否认证成功。</li>
</ul>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140456000.png" alt="image-20221114045647861"></p>
<p>不同的认证方式有不同的<code>Authentication</code>对象</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211140501798.png" alt="image-20221114050140666"></p>
<ul>
<li><code>AbstractAuthenticationToken</code>:该类实现了<code>Authentication</code>和 <code>CredentialsContainer</code>两个接口,在<code>AbstractAuthenticationToken</code> 中对<code>Authentication</code> 接口定义的各个数据获取方法进行了实现，<code>CredentialsContainer</code>则提供了登录凭证擦除方法。一般在登录成功后，为了防止用户信息泄漏，可以将登录凭证（例如密码）擦除。</li>
<li><code>RememberMeAuthenticationToken</code>:如果用户使用<code>RememberMe</code>的方式登录，登录信息将封装在<code>RememberMeAuthenticationToken</code> 中。</li>
<li><code>TestingAuthenticationToken</code>:单元测试时封装的用户对象。</li>
<li><code>AnonymousAuthenticationToken</code>:匿名登录时封装的用户对象。</li>
<li><code>RunAsUserToken</code>:替换验证身份时封装的用户对象。</li>
<li><code>UsernamePasswordAuthenticationToken</code>:表单登录时封装的用户对象。</li>
<li><code>JaasAuthenticationToken</code>:<code>JAAS</code>认证时封装的用户对象。</li>
<li><code>PreAuthenticatedAuthenticationToken</code>: <code>Pre-Authentication</code>场景下封装的用户对象。</li>
</ul>
<p>在这些<code>Authentication</code>的实例中，最常用的有两个:<code>UsernamePasswordAuthenticationToken</code>和<code>RememberMeAuthenticationToken</code>。在前面中的案例对应的用户认证对象就是<code>UsernamePasswordAuthenticationToken</code>。<br>了解了<code>Authentication</code>对象之后，接下来我们来看一下如何在登录成功后获取用户登录信息，即 <code>Authentication</code>对象。</p>
<h3 id="修改SecurityContextHolder存储的位置"><a href="#修改SecurityContextHolder存储的位置" class="headerlink" title="修改SecurityContextHolder存储的位置"></a>修改SecurityContextHolder存储的位置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;user&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 这个对象绑定在 ThreadLocal</span></span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">		Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line">		System.err.println(<span class="string">&quot;username: &quot;</span> + name);</span><br><span class="line">		System.err.println(<span class="string">&quot;authorities: &quot;</span> + authorities);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>首先在 <code>SecurityContextHolder</code>中存放的是<code>SecurityContext</code>，<code>SecurityContextHolder</code> 中定义了三种不同的数据存储策略，这实际上是一种典型的策略模式:<br>(1）<code>MODE_THREADLOCAL</code>:这种存放策略是将<code>SecurityContext</code>存放在<code>ThreadLocal</code>中，大家知道<code>ThreadLocal</code>的特点是在哪个线程中存储就要在哪个线程中读取，这其实非常适合Web 应用，因为在默认情况下，一个请求无论经过多少<code>Filter</code>到达 <code>Servlet</code>，都是由一个线程来处理的。这也是<code>SecurityContextHolder</code> 的默认存储策略，这种存储策略意味着如果在具体的业务处理代码中，开启了子线程，在子线程中去获取登录用户数据，就会获取不到。<br>(2)<code>MODE_INHERITABLETHREADLOCAL</code>:这种存储模式适用于多线程环境，如果希望在子线程中也能够获取到登录用户数据，那么可以使用这种存储模式。<br>(3）<code>MODE_GLOBAL</code>:这种存储模式实际上是将数据保存在一个静态变量中，在 <code>JavaWeb</code>开发中，这种模式很少使用到。</p>
<p><code>Spring Security</code> 中定义了<code>SecurityContextHolderStrategy</code>接口用来规范存储策略中的方法，我们来看一下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityContextHolderStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除当前上下文</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">clearContext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取当前上下文</span></span><br><span class="line">	SecurityContext <span class="title function_">getContext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置当前上下文</span></span><br><span class="line">	<span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(SecurityContext context)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建一个新的, 空的上下文实现, 供SecurityContextRepository实现在首次创建新上下文时使用。</span></span><br><span class="line">	SecurityContext <span class="title function_">createEmptyContext</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>有4个实现类</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211141500812.png" alt="image-20221114150030634"></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211141503475.png" alt="image-20221114150301372"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalSecurityContextHolderStrategy</span> <span class="keyword">implements</span> <span class="title class_">SecurityContextHolderStrategy</span> &#123;</span><br><span class="line">	<span class="comment">// 存储状态, 更线程绑定</span></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;SecurityContext&gt; contextHolder = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">clearContext</span><span class="params">()</span> &#123;</span><br><span class="line">		contextHolder.remove();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> SecurityContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="type">SecurityContext</span> <span class="variable">ctx</span> <span class="operator">=</span> contextHolder.get();</span><br><span class="line">		<span class="keyword">if</span> (ctx == <span class="literal">null</span>) &#123;</span><br><span class="line">			ctx = createEmptyContext();</span><br><span class="line">			contextHolder.set(ctx);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> ctx;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(SecurityContext context)</span> &#123;</span><br><span class="line">		Assert.notNull(context, <span class="string">&quot;Only non-null SecurityContext instances are permitted&quot;</span>);</span><br><span class="line">		contextHolder.set(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> SecurityContext <span class="title function_">createEmptyContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecurityContextImpl</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这些都是非常简单的代码, 就不介绍了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocalSecurityContextHolderStrategy</span> <span class="keyword">implements</span> <span class="title class_">SecurityContextHolderStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;SecurityContext&gt; contextHolder = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>跟上面唯一的区别在于 <code>ThreadLocal</code>和<code>InheritableThreadLocal</code></p>
<p><code>InheritableThreadLocal</code>非常简单</p>
<p>该对象扩展了 <code>ThreadLocal</code>, 提供了从父线程到子线程的值继承</p>
<p>当子线程被创建, 此时子线程将会获得所有并初始化继承的父线程有的ThreadLocal变量的值</p>
<p>通常, 子线程的值将会和父线程相同, 然而, 子线程的值可以通过重写在类中的childValue函数变成父类的任意方法</p>
<p>当变量中维护的每线程属性（例如，用户ID，事务ID）必须自动传输到创建的任何子线程时，可继承的线程局部变量优先于普通线程局部变量。<br>注意：在创建新线程期间，可以选择不接收可继承线程局部变量的初始值。</p>
<p>最后</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150114152.png" alt="image-20221115011402986"></p>
<p>就更简单了, 直接使用一个静态变量让多线程共享使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityContextHolder</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_THREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_THREADLOCAL&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_INHERITABLETHREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_GLOBAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_GLOBAL&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_PRE_INITIALIZED</span> <span class="operator">=</span> <span class="string">&quot;MODE_PRE_INITIALIZED&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SYSTEM_PROPERTY</span> <span class="operator">=</span> <span class="string">&quot;spring.security.strategy&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">strategyName</span> <span class="operator">=</span> System.getProperty(SYSTEM_PROPERTY);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> SecurityContextHolderStrategy strategy;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">initializeCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		initialize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">		initializeStrategy();</span><br><span class="line">		initializeCount++;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initializeStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) &#123;</span><br><span class="line">			Assert.state(strategy != <span class="literal">null</span>, <span class="string">&quot;When using &quot;</span> + MODE_PRE_INITIALIZED</span><br><span class="line">					+ <span class="string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span>);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(strategyName)) &#123;</span><br><span class="line">			<span class="comment">// Set default</span></span><br><span class="line">			strategyName = MODE_THREADLOCAL;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">ThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (strategyName.equals(MODE_GLOBAL)) &#123;</span><br><span class="line">			strategy = <span class="keyword">new</span> <span class="title class_">GlobalSecurityContextHolderStrategy</span>();</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// Try to load a custom strategy</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			Class&lt;?&gt; clazz = Class.forName(strategyName);</span><br><span class="line">			Constructor&lt;?&gt; customStrategy = clazz.getConstructor();</span><br><span class="line">			strategy = (SecurityContextHolderStrategy) customStrategy.newInstance();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">			ReflectionUtils.handleReflectionException(ex);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">clearContext</span><span class="params">()</span> &#123;</span><br><span class="line">		strategy.clearContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SecurityContext <span class="title function_">getContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> strategy.getContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">getInitializeCount</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> initializeCount;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(SecurityContext context)</span> &#123;</span><br><span class="line">		strategy.setContext(context);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setStrategyName</span><span class="params">(String strategyName)</span> &#123;</span><br><span class="line">		SecurityContextHolder.strategyName = strategyName;</span><br><span class="line">		initialize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setContextHolderStrategy</span><span class="params">(SecurityContextHolderStrategy strategy)</span> &#123;</span><br><span class="line">		Assert.notNull(strategy, <span class="string">&quot;securityContextHolderStrategy cannot be null&quot;</span>);</span><br><span class="line">		SecurityContextHolder.strategyName = MODE_PRE_INITIALIZED;</span><br><span class="line">		SecurityContextHolder.strategy = strategy;</span><br><span class="line">		initialize();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SecurityContextHolderStrategy <span class="title function_">getContextHolderStrategy</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> strategy;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> SecurityContext <span class="title function_">createEmptyContext</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> strategy.createEmptyContext();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;SecurityContextHolder[strategy=&#x27;&quot;</span> + strategy.getClass().getSimpleName() + <span class="string">&quot;&#x27;; initializeCount=&quot;</span></span><br><span class="line">				+ initializeCount + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>从这段源码中可以看到，<code>SecurityContextHolder</code>定义了三个静态常量用来描述三种不同的存储策略;存储策略<code>strategy</code> 会在静态代码块中进行初始化，根据不同的<code>strategyName</code>初始化不同的存储策略; <code>strategyName</code>变量表示目前正在使用的存储策略，<strong>开发者可以通过配置系统变量或者调用<code>setStrategyName</code>来修改<code>SecurityContextHolder</code> 中的存储策略</strong>，调用<code>setStrategyName</code>后会重新初始化 <code>strategy</code>。<br>默认情况下，如果开发者试图从子线程中获取当前登录用户数据，就会获取失败，代码如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">@GetMapping(&quot;user&quot;)</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">userInfo</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="comment">// 这个对象绑定在 ThreadLocal</span></span><br><span class="line">		<span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> authentication.getName();</span><br><span class="line">		Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities = authentication.getAuthorities();</span><br><span class="line">		System.err.println(<span class="string">&quot;主线程: username = &quot;</span> + name);</span><br><span class="line">		System.err.println(<span class="string">&quot;主线程: authorities = &quot;</span> + authorities);</span><br><span class="line">		<span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">			<span class="type">Authentication</span> <span class="variable">authentication1</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">			<span class="keyword">if</span> (authentication1 == <span class="literal">null</span>) &#123;</span><br><span class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">&quot;: 获得用户信息失败&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">String</span> <span class="variable">name1</span> <span class="operator">=</span> authentication1.getName();</span><br><span class="line">			Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; authorities1 = authentication.getAuthorities();</span><br><span class="line">			System.err.println(Thread.currentThread().getName() + <span class="string">&quot;: username: &quot;</span> + name1);</span><br><span class="line">			System.err.println(Thread.currentThread().getName() + <span class="string">&quot;: authorities: &quot;</span> + authorities1);</span><br><span class="line">		&#125;, <span class="string">&quot;子线程&quot;</span>).start();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">主线程: username = user</span><br><span class="line">主线程: authorities = []</span><br><span class="line">子线程: 获得用户信息失败</span><br></pre></td></tr></table></figure>



<p>设置多线程ThreadLocal继承策略</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FormLoginApplication</span> &#123;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      System.setProperty(SecurityContextHolder.SYSTEM_PROPERTY, SecurityContextHolder.MODE_INHERITABLETHREADLOCAL); <span class="comment">// 设置 SecurityContextHolder 模式</span></span><br><span class="line">      SpringApplication.run(FormLoginApplication.class, args);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150126252.png" alt="image-20221115012656176"></p>
<h3 id="SecurityContextPersistenceFilter-已弃用"><a href="#SecurityContextPersistenceFilter-已弃用" class="headerlink" title="SecurityContextPersistenceFilter(已弃用)"></a>SecurityContextPersistenceFilter(已弃用)</h3><p>使用在请求之前所配置的<code>SecurityContextRepository</code>获取的信息去填充<code>SecurityContextHolder</code></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150210196.png" alt="image-20221115021029092"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityContextRepository</span> &#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 已被弃用, 使用下面的那个default Supplier&lt;SecurityContext&gt; loadContext(HttpServletRequest request)</span></span><br><span class="line">   <span class="meta">@Deprecated</span></span><br><span class="line">   SecurityContext <span class="title function_">loadContext</span><span class="params">(HttpRequestResponseHolder requestResponseHolder)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">default</span> Supplier&lt;SecurityContext&gt; <span class="title function_">loadContext</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> SingletonSupplier.of(() -&gt; loadContext(<span class="keyword">new</span> <span class="title class_">HttpRequestResponseHolder</span>(request, <span class="literal">null</span>)));</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">saveContext</span><span class="params">(SecurityContext context, HttpServletRequest request, HttpServletResponse response)</span>;</span><br><span class="line">   </span><br><span class="line">   <span class="type">boolean</span> <span class="title function_">containsContext</span><span class="params">(HttpServletRequest request)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>默认它使用<code>HttpSessionSecurityContextRepository </code>, 有关 <code>HttpSession</code> 相关配置选项的信息，请参阅此类。</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150204707.png" alt="image-20221115020400589"></p>
<p>该过滤器只会在每一个<code>request</code>请求执行一次, 以解析<code>servlet</code>容器（特别是 <code>Weblogic</code>）的兼容问题</p>
<p>过滤器必须在任何认证处理机制前执行</p>
<p>认证处理机制(例如: Basic, cas 处理过滤器等)期望<code>SecurityContextHolder</code>在他们执行时包含有效的<code>SecurityContext</code></p>
<p>这本质上是就<code>HttpSessionContextIntegrationFilter</code> 的重构过程, 以委托存储问题给单独的策略, 从而允许在请求之间维护安全上下文方式进行更多的自定义</p>
<p><code>forceEagerSessionCreation</code> 属性将被用于确保<code>session</code>总是在过滤器链执行之前可用(默认是<code>false</code>, 他是不推荐 且密集的资源)</p>
<p>该类已弃用, 现在使用<code>SecurityContextHolderFilter</code></p>
<p>整体上来说，<code>SecurityContextPersistenceFilter</code>主要做两件事情: </p>
<ul>
<li><p>当一个请求到来时，从<code>HttpSession</code>中获取<code>SecurityContext</code>并存入<code>SecurityContextHolder</code>中，这样在同一个请求的后续处理过程中，开发者始终可以通过<code>SecurityContextHolder</code>获取到当前登录用户信息。</p>
</li>
<li><p>当一个请求处理完毕时，从 <code>SecurityContextHolder</code> 中获取 <code>SecurityContext</code>并存入<code>HttpSession</code>中（主要针对异步<code>Servlet</code>），方便下一个请求到来时，再从<code>HttpSession</code>中拿出来使用，同时擦除<code>SecurityContextHolder</code> 中的登录用户信息。</p>
<blockquote>
<p>在<code>SecurityContextPersistenceFilter</code>过滤器中，当一个请求处理完毕时，从<code>SecurityContextHolder</code>中获取<code>SecurityContext</code> 存入<code>HtpSession</code>中,这一步的操作主要是针对异步<code>Servlet</code>。如果不是异步<code>Servlet</code>,在响应提交时,就会将<code>SecurityContext</code>保存到<code>HtpSession</code>中了，而不会等到在<code>SecurityContextPersistenceFilter</code>过滤器中再去存储。</p>
</blockquote>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Deprecated</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityContextPersistenceFilter</span> <span class="keyword">extends</span> <span class="title class_">GenericFilterBean</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FILTER_APPLIED</span> <span class="operator">=</span> <span class="string">&quot;__spring_security_scpf_applied&quot;</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> SecurityContextRepository repo;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">forceEagerSessionCreation</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">SecurityContextPersistenceFilter</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>(<span class="keyword">new</span> <span class="title class_">HttpSessionSecurityContextRepository</span>());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">SecurityContextPersistenceFilter</span><span class="params">(SecurityContextRepository repo)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.repo = repo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		doFilter((HttpServletRequest) request, (HttpServletResponse) response, chain);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span></span><br><span class="line">			<span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">		<span class="comment">// ensure that filter is only applied once per request</span></span><br><span class="line">		<span class="keyword">if</span> (request.getAttribute(FILTER_APPLIED) != <span class="literal">null</span>) &#123;</span><br><span class="line">			chain.doFilter(request, response);</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		request.setAttribute(FILTER_APPLIED, Boolean.TRUE);</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">this</span>.forceEagerSessionCreation) &#123;</span><br><span class="line">			<span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> request.getSession();</span><br><span class="line">			<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled() &amp;&amp; session.isNew()) &#123;</span><br><span class="line">				<span class="built_in">this</span>.logger.debug(LogMessage.format(<span class="string">&quot;Created session %s eagerly&quot;</span>, session.getId()));</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">HttpRequestResponseHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HttpRequestResponseHolder</span>(request, response);</span><br><span class="line">		<span class="type">SecurityContext</span> <span class="variable">contextBeforeChainExecution</span> <span class="operator">=</span> <span class="built_in">this</span>.repo.loadContext(holder);</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			SecurityContextHolder.setContext(contextBeforeChainExecution);</span><br><span class="line">			<span class="keyword">if</span> (contextBeforeChainExecution.getAuthentication() == <span class="literal">null</span>) &#123;</span><br><span class="line">				logger.debug(<span class="string">&quot;Set SecurityContextHolder to empty SecurityContext&quot;</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">if</span> (<span class="built_in">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">					<span class="built_in">this</span>.logger</span><br><span class="line">							.debug(LogMessage.format(<span class="string">&quot;Set SecurityContextHolder to %s&quot;</span>, contextBeforeChainExecution));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			chain.doFilter(holder.getRequest(), holder.getResponse());</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			<span class="type">SecurityContext</span> <span class="variable">contextAfterChainExecution</span> <span class="operator">=</span> SecurityContextHolder.getContext();</span><br><span class="line">			<span class="comment">// Crucial removal of SecurityContextHolder contents before anything else.</span></span><br><span class="line">			SecurityContextHolder.clearContext();</span><br><span class="line">			<span class="built_in">this</span>.repo.saveContext(contextAfterChainExecution, holder.getRequest(), holder.getResponse());</span><br><span class="line">			request.removeAttribute(FILTER_APPLIED);</span><br><span class="line">			<span class="built_in">this</span>.logger.debug(<span class="string">&quot;Cleared SecurityContextHolder to complete request&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setForceEagerSessionCreation</span><span class="params">(<span class="type">boolean</span> forceEagerSessionCreation)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.forceEagerSessionCreation = forceEagerSessionCreation;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>但该类已被弃用, 现在使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityContextHolderFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> SecurityContextRepository securityContextRepository;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="type">boolean</span> shouldNotFilterErrorDispatch;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates a new instance.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> securityContextRepository the repository to use. Cannot be null.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">SecurityContextHolderFilter</span><span class="params">(SecurityContextRepository securityContextRepository)</span> &#123;</span><br><span class="line">		Assert.notNull(securityContextRepository, <span class="string">&quot;securityContextRepository cannot be null&quot;</span>);</span><br><span class="line">		<span class="built_in">this</span>.securityContextRepository = securityContextRepository;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">			<span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">// 读取SecurityContext</span></span><br><span class="line">		<span class="type">SecurityContext</span> <span class="variable">securityContext</span> <span class="operator">=</span> <span class="built_in">this</span>.securityContextRepository.loadContext(request).get();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 存储到 SecurityContextHolder</span></span><br><span class="line">			SecurityContextHolder.setContext(securityContext);</span><br><span class="line">			filterChain.doFilter(request, response);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">finally</span> &#123;</span><br><span class="line">			SecurityContextHolder.clearContext();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">shouldNotFilterErrorDispatch</span><span class="params">()</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">this</span>.shouldNotFilterErrorDispatch;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setShouldNotFilterErrorDispatch</span><span class="params">(<span class="type">boolean</span> shouldNotFilterErrorDispatch)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.shouldNotFilterErrorDispatch = shouldNotFilterErrorDispatch;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>他们有个通用的属性: <code>SecurityContextRepository</code> </p>
<p>该属性前面也看过了, 主要使用 <code>HttpSessionSecurityContextRepository </code>作为实现类实体用于增删改查<code>SecurityContext</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">saveContext</span><span class="params">(SecurityContext context, HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">    <span class="type">SaveContextOnUpdateOrErrorResponseWrapper</span> <span class="variable">responseWrapper</span> <span class="operator">=</span> WebUtils.getNativeResponse(response,</span><br><span class="line">                                                                                           SaveContextOnUpdateOrErrorResponseWrapper.class);</span><br><span class="line">    <span class="keyword">if</span> (responseWrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 获得session</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">httpSessionExists</span> <span class="operator">=</span> request.getSession(<span class="literal">false</span>) != <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 创建SecurityContext</span></span><br><span class="line">        <span class="type">SecurityContext</span> <span class="variable">initialContext</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">        <span class="comment">// 创建存储容器 其本质是一个HttpServletResponse</span></span><br><span class="line">        responseWrapper = <span class="keyword">new</span> <span class="title class_">SaveToSessionResponseWrapper</span>(response, request, httpSessionExists, initialContext);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 存储 SecurityContext 下面有代码截图</span></span><br><span class="line">    responseWrapper.saveContext(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150953686.png" alt="image-20221115095326549"></p>
<p>如果拿不到<code>authentication</code> 则删除掉httpsession中的<code>authentication</code></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150952064.png" alt="image-20221115095204890"></p>
<p>如果<code>authentication</code>和<code>httpSession</code>都不是空的, 就保存</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpSession.setAttribute(springSecurityContextKey, context);</span><br></pre></td></tr></table></figure>



<p>保存到 key &#x3D; <img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211150955845.png" alt="image-20221115095542749"></p>
<p>的session中</p>
<blockquote>
<p>其他源码就不看了, 基本上都是对<code>httpSession</code>的操作</p>
</blockquote>
<h2 id="从当前请求对象中获取"><a href="#从当前请求对象中获取" class="headerlink" title="从当前请求对象中获取"></a>从当前请求对象中获取</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;authentication&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Authentication <span class="title function_">authentication</span><span class="params">(Authentication authentication)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> authentication;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping(&quot;principal&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> Principal <span class="title function_">principal</span><span class="params">(Principal principal)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> principal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这两都是一个的JSON:<br><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151011543.png" alt="image-20221115101135403"></p>
<p>学过springMVC都应该知道, <code>Controller</code>方法的参数都是由<code>HttpServletRequest</code>请求拿出来的</p>
<p>那他是什么时候存储到<code>HttpServletRequest</code>的?</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151020042.png" alt="image-20221115102021918"></p>
<p>看上面这三个函数 找到这三个函数的 spring security实现:</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151022808.png" alt="image-20221115102248679"></p>
<p>再看这三个函数:</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151026078.png" alt="image-20221115102646943"></p>
<p>找 SpringSecurity的实现类<code>HttpServlet3RequestFactory</code>的内部类<code>Servlet3SecurityContextHolderAwareRequestWrapper</code>:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(String username, String password)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">   <span class="keyword">if</span> (isAuthenticated()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(<span class="string">&quot;Cannot perform login for &#x27;&quot;</span> + username + <span class="string">&quot;&#x27; already authenticated as &#x27;&quot;</span></span><br><span class="line">            + getRemoteUser() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">AuthenticationManager</span> <span class="variable">authManager</span> <span class="operator">=</span> HttpServlet3RequestFactory.<span class="built_in">this</span>.authenticationManager;</span><br><span class="line">   <span class="keyword">if</span> (authManager == <span class="literal">null</span>) &#123;</span><br><span class="line">      HttpServlet3RequestFactory.<span class="built_in">this</span>.logger.debug(</span><br><span class="line">            <span class="string">&quot;authenticationManager is null, so allowing original HttpServletRequest to handle login&quot;</span>);</span><br><span class="line">      <span class="built_in">super</span>.login(username, password);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> getAuthentication(authManager, username, password);</span><br><span class="line">   <span class="type">SecurityContext</span> <span class="variable">context</span> <span class="operator">=</span> SecurityContextHolder.createEmptyContext();</span><br><span class="line">   context.setAuthentication(authentication);</span><br><span class="line">   SecurityContextHolder.setContext(context);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Authentication <span class="title function_">getAuthentication</span><span class="params">(AuthenticationManager authManager, String username, String password)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span> UsernamePasswordAuthenticationToken</span><br><span class="line">            .unauthenticated(username, password);</span><br><span class="line">      <span class="type">Object</span> <span class="variable">details</span> <span class="operator">=</span> HttpServlet3RequestFactory.<span class="built_in">this</span>.authenticationDetailsSource.buildDetails(<span class="built_in">this</span>);</span><br><span class="line">      authentication.setDetails(details);</span><br><span class="line">      <span class="keyword">return</span> authManager.authenticate(authentication);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (AuthenticationException ex) &#123;</span><br><span class="line">      SecurityContextHolder.clearContext();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(ex.getMessage(), ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到这里我们就知道怎么使用 HttpServletRequest 了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;information&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">information</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> JsonProcessingException &#123;</span><br><span class="line">   <span class="type">Principal</span> <span class="variable">userPrincipal</span> <span class="operator">=</span> request.getUserPrincipal();</span><br><span class="line">   <span class="type">String</span> <span class="variable">remoteUser</span> <span class="operator">=</span> request.getRemoteUser();</span><br><span class="line">   <span class="type">boolean</span> <span class="variable">admin</span> <span class="operator">=</span> request.isUserInRole(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">   List&lt;Object&gt; objectList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">   objectList.add(userPrincipal);</span><br><span class="line">   objectList.add(remoteUser);</span><br><span class="line">   objectList.add(admin);</span><br><span class="line">   <span class="keyword">return</span> objectMapper.writeValueAsString(objectList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151040399.png" alt="image-20221115104022282"></p>
<p>前面我们直接将<code>Authentication</code>或者<code>Principal</code> 写到<code>Controller</code>参数中，实际上就是<code>SpringMVC</code>框架从<code>Servlet3SecurityContextHolderAwareRequestWrapper</code> 中提取的用户信息。<br>那么<code>Spring Security</code>是如何将默认的请求对象转化为<code>Servlet3SecurityContextHolderAwareRequestWrapper</code> 的呢?这就涉及<code>Spring Security</code>过滤器链中另外一个重要的过滤器——<code>SecurityContextHolderAwareRequestFilter</code>。<br>前面我们提到<code>Spring Security</code>过滤器中，有一个<code>SecurityContextHolderAwareRequestFilter</code>过滤器，该过滤器的主要作用就是对<code>HttpServletRequest</code>请求进行再包装，重写<code>HtpServletRequest</code> 中和安全管理相关的方法。<code>HtpServletRequest</code> 在整个请求过程中会被包装多次，每一次的包装都会给它增添新的功能，例如在经过 <code>SecurityContextPersistenceFilter</code>请求时就会对它进行包装。</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151044214.png" alt="image-20221115104459115"></p>
<p>本质上还是一个过滤器</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151047995.png" alt="image-20221115104708878"></p>
<p><code>requestFactory</code>这个对象在这里被被创建</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog202211151048208.png" alt="image-20221115104857077"></p>
<p>跟进<code>HttpServlet3RequestFactory</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> HttpServletRequest <span class="title function_">create</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Servlet3SecurityContextHolderAwareRequestWrapper</span>(request, <span class="built_in">this</span>.rolePrefix, response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>这个<code>Servlet3SecurityContextHolderAwareRequestWrapper</code>类再次见到了</p>
<p>最终在<code>Spring MVC</code> 的<code>ServletRequestMethodArgumentResolver#resolveArgument(Class&lt;?&gt;,HttpServletRequest)</code>方法中进行默认参数解析，自动解析出 <code>Principal</code>对象。开发者在<code>Controller</code>中既可以通过 <code>Principal</code>来接收参数，也可以通过<code>Authentication</code>对象来接收。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Bangiao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://bangiao.github.io/2022/11/15/02springcloud/012SpringCloud系列——SpringSecurity学习(七)/">https://bangiao.github.io/2022/11/15/02springcloud/012SpringCloud系列——SpringSecurity学习(七)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/">过滤器</a><a class="post-meta__tags" href="/tags/%E8%AE%A4%E8%AF%81/">认证</a><a class="post-meta__tags" href="/tags/%E6%8E%88%E6%9D%83/">授权</a><a class="post-meta__tags" href="/tags/%E7%99%BB%E5%BD%95/">登录</a><a class="post-meta__tags" href="/tags/%E8%A7%92%E8%89%B2/">角色</a><a class="post-meta__tags" href="/tags/SpringSecurity/">SpringSecurity</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/11/18/02springcloud/013SpringCloud%E7%B3%BB%E5%88%97%E2%80%94%E2%80%94SpringSecurity%E5%AD%A6%E4%B9%A0(%E4%B8%83)/"><i class="fa fa-chevron-left">  </i><span>013SpringCloud系列——SpringSecurity学习(七)</span></a></div><div class="next-post pull-right"><a href="/2022/11/11/03ORM/04XML%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E5%A4%84%E7%90%86%E6%96%B9%E5%BC%8F/"><span>04XML特殊字符处理方式</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2022 By Bangiao</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">这是博客github仓库地址：<a target="_blank" rel="noopener" href="https://github.com/bangiao/bangiao.github.io">bangiao.github.io</a>，欢迎访问!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>