<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="14SpringSecurity-架构图"><meta name="keywords" content="过滤器,认证,登录,角色,SpringSecurity,源码分析,图片验证码,多数据源"><meta name="author" content="Bangiao"><meta name="copyright" content="Bangiao"><title>14SpringSecurity-架构图 | Bangiao's Notebooks</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity%E6%9E%B6%E6%9E%84"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E5%BC%A0%E5%9B%BE"><span class="toc-number">1.1.</span> <span class="toc-text">第一张图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%8C%E5%BC%A0%E5%9B%BE"><span class="toc-number">1.2.</span> <span class="toc-text">第二张图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">初始化过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8Filter%E7%9A%84%E8%BF%87%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">调用Filter的过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.2.3.</span> <span class="toc-text">其他</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E5%BC%A0%E5%9B%BE"><span class="toc-number">1.3.</span> <span class="toc-text">第三张图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E5%9B%9B%E5%BC%A0%E5%9B%BE"><span class="toc-number">1.4.</span> <span class="toc-text">第四张图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%BA%94%E5%BC%A0%E5%9B%BE"><span class="toc-number">1.5.</span> <span class="toc-text">第五张图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.6.</span> <span class="toc-text">SpringSecurity异常处理</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://imgsa.baidu.com/forum/pic/item/c8179682d158ccbf63dc944d1bd8bc3eb03541a9.jpg"></div><div class="author-info__name text-center">Bangiao</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/bangiao">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">24</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">83</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">5</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">我的博客</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://juejin.cn/user/4248168662314823">掘金</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30690165">CSDN</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/bangiao/">博客园</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gitee.com/bangiao_admin/projects">Gitee笔记源码</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Bangiao's Notebooks</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章列表</a><a class="site-page" href="/tags">文章标签</a><a class="site-page" href="/categories">文章分类</a><a class="site-page" href="/sources">笔记源码</a><a class="site-page" href="/about">关于</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">14SpringSecurity-架构图</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-11-21</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springcloud/">springcloud</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="SpringSecurity架构"><a href="#SpringSecurity架构" class="headerlink" title="SpringSecurity架构"></a><code>SpringSecurity</code>架构</h1><p>官方用几张图片就较为简单的显示了<code>SpringSecurity</code>的架构</p>
<h2 id="第一张图"><a href="#第一张图" class="headerlink" title="第一张图"></a>第一张图</h2><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211210644201.png" alt="image-20221121064439555"></p>
<p>开篇第一句话 “<code>SpringSecurity</code>支持基于<code>Servlet Filters</code>“</p>
<p>第二句话解释了上图图示</p>
<p>The client sends a request to the application, and the container creates a <code>FilterChain</code> which contains the <code>Filter</code>s and <code>Servlet</code> that should process the <code>HttpServletRequest</code> based on the path of the request URI.</p>
<p>需要关注的是 <code>based on the path of the request URI</code> <strong>过滤器根据 request URI路径 拦截</strong></p>
<p>除此之外他也说了除<code>DispatcherServlet</code>外的其他过滤器的功能:</p>
<ul>
<li>要么切断<code>Filter Chain</code>(过滤器链), 通常这样的<code>Filter</code>会把执行的结果写入<code>HttpServletResponse</code></li>
<li>要么修改准备传递给下游<code>Filter</code>的<code>HttpServletRequest</code>或者<code>HttpServletResponse</code></li>
</ul>
<p>然后给出了一个<code>FilterChain</code>工作的源码:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> &#123;</span><br><span class="line">	<span class="comment">// do something before the rest of the application</span></span><br><span class="line">    chain.doFilter(request, response); <span class="comment">// invoke the rest of the application</span></span><br><span class="line">    <span class="comment">// do something after the rest of the application</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对的, 就是 <code>doFilter</code>, 相当于 <code>nextFilter</code></p>
<p>最后强调了 <strong>Filter 之间的 顺序很重要</strong> 这点记住了, 要考</p>
<h2 id="第二张图"><a href="#第二张图" class="headerlink" title="第二张图"></a>第二张图</h2><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211210704550.png" alt="image-20221121070407474"></p>
<p>可以看出来<code>DelegatingFilterProxy</code> 包装了一个 <code>Bean Filter</code>, 这个 <code>Bean Filter</code>是 <code>Spring Bean</code>获取出来的过滤器</p>
<p>这张图片主要强调 <code>DelegatingFilterProxy</code> , 一个在 <code>servlet</code> 和 <code>Spring</code> 之间牵线搭桥的家伙, 他的本质还是一个<code>Filter</code>过滤器</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211336508.png" alt="image-20221121133613411"></p>
<p>脱离官方文档, 我们来仔细看看这个过滤器</p>
<h3 id="初始化过程"><a href="#初始化过程" class="headerlink" title="初始化过程"></a>初始化过程</h3><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211322819.png" alt="image-20221121131225282"></p>
<p>从上面那张图中可以瞄准如下图所示的函数</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211332455.png" alt="image-20221121133202331"></p>
<p>从<code>SpringMVC</code>上下文中获取 <code>Filter</code> </p>
<blockquote>
<p>这不就刚好诠释了<code>DelegatingFilterProxy</code>的作用么?</p>
</blockquote>
<p>再跟</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211335272.png" alt="image-20221121133511163"></p>
<p>不是刚好配合上了么?</p>
<p>我们查找过滤器接口函数<code>init</code></p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211325430.png" alt="image-20221121132551324"></p>
<p>可以看到这个函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">   <span class="comment">// 这个函数调用的是</span></span><br><span class="line">   initFilterBean();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211329227.png" alt="image-20221121132908140"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initFilterBean</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="built_in">this</span>.delegateMonitor) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">this</span>.delegate == <span class="literal">null</span>) &#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="built_in">this</span>.targetBeanName == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.targetBeanName = getFilterName();</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="comment">// 直接获取 SpringMVC 的上下文</span></span><br><span class="line">         <span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> findWebApplicationContext();</span><br><span class="line">         <span class="keyword">if</span> (wac != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 将获取到的 Filter 存储在delegate</span></span><br><span class="line">            <span class="built_in">this</span>.delegate = initDelegate(wac);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>中的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 根据targetBeanName从上下文中获取 Filter 过滤器</span></span><br><span class="line"><span class="keyword">protected</span> Filter <span class="title function_">initDelegate</span><span class="params">(WebApplicationContext wac)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">   <span class="comment">// 获取 spring 容器中的 targetBeanName</span></span><br><span class="line">   <span class="type">String</span> <span class="variable">targetBeanName</span> <span class="operator">=</span> getTargetBeanName();</span><br><span class="line">   <span class="comment">// 从SpringMVC中获取Filter</span></span><br><span class="line">   <span class="type">Filter</span> <span class="variable">delegate</span> <span class="operator">=</span> wac.getBean(targetBeanName, Filter.class);</span><br><span class="line">   <span class="keyword">if</span> (isTargetFilterLifecycle()) &#123;</span><br><span class="line">      delegate.init(getFilterConfig());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// 返回 Filter</span></span><br><span class="line">   <span class="keyword">return</span> delegate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>targetBeanName</code>属性的值哪来的? 看下图</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211320589.png" alt="image-20221121132040517"></p>
<p>他有4个构造函数, 其中第三个构造类我找到了 Example 代码</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211322214.png" alt="image-20221121132201135"></p>
<p>一看就知道是 <code>Shiro</code> 框架配置的<code>filter</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">DelegatingFilterProxy</span><span class="params">(String targetBeanName)</span> &#123;</span><br><span class="line">   <span class="built_in">this</span>(targetBeanName, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211345602.png" alt="image-20221121134528522"></p>
<h3 id="调用Filter的过程"><a href="#调用Filter的过程" class="headerlink" title="调用Filter的过程"></a>调用Filter的过程</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain filterChain)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果需要, 可以懒加载初始化 delegate</span></span><br><span class="line">   <span class="type">Filter</span> <span class="variable">delegateToUse</span> <span class="operator">=</span> <span class="built_in">this</span>.delegate;</span><br><span class="line">   <span class="keyword">if</span> (delegateToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>.delegateMonitor) &#123;</span><br><span class="line">         delegateToUse = <span class="built_in">this</span>.delegate;</span><br><span class="line">         <span class="keyword">if</span> (delegateToUse == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">wac</span> <span class="operator">=</span> findWebApplicationContext();</span><br><span class="line">            <span class="keyword">if</span> (wac == <span class="literal">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;No WebApplicationContext found: &quot;</span> +</span><br><span class="line">                     <span class="string">&quot;no ContextLoaderListener or DispatcherServlet registered?&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            delegateToUse = initDelegate(wac);</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="built_in">this</span>.delegate = delegateToUse;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 走我们获得的 DelegatingFilterProxy 的 doFilter</span></span><br><span class="line">   invokeDelegate(delegateToUse, request, response, filterChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">invokeDelegate</span><span class="params">(</span></span><br><span class="line"><span class="params">      Filter delegate, ServletRequest request, ServletResponse response, FilterChain filterChain)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">   delegate.doFilter(request, response, filterChain);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p><code>DelegatingFilterProxy</code>的另一个好处就是允许延迟查找<code>Filter Bean</code>实例</p>
<p>这是非常重要的, 因为在容器启动之前, 容器需要注册<code>Filter</code>实例. 然而, <code>Spring</code>通常使用<code>ContextLoaderListener</code>去加载没有完成的<code>Spring Beans</code>, 直到注册了需要的<code>Filter</code>实例之后.</p>
<h2 id="第三张图"><a href="#第三张图" class="headerlink" title="第三张图"></a>第三张图</h2><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211427142.png" alt="image-20221121142744068"></p>
<p>在<code>FilterChainProxy</code>中包含<code>Spring Security</code>的<code>servlet</code>支持.</p>
<p><code>FilterChainProxy</code>是一个<code>SpringSecurity</code>提供的特殊<code>Filter</code>, <code>FilterChainProxy</code>允许通过<code>SecurityFilterChain</code>委托给多个<code>Filter</code>实例. 因为<code>FilterChainProxy</code>是一个Bean对象, 它通常被包装在<code>DelegatingFilterProxy</code>中</p>
<h2 id="第四张图"><a href="#第四张图" class="headerlink" title="第四张图"></a>第四张图</h2><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211442719.png" alt="image-20221121144257631"></p>
<p>通过<code>FilterChainProxy</code> 使用<code>SecurityFilterChain</code> 以明确为此<code>request</code>调用哪些<code>Spring Security Filters</code></p>
<blockquote>
<p>意思就是<code>SecurityFilterChain</code>相当于<code>Filter</code>数组咯?</p>
</blockquote>
<p>在 <code>SecurityFilterChain</code>中的<code>Security Filters</code>通常是一个<code>Beans</code>, 但他们被注册在<code>FilterChainProxy</code>而不是<code>DelegatingFilterProxy.</code></p>
<p><code>FilterChainProxy</code>提供了一堆比较好的方式以直接注册到<code>Servlet</code>容器或者<code>DelegatingFilterProxy</code></p>
<p>首先, <code>FilterChainProxy</code>为所有 <code>Spring Security</code> 的 <code>Servlet</code> 支持提供了一个起点, 因为这个原因, 如果你正在尝试检修<code>Spring Security’s Servlet</code>支持, 在<code>FilterChainProxy</code>中添加一个调试点是非常好的开启方式.</p>
<p>此外, 当调用<code>SecurityFilterChain</code> 时, <code>FilterChainProxy</code>明确的提供了更多灵活的操作.</p>
<p>在<code>servlet</code>容器中, 只根据<code>URL</code>调用过滤器, 然而<code>FilterChainProxy</code>可以通过利用<code>RequestMatcher</code>接口在<code>HttpServletRequest</code>中根据任何方式确定调用关系</p>
<p>事实上, <code>FilterChainProxy</code> 可以被用于确定使用哪一个<code>SecurityFilterChain</code>. 这允许为你的引用的不同片段提供完全隔离的配置.</p>
<h2 id="第五张图"><a href="#第五张图" class="headerlink" title="第五张图"></a>第五张图</h2><p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211652993.png" alt="image-20221121165232890"></p>
<p>在多个<code>SecurityFilterChain</code>块中, <code>FilterChainProxy</code>决定使用哪一个<code>SecurityFilterChain</code>.</p>
<p>只有第一次匹配的<code>SecurityFilterChain</code>将比调用. 如果请求了<code>/api/messages/</code>的URL, 那么它将会匹配<code>SecurityFilterChain0</code>的<code>/api/**</code>, 所以即便它匹配了<code>SecurityFilterChainn</code>, 也只会调用<code>SecurityFilterChain0</code></p>
<p>如果<code>/message/</code>的URL被请求, 他将不会匹配<code>SecurityFilterChain0</code>的<code>/api/**</code>, 所以<code>FilterChainProxy</code>将会继续查找每一个<code>SecurityFilterChain</code>.</p>
<p>假设匹配的过程中没有符合的<code>SecurityFilterChain</code>, 将会匹配<code>/**</code>也就是<code>SecurityFilterChainn</code></p>
<p>注意, <code>SecurityFilterChain0</code>只有三个<code>security</code>过滤器对象被配置, 然而<code>SecurityFilterChainn</code>有四个<code>security</code>过滤器被配置.</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211713843.png" alt="image-20221121171324744"></p>
<p>重要的是要注意，每个 <code>SecurityFilterChain</code> 都可以是唯一的并且是隔离配置的。事实上，如果应用程序希望 <code>Spring Security</code> 忽略某些请求，则 <code>SecurityFilterChain</code> 可能具有零个安全过滤器</p>
<h2 id="SpringSecurity异常处理"><a href="#SpringSecurity异常处理" class="headerlink" title="SpringSecurity异常处理"></a><code>SpringSecurity</code>异常处理</h2><p><code>ExceptionTranslationFilter</code>允许将<code>AccessDeniedException</code>和<code>AuthenticationException</code>写入到HTTP 响应</p>
<p><code>ExceptionTranslationFilter</code>被插入到<code>FilterChainProxy</code>作为<code>Security Filters</code>的一部分</p>
<p><img src="https://jsd.cdn.zzko.cn/gh/bangiao/blog_images@main/blog/202211211746679.png" alt="image-20221121174603578"></p>
<ul>
<li><p>首先, <code>ExceptionTranslationFilter</code>调用了<code>FilterChain.doFilter(request, response)</code>去调用应用的<code>restful</code></p>
</li>
<li><p>如果没有认证用户, 或者它抛出了<code>AuthenticationException</code>则开始认证</p>
<ul>
<li>如果<code>SecurityContextHolder</code>被清空</li>
<li>在<code>RequestCache</code>保存了<code>HttpServletRequest</code>, 当用户认证成功, <code>RequestCache</code>被用于去回复源请求</li>
<li><code>AuthenticationEntryPoint</code>被用于从客户端请求凭据, 例如它可能重定向到登录页面, 或者发送<code>WWW-Authenticate header</code></li>
</ul>
</li>
<li><p>另外, 如果它有<code>AccessDeniedException</code>, 则访问拒绝. 调用<code>AccessDeniedHandler</code>去处理访问拒绝</p>
</li>
</ul>
<blockquote>
<p>如果应用程序未抛出<code>AccessDeniedException</code> 或者 <code>AuthenticationException</code>, 则<code>ExceptionTranslationFilter</code>不会做任何事情</p>
</blockquote>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Bangiao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://bangiao.github.io/2022/11/21/02springcloud/15SpringSecurity学习(七)/">https://bangiao.github.io/2022/11/21/02springcloud/15SpringSecurity学习(七)/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%BF%87%E6%BB%A4%E5%99%A8/">过滤器</a><a class="post-meta__tags" href="/tags/%E8%AE%A4%E8%AF%81/">认证</a><a class="post-meta__tags" href="/tags/%E7%99%BB%E5%BD%95/">登录</a><a class="post-meta__tags" href="/tags/%E8%A7%92%E8%89%B2/">角色</a><a class="post-meta__tags" href="/tags/SpringSecurity/">SpringSecurity</a><a class="post-meta__tags" href="/tags/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">源码分析</a><a class="post-meta__tags" href="/tags/%E5%9B%BE%E7%89%87%E9%AA%8C%E8%AF%81%E7%A0%81/">图片验证码</a><a class="post-meta__tags" href="/tags/%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90/">多数据源</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/11/25/02springcloud/16SpringSecurity%E5%AD%A6%E4%B9%A0(%E4%B8%83)/"><i class="fa fa-chevron-left">  </i><span>16SpringSecurity-JSON格式登录</span></a></div><div class="next-post pull-right"><a href="/2022/11/20/02springcloud/14SpringSecurity%E5%AD%A6%E4%B9%A0(%E4%B8%83)/"><span>14SpringSecurity-图片认证</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2022 By Bangiao</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">这是博客github仓库地址：<a target="_blank" rel="noopener" href="https://github.com/bangiao/bangiao.github.io">bangiao.github.io</a>，欢迎访问!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>