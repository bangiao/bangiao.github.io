<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="05OpenFeign服务接口调用"><meta name="keywords" content="服务发现,openFeign,feign"><meta name="author" content="Bangiao"><meta name="copyright" content="Bangiao"><title>05OpenFeign服务接口调用 | Bangiao's Notebooks</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.1"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.3.0'
} </script><meta name="generator" content="Hexo 6.3.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%9F"><span class="toc-number">1.</span> <span class="toc-text">OpenFeign是什么？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Feign%E5%92%8COpenFeign%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.</span> <span class="toc-text">Feign和OpenFeign的区别</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%8E%E4%B9%88%E7%94%A8%EF%BC%9F"><span class="toc-number">2.</span> <span class="toc-text">怎么用？</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign%E8%B6%85%E6%97%B6%E8%AE%BE%E7%BD%AE"><span class="toc-number">2.1.</span> <span class="toc-text">OpenFeign超时设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%BC%80%E5%90%AF%E6%97%A5%E5%BF%97%E5%A2%9E%E5%BC%BA%EF%BC%9F"><span class="toc-number">2.2.</span> <span class="toc-text">如何开启日志增强？</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#OpenFeign%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">3.</span> <span class="toc-text">OpenFeign工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">3.1.</span> <span class="toc-text">初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E4%BE%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="toc-number">3.2.</span> <span class="toc-text">实例化过程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenFeign%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">OpenFeign负载均衡源码分析</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://imgsa.baidu.com/forum/pic/item/c8179682d158ccbf63dc944d1bd8bc3eb03541a9.jpg"></div><div class="author-info__name text-center">Bangiao</div><div class="author-info__description text-center"></div><div class="follow-button"><a target="_blank" rel="noopener" href="https://github.com/bangiao">Follow Me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">35</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">187</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">6</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">我的博客</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://juejin.cn/user/4248168662314823">掘金</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://blog.csdn.net/qq_30690165">CSDN</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://www.cnblogs.com/bangiao/">博客园</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://gitee.com/bangiao_admin/projects">Gitee笔记源码</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Bangiao's Notebooks</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">文章列表</a><a class="site-page" href="/tags">文章标签</a><a class="site-page" href="/categories">文章分类</a><a class="site-page" href="/sources">笔记源码</a><a class="site-page" href="/about">关于</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">05OpenFeign服务接口调用</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-11-07</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/springcloud/">springcloud</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="OpenFeign是什么？"><a href="#OpenFeign是什么？" class="headerlink" title="OpenFeign是什么？"></a>OpenFeign是什么？</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/OpenFeign/feign">Feign</a> is a declarative web service client. It makes writing web service clients easier. To use Feign create an interface and annotate it. It has pluggable annotation support including Feign annotations and JAX-RS annotations. Feign also supports pluggable encoders and decoders. Spring Cloud adds support for Spring MVC annotations and for using the same HttpMessageConverters used by default in Spring Web. Spring Cloud integrates Eureka, Spring Cloud CircuitBreaker, as well as Spring Cloud LoadBalancer to provide a load-balanced http client when using Feign.</p>
</blockquote>
<p>feign是一个声明式的web服务客户端。它使得编写web服务客户端更加容易。要使用 feign 则需要创建一个接口并给接口添加上注解即可。<br />它具有可插入式的注解支持，包含feign注解和JAX-RS注解。feign也支持可插入的编码和解码。Spring Cloud增加了对Spring MVC注释的支持，并支持使用Spring Web中默认使用的HttpMessageConverters。当使用 Feign 时，Spring Cloud 整合了 Eureka，Spring Cloud CircuitBreaker(断路器)以及Spring Cloud LoadBalancer（负载均衡）以提供负载均衡的http client。</p>
<blockquote>
<p>说白了, openFeign就是个针对服务端映射(controller)的客户端工具, 主要目的是<strong>让 客户端 能够以类似 调用service的方式 调用到 服务端 的 controller</strong></p>
</blockquote>
<h2 id="Feign和OpenFeign的区别"><a href="#Feign和OpenFeign的区别" class="headerlink" title="Feign和OpenFeign的区别"></a>Feign和OpenFeign的区别</h2><table>
<thead>
<tr>
<th>Feign</th>
<th>openFiegn</th>
</tr>
</thead>
<tbody><tr>
<td>Feign是SpringCloud组件中一个轻量级RESTful的HTTP服务客户端，Feign内置了Ribbon，用来做客户端负载均衡，去调用服务注册中心的服务。Feign的使用方式是：使用Feign的注解定义接口，调用这个接口，就可以调用服务注册中心的服务</td>
<td>OpenFeign 是SpringCloud在Feign的基础上支持了SpringMVC的注解，如@RequestMapping等。OpenFeign 的@FeignClient可以解析SpringMVC的@RequestMapping注解下的接口，并通过动态代理的方式产生实现类，实现类中做负载均衡并调用其他服务。</td>
</tr>
</tbody></table>
<h1 id="怎么用？"><a href="#怎么用？" class="headerlink" title="怎么用？"></a>怎么用？</h1><blockquote>
<p>openFeign 也是针对客户端设计的, 所以代码一般卸载客户端上</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.zhazha<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cloud-api-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="comment">&lt;!--一般基础通用配置--&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="comment">## 指定服务名称，在nacos中的名字</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line"><span class="comment">#        register-enabled: true</span></span><br><span class="line"><span class="comment">#        watch:</span></span><br><span class="line"><span class="comment">#          enabled: true</span></span><br><span class="line">        <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="comment">## yml文件中存在特殊字符，必须用单引号包含，否则启动报错</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">&#x27;*&#x27;</span></span><br></pre></td></tr></table></figure>


<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.EnableFeignClients;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignMain80</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">		SpringApplication.run(OrderFeignMain80.class, args);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zhazha.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.zhazha.springcloud.utils.CommonResult;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 区分大小写</span></span><br><span class="line"><span class="comment">// 这里需要和服务提供方的 spring.application.name 的值相同</span></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;cloud-payment-service&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PaymentFeignService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@PostMapping(value = &quot;create&quot;)</span></span><br><span class="line">    CommonResult <span class="title function_">create</span><span class="params">(<span class="meta">@RequestBody</span> Payment payment)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.zhazha.springcloud.entities.Payment;</span><br><span class="line"><span class="keyword">import</span> com.zhazha.springcloud.service.PaymentFeignService;</span><br><span class="line"><span class="keyword">import</span> com.zhazha.springcloud.utils.CommonResult;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderFeignController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> PaymentFeignService paymentFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/consumer/payment/get/&#123;id&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title function_">getPaymentById</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> Long id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> paymentFeignService.getPaymentById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<blockquote>
<p>注意：<code>CommonResult create(@RequestBody Payment payment);</code> openFeign默认的传参方式就是JSON传参（@RequestBody），因此定义接口的时候可以不用@RequestBody注解标注，不过为了规范，一般都填上。</p>
</blockquote>
<blockquote>
<p>注意：因为 <code>openFeign</code>默认使用<code>JSON</code>传参方式，如果需要使用表单传参方式则改为<code>@SpringQueryMap</code><br><code>CommonResult create(@SpringQueryMap Payment payment);</code></p>
</blockquote>
<h2 id="OpenFeign超时设置"><a href="#OpenFeign超时设置" class="headerlink" title="OpenFeign超时设置"></a>OpenFeign超时设置</h2><p>openFeign底层默认超时判定时间是 1秒 , 如果超出 1秒就会抛出异常</p>
<p>所以在有必要的情况下, 可以自行修改超时时间</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment">## default 设置的全局超时时间，指定服务名称可以设置单个服务的超时时间</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br></pre></td></tr></table></figure>

<p>但是如果需要调用涉及到多个openFeign接口的调用呢？</p>
<p>比如下图的情况：</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070123530.png" alt="image.png"></p>
<p>很明显，<code>ServiceA </code>和 <code>ServiceB </code>能够通过，但 <code>ServiceC </code>不能够通过</p>
<p>此时我们可以单独给 <code>serviceC </code>设置超时时间：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment">## default 设置的全局超时时间，指定服务名称可以设置单个服务的超时时间</span></span><br><span class="line">      <span class="attr">default:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br><span class="line">      <span class="attr">cloud-order-service:</span></span><br><span class="line">        <span class="attr">connectTimeout:</span> <span class="number">50000</span></span><br><span class="line">        <span class="attr">readTimeout:</span> <span class="number">50000</span></span><br><span class="line">        <span class="attr">loggerLevel:</span> <span class="string">basic</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>单独设置的优先级大于 <code>default</code> </p>
</blockquote>
<h2 id="如何开启日志增强？"><a href="#如何开启日志增强？" class="headerlink" title="如何开启日志增强？"></a>如何开启日志增强？</h2><p><code>openFeign</code>虽然提供了日志增强功能，但是默认是不显示任何日志的，不过开发者在调试阶段可以自己配置日志的级别。<br /><code>openFeign</code>的日志级别如下：</p>
<ul>
<li><code>**NONE**</code>：默认的，不显示任何日志;</li>
<li><code>**BASIC**</code>：仅记录请求方法、<code>URL</code>、响应状态码及执行时间;</li>
<li><code>**HEADERS**</code>：除了<code>BASIC</code>中定义的信息之外，还有请求和响应的头信息;</li>
<li><code>**FULL**</code>：除了<code>HEADERS</code>中定义的信息之外，还有请求和响应的正文及元数据。</li>
</ul>
<p>配置起来也很简单，步骤如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> feign.Logger;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OpenfeignConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    Logger.Level <span class="title function_">feignLoggerLevel</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>注意</strong>：这里的<code>logger</code>是<code>feign</code>包里的。同时记住把 <code>application.yml</code>中的配置<code>loggerLevel: basic</code>注释掉</p>
</blockquote>
<p>接着在 <code>application.yml</code>文件中添加：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.zhazha.springcloud.service:</span> <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<p><code>FULL</code>显示出来的日志：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">2022-08-08 20:20:28.650 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] ---&gt; GET http://cloud-payment-service/payment/get/1 HTTP/1.1</span></span><br><span class="line">2022-08-08 20:20:28.651 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] ---&gt; END HTTP (0-byte body)</span></span><br><span class="line">2022-08-08 20:20:28.664 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] &lt;--- HTTP/1.1 200 (12ms)</span></span><br><span class="line">2022-08-08 20:20:28.664 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] connection: keep-alive</span></span><br><span class="line">2022-08-08 20:20:28.664 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] content-type: application/json</span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] date: Mon, 08 Aug 2022 12:20:28 GMT</span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] keep-alive: timeout=60</span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] transfer-encoding: chunked</span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] </span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] &#123;&quot;code&quot;:200,&quot;message&quot;:&quot;查询成功 port: 8001&quot;,&quot;data&quot;:&#123;&quot;id&quot;:1,&quot;serial&quot;:&quot;zhazha01&quot;&#125;&#125;</span></span><br><span class="line">2022-08-08 20:20:28.665 DEBUG 8752 --- [p-nio-80-exec-2] c.z.s.service.PaymentFeignService        : [PaymentFeignService<span class="comment">#getPaymentById] &lt;--- END HTTP (84-byte body)</span></span><br></pre></td></tr></table></figure>



<h1 id="OpenFeign工作原理"><a href="#OpenFeign工作原理" class="headerlink" title="OpenFeign工作原理"></a>OpenFeign工作原理</h1><p>大致原理图：</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070123276.png" alt="image.png"></p>
<p>分为初始化和拦截两个部分</p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>在分析代码前，添加上<br /><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070123345.png" alt="image.png"><br /><code>basePackages</code>，当然不加也行</p>
<p>从<code>@EnableFeignClients</code>注解入手分析</p>
<p>看到<code>@Import</code>注解，第一时间应当想到<code>ImportBeanDefinitionRegistrar</code>接口</p>
<blockquote>
<p>还需要想到<code>ImportSelector</code></p>
</blockquote>
<p>同时就需要了解改接口的作用主要目的就是：利用<code>registerBeanDefinitions</code>函数的<code>AnnotationMetadata importingClassMetadata</code>参数获取<code>@EnableFeignClients(basePackages = &quot;com.zhazha.springcloud.service&quot;)</code>注解的属性，然后使用<code>BeanDefinitionRegistry registry</code>去注册 <code>Bean Definition</code></p>
<blockquote>
<p>在本例子中<code>AnnotationMetadata importingClassMetadata</code>参数解析的是注解<code>EnableFeignClients</code>，在其他组件中，比如服务的发现与注册中寻找的是<code>@EnableDiscoveryClient</code>注解</p>
</blockquote>
<blockquote>
<p><code>AnnotationMetadata importingClassMetadata</code>可以获得<code>com.zhazha.springcloud.OrderFeignMain80</code>启动类上的注解</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry,</span></span><br><span class="line"><span class="params">			BeanNameGenerator importBeanNameGenerator)</span> &#123;</span><br><span class="line"></span><br><span class="line">		registerBeanDefinitions(importingClassMetadata, registry);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Register bean definitions as necessary based on the given annotation metadata of</span></span><br><span class="line"><span class="comment">	 * the importing &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; class.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;Note that &#123;<span class="doctag">@link</span> BeanDefinitionRegistryPostProcessor&#125; types may &lt;em&gt;not&lt;/em&gt; be</span></span><br><span class="line"><span class="comment">	 * registered here, due to lifecycle constraints related to &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125;</span></span><br><span class="line"><span class="comment">	 * class processing.</span></span><br><span class="line"><span class="comment">	 * &lt;p&gt;The default implementation is empty.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> importingClassMetadata annotation metadata of the importing class</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> registry current bean definition registry</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">default</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <br />在本案例中，OpenFeign使用<code>@Import</code>导入的是<code>FeignClientsRegistrar</code>类<br />从下面函数入手分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">	registerDefaultConfiguration(metadata, registry);</span><br><span class="line">	registerFeignClients(metadata, registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一段代码主要分析到的是<code>defaultConfiguration</code>属性，该属性用来自定义所有Feign客户端的配置，使用<code>@Configuration</code>进行配置。当然也可以为某一个Feign客户端进行配置。具体配置方法见<code>@FeignClient</code>的<code>configuration</code>属性。</p>
<blockquote>
<p>没用到不过也注册了一个Bean，但不分析（懒）</p>
</blockquote>
<p>核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerFeignClients</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line"></span><br><span class="line">	LinkedHashSet&lt;BeanDefinition&gt; candidateComponents = <span class="keyword">new</span> <span class="title class_">LinkedHashSet</span>&lt;&gt;();</span><br><span class="line">       <span class="comment">// 获得启动类上的注解EnableFeignClients</span></span><br><span class="line">	Map&lt;String, Object&gt; attrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName());</span><br><span class="line">       <span class="comment">// 获取该注解的 clients 属性，看看是否有被@feignClient 注解标记的类</span></span><br><span class="line">       <span class="comment">// 我们项目中并未使用该注解的clients属性，所以获取为 clients.length 长度为 0</span></span><br><span class="line">	<span class="keyword">final</span> Class&lt;?&gt;[] clients = attrs == <span class="literal">null</span> ? <span class="literal">null</span> : (Class&lt;?&gt;[]) attrs.get(<span class="string">&quot;clients&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (clients == <span class="literal">null</span> || clients.length == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="comment">// 这段代码主要目的就是扫描 basePackages 注解的包路径，本案例中我主动添加了 com.zhazha.springcloud.service</span></span><br><span class="line">           <span class="comment">// 路径，所以会扫描该路径下的所有 FeignClient 注解标记的类</span></span><br><span class="line">		<span class="type">ClassPathScanningCandidateComponentProvider</span> <span class="variable">scanner</span> <span class="operator">=</span> getScanner();</span><br><span class="line">		scanner.setResourceLoader(<span class="built_in">this</span>.resourceLoader);</span><br><span class="line">		scanner.addIncludeFilter(<span class="keyword">new</span> <span class="title class_">AnnotationTypeFilter</span>(FeignClient.class));</span><br><span class="line">           <span class="comment">// 源码在下面标记 ① 的地方</span></span><br><span class="line">		Set&lt;String&gt; basePackages = getBasePackages(metadata);</span><br><span class="line">		<span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">               <span class="comment">// 将扫描出来的类都添加到 Set 集合中</span></span><br><span class="line">               <span class="comment">// 在本案例中只能扫描到 PaymentFeignService 类</span></span><br><span class="line">               <span class="comment">// 只有他添加了 @FeignClient(value = &quot;cloud-payment-service&quot;) 注解</span></span><br><span class="line">			candidateComponents.addAll(scanner.findCandidateComponents(basePackage));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">for</span> (Class&lt;?&gt; clazz : clients) &#123;</span><br><span class="line">			candidateComponents.add(<span class="keyword">new</span> <span class="title class_">AnnotatedGenericBeanDefinition</span>(clazz));</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;</span><br><span class="line">		<span class="keyword">if</span> (candidateComponent <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">			<span class="comment">// verify annotated class is an interface</span></span><br><span class="line">			<span class="type">AnnotatedBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (AnnotatedBeanDefinition) candidateComponent;</span><br><span class="line">			<span class="type">AnnotationMetadata</span> <span class="variable">annotationMetadata</span> <span class="operator">=</span> beanDefinition.getMetadata();</span><br><span class="line">               <span class="comment">// @FeignClient 注解的类只能是接口</span></span><br><span class="line">			Assert.isTrue(annotationMetadata.isInterface(), <span class="string">&quot;@FeignClient can only be specified on an interface&quot;</span>);</span><br><span class="line">               <span class="comment">// 拿到 FeignClient 注解的所有属性信息</span></span><br><span class="line">               <span class="comment">// 这里只能拿到value = &quot;cloud-payment-service&quot; 的值，其他都是默认的</span></span><br><span class="line">			Map&lt;String, Object&gt; attributes = annotationMetadata</span><br><span class="line">					.getAnnotationAttributes(FeignClient.class.getCanonicalName());</span><br><span class="line">               <span class="comment">// 此处 name = cloud-payment-service</span></span><br><span class="line">               <span class="comment">// 此处源码：看 ②</span></span><br><span class="line">               <span class="comment">// 可以明显看到优先级</span></span><br><span class="line">			<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getClientName(attributes);</span><br><span class="line">               <span class="comment">// 获取 FeignClient 注解configuration属性的值</span></span><br><span class="line">               <span class="comment">// 我们什么都没填，但还是注入了一个 bean</span></span><br><span class="line">			registerClientConfiguration(registry, name, attributes.get(<span class="string">&quot;configuration&quot;</span>));</span><br><span class="line">               <span class="comment">// 核心代码 看 ③</span></span><br><span class="line">			registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>①<code>getBasePackages</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> Set&lt;String&gt; <span class="title function_">getBasePackages</span><span class="params">(AnnotationMetadata importingClassMetadata)</span> &#123;</span><br><span class="line">	Map&lt;String, Object&gt; attributes = importingClassMetadata</span><br><span class="line">			.getAnnotationAttributes(EnableFeignClients.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line">	Set&lt;String&gt; basePackages = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">	<span class="keyword">for</span> (String pkg : (String[]) attributes.get(<span class="string">&quot;value&quot;</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">			basePackages.add(pkg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (String pkg : (String[]) attributes.get(<span class="string">&quot;basePackages&quot;</span>)) &#123;</span><br><span class="line">		<span class="keyword">if</span> (StringUtils.hasText(pkg)) &#123;</span><br><span class="line">			basePackages.add(pkg);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">for</span> (Class&lt;?&gt; clazz : (Class[]) attributes.get(<span class="string">&quot;basePackageClasses&quot;</span>)) &#123;</span><br><span class="line">		basePackages.add(ClassUtils.getPackageName(clazz));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (basePackages.isEmpty()) &#123;</span><br><span class="line">		basePackages.add(ClassUtils.getPackageName(importingClassMetadata.getClassName()));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> basePackages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>② <code>getClientName</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String <span class="title function_">getClientName</span><span class="params">(Map&lt;String, Object&gt; client)</span> &#123;</span><br><span class="line">	<span class="keyword">if</span> (client == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) client.get(<span class="string">&quot;contextId&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(value)) &#123;</span><br><span class="line">		value = (String) client.get(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(value)) &#123;</span><br><span class="line">		value = (String) client.get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(value)) &#123;</span><br><span class="line">		value = (String) client.get(<span class="string">&quot;serviceId&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(value)) &#123;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(</span><br><span class="line">			<span class="string">&quot;Either &#x27;name&#x27; or &#x27;value&#x27; must be provided in @&quot;</span> + FeignClient.class.getSimpleName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>③<code>registerFeignClient</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 第一个函数是注册类本体</span></span><br><span class="line"><span class="comment">// 第二个是 PaymentService 上的注解元信息，在registerFeignClient方法体中只做了 getClassName 这一项操作</span></span><br><span class="line"><span class="comment">// 注解 @FeignClient 的属性 key value 我们只配置了 value -&gt; cloud-payment-service</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerFeignClient</span><span class="params">(BeanDefinitionRegistry registry, AnnotationMetadata annotationMetadata,</span></span><br><span class="line"><span class="params">			Map&lt;String, Object&gt; attributes)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取 PaymentService 的类名 com.zhazha.springcloud.service.PaymentFeignService</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> annotationMetadata.getClassName();</span><br><span class="line">        <span class="comment">// PaymentService 的类加载器</span></span><br><span class="line">		<span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> ClassUtils.resolveClassName(className, <span class="literal">null</span>);</span><br><span class="line">		<span class="type">ConfigurableBeanFactory</span> <span class="variable">beanFactory</span> <span class="operator">=</span> registry <span class="keyword">instanceof</span> ConfigurableBeanFactory</span><br><span class="line">				? (ConfigurableBeanFactory) registry : <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// contextId = cloud-payment-service</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">contextId</span> <span class="operator">=</span> getContextId(beanFactory, attributes);</span><br><span class="line">        <span class="comment">// name = cloud-payment-service</span></span><br><span class="line">		<span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getName(attributes);</span><br><span class="line">		<span class="type">FeignClientFactoryBean</span> <span class="variable">factoryBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FeignClientFactoryBean</span>();</span><br><span class="line">		factoryBean.setBeanFactory(beanFactory);</span><br><span class="line">		factoryBean.setName(name);</span><br><span class="line">		factoryBean.setContextId(contextId);</span><br><span class="line">		factoryBean.setType(clazz);</span><br><span class="line">        <span class="comment">// 判断application.yml是否设置了 feign.client.refresh-enabled 配置项，我们这里没配置</span></span><br><span class="line">		factoryBean.setRefreshableClient(isClientRefreshEnabled());</span><br><span class="line">		<span class="type">BeanDefinitionBuilder</span> <span class="variable">definition</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(clazz, () -&gt; &#123;</span><br><span class="line">			factoryBean.setUrl(getUrl(beanFactory, attributes));</span><br><span class="line">			factoryBean.setPath(getPath(beanFactory, attributes));</span><br><span class="line">			factoryBean.setDecode404(Boolean.parseBoolean(String.valueOf(attributes.get(<span class="string">&quot;decode404&quot;</span>))));</span><br><span class="line">			<span class="type">Object</span> <span class="variable">fallback</span> <span class="operator">=</span> attributes.get(<span class="string">&quot;fallback&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (fallback != <span class="literal">null</span>) &#123;</span><br><span class="line">				factoryBean.setFallback(fallback <span class="keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallback</span><br><span class="line">						: ClassUtils.resolveClassName(fallback.toString(), <span class="literal">null</span>));</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="type">Object</span> <span class="variable">fallbackFactory</span> <span class="operator">=</span> attributes.get(<span class="string">&quot;fallbackFactory&quot;</span>);</span><br><span class="line">			<span class="keyword">if</span> (fallbackFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">				factoryBean.setFallbackFactory(fallbackFactory <span class="keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallbackFactory</span><br><span class="line">						: ClassUtils.resolveClassName(fallbackFactory.toString(), <span class="literal">null</span>));</span><br><span class="line">			&#125;</span><br><span class="line">            <span class="comment">// 需要注意的 FeignClientFactoryBean 实现了 FactoryBean，所以如果需要定义一个对象时</span></span><br><span class="line">            <span class="comment">// 将会调用 FactoryBean 接口的 getObject 方法， 用于定义一个对象</span></span><br><span class="line">            <span class="comment">// 但这段代码并没有被立即调用</span></span><br><span class="line">			<span class="keyword">return</span> factoryBean.getObject();</span><br><span class="line">		&#125;);</span><br><span class="line">		definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);</span><br><span class="line">		definition.setLazyInit(<span class="literal">true</span>);</span><br><span class="line">		validate(attributes);</span><br><span class="line"></span><br><span class="line">		<span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> definition.getBeanDefinition();</span><br><span class="line">		beanDefinition.setAttribute(FactoryBean.OBJECT_TYPE_ATTRIBUTE, className);</span><br><span class="line">        <span class="comment">// 注意看这一行，我们 feign 修饰的对象 PaymentService 并没有被注入，FactoryBean也没有调用 getObject</span></span><br><span class="line">		beanDefinition.setAttribute(<span class="string">&quot;feignClientsRegistrarFactoryBean&quot;</span>, factoryBean);</span><br><span class="line"></span><br><span class="line">		<span class="comment">// has a default, won&#x27;t be null</span></span><br><span class="line">		<span class="type">boolean</span> <span class="variable">primary</span> <span class="operator">=</span> (Boolean) attributes.get(<span class="string">&quot;primary&quot;</span>);</span><br><span class="line"></span><br><span class="line">		beanDefinition.setPrimary(primary);</span><br><span class="line"></span><br><span class="line">		String[] qualifiers = getQualifiers(attributes);</span><br><span class="line">		<span class="keyword">if</span> (ObjectUtils.isEmpty(qualifiers)) &#123;</span><br><span class="line">			qualifiers = <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; contextId + <span class="string">&quot;FeignClient&quot;</span> &#125;;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="comment">// 这里将 PaymentSercice 注入到 Spring 容器中</span></span><br><span class="line">		<span class="type">BeanDefinitionHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BeanDefinitionHolder</span>(beanDefinition, className, qualifiers);</span><br><span class="line">		BeanDefinitionReaderUtils.registerBeanDefinition(holder, registry);</span><br><span class="line">        <span class="comment">// 这里还是判断是否开启 feign.client.refresh-enabled </span></span><br><span class="line">        <span class="comment">// 这里我们没有配置，所以不走</span></span><br><span class="line">        <span class="comment">// 但实际上注入了 key = feign.Request.Options-cloud-payment-service 的 paymentService</span></span><br><span class="line">        <span class="comment">// 使用 refreshScope 创建Request.Options bean 定义</span></span><br><span class="line">		registerOptionsBeanDefinition(registry, contextId);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>至此，注册完成，注意此时仅仅只是注册到 <code>DefaultListableBeanFactory</code>容器的 <code>beanDefinitionMap</code>中，并没有实例化！<br /><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124495.png" alt="image.png"></p>
<blockquote>
<p>从这行代码判断出来的，并没有实例化它，实例化的话需要去拿到远程的实现对象</p>
</blockquote>
<p>而实例化的过程需要关注 Spring 异常熟悉的<code>org.springframework.context.support.AbstractApplicationContext#refresh</code>方法</p>
<p>我们来总结下，整个流程：</p>
<ol>
<li>使用<code>@Import</code>将<code>FeignClientsRegistrar</code>对象注入到Spring容器</li>
<li>使用<code>ClassPathScanningCandidateComponentProvider</code>扫描<code>FeignClient</code>注解的<code>BasePackages</code>属性所对应的所有对象，并将其存入<code>candidateComponents</code>容器中</li>
<li>遍历<code>candidateComponents</code>对象获取<code>FeignClient</code>注解的属性信息</li>
<li>创建<code>FeignClientFactoryBean</code>对象，并填充这些属性信息，该对象实现了<code>FactoryBean</code>为以后用于容器在初始化单例对象时调用该接口的<code>getObject</code>函数</li>
<li>创建<code>holder</code>对象，并以 key &#x3D; <code>com.zhazha.springcloud.service.PaymentFeignService</code>，value &#x3D; <code>PaymentFeignService</code>的 <code>beanDefinition</code>对象</li>
<li>这里虽然往容器中存入对象，但明摆着该<code>Bean</code>无法被使用，毕竟只是一个接口，需要特殊处理</li>
</ol>
<h2 id="实例化过程"><a href="#实例化过程" class="headerlink" title="实例化过程"></a>实例化过程</h2><p>从<code>OrderFeignController</code>开始入手接着去解析<code>controller</code>下面的<code>PaymentService</code>依赖</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124176.png" alt="image.png"></p>
<p>接着从 <code>BeanFactory</code>里面拿到<code>PaymentService</code>接口</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124388.png" alt="image.png"></p>
<p>最终他会回到上面我们分享过的源码片段：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">BeanDefinitionBuilder</span> <span class="variable">definition</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(clazz, () -&gt; &#123;</span><br><span class="line">    factoryBean.setUrl(getUrl(beanFactory, attributes));</span><br><span class="line">    factoryBean.setPath(getPath(beanFactory, attributes));</span><br><span class="line">    factoryBean.setDecode404(Boolean.parseBoolean(String.valueOf(attributes.get(<span class="string">&quot;decode404&quot;</span>))));</span><br><span class="line">    <span class="type">Object</span> <span class="variable">fallback</span> <span class="operator">=</span> attributes.get(<span class="string">&quot;fallback&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fallback != <span class="literal">null</span>) &#123;</span><br><span class="line">        factoryBean.setFallback(fallback <span class="keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallback</span><br><span class="line">                                : ClassUtils.resolveClassName(fallback.toString(), <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">fallbackFactory</span> <span class="operator">=</span> attributes.get(<span class="string">&quot;fallbackFactory&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (fallbackFactory != <span class="literal">null</span>) &#123;</span><br><span class="line">        factoryBean.setFallbackFactory(fallbackFactory <span class="keyword">instanceof</span> Class ? (Class&lt;?&gt;) fallbackFactory</span><br><span class="line">                                       : ClassUtils.resolveClassName(fallbackFactory.toString(), <span class="literal">null</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> factoryBean.getObject(); <span class="comment">// 会在这里创建一个对象</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>接着就能看到核心代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> getTarget();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;T&gt; the target type of the Feign client</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> a &#123;<span class="doctag">@link</span> Feign&#125; client created with the specified data and the context</span></span><br><span class="line"><span class="comment"> * information</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">&lt;T&gt; T <span class="title function_">getTarget</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// FeignContext 在 org.springframework.cloud.openfeign.FeignAutoConfiguration#feignContext 中</span></span><br><span class="line">       <span class="comment">// 被注入到 Spring容器中</span></span><br><span class="line">       <span class="comment">// 对于 FeignContext 的说明：①</span></span><br><span class="line">	<span class="type">FeignContext</span> <span class="variable">context</span> <span class="operator">=</span> beanFactory != <span class="literal">null</span> ? beanFactory.getBean(FeignContext.class)</span><br><span class="line">			: applicationContext.getBean(FeignContext.class);</span><br><span class="line">	Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> feign(context);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!StringUtils.hasText(url)) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (LOG.isInfoEnabled()) &#123;</span><br><span class="line">			LOG.info(<span class="string">&quot;For &#x27;&quot;</span> + name + <span class="string">&quot;&#x27; URL not provided. Will try picking an instance via load-balancing.&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!name.startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">			url = <span class="string">&quot;http://&quot;</span> + name;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> &#123;</span><br><span class="line">			url = name;</span><br><span class="line">		&#125;</span><br><span class="line">		url += cleanPath();</span><br><span class="line">           <span class="comment">// 这里将会创建一个代理对象 ②</span></span><br><span class="line">		<span class="keyword">return</span> (T) loadBalance(builder, context, <span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (StringUtils.hasText(url) &amp;&amp; !url.startsWith(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">		url = <span class="string">&quot;http://&quot;</span> + url;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="built_in">this</span>.url + cleanPath();</span><br><span class="line">	<span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> getOptional(context, Client.class);</span><br><span class="line">	<span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> (client <span class="keyword">instanceof</span> FeignBlockingLoadBalancerClient) &#123;</span><br><span class="line">			<span class="comment">// not load balancing because we have a url,</span></span><br><span class="line">			<span class="comment">// but Spring Cloud LoadBalancer is on the classpath, so unwrap</span></span><br><span class="line">			client = ((FeignBlockingLoadBalancerClient) client).getDelegate();</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (client <span class="keyword">instanceof</span> RetryableFeignBlockingLoadBalancerClient) &#123;</span><br><span class="line">			<span class="comment">// not load balancing because we have a url,</span></span><br><span class="line">			<span class="comment">// but Spring Cloud LoadBalancer is on the classpath, so unwrap</span></span><br><span class="line">			client = ((RetryableFeignBlockingLoadBalancerClient) client).getDelegate();</span><br><span class="line">		&#125;</span><br><span class="line">		builder.client(client);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	applyBuildCustomizers(context, builder);</span><br><span class="line"></span><br><span class="line">	<span class="type">Targeter</span> <span class="variable">targeter</span> <span class="operator">=</span> get(context, Targeter.class);</span><br><span class="line">	<span class="keyword">return</span> (T) targeter.target(<span class="built_in">this</span>, builder, context, <span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(type, name, url));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>①<code>FeignContext</code>：<br /><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124287.png" alt="image.png"></p>
<p><code>FeignContext</code>继承了<code>NameContextFactory</code>抽象类</p>
<p>它的功能主要是为每一个<code>contextId</code>创建一个独立的<code>ApplicationContext</code><br />该对象在<code>FeignAutoConfiguration</code>配置类中将<code>FeignContext</code>注入到Spring容器中</p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124564.png" alt="image.png"></p>
<p>② <code>feign.ReflectiveFeign#newInstance</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title function_">newInstance</span><span class="params">(Target&lt;T&gt; target)</span> &#123;</span><br><span class="line">  Map&lt;String, MethodHandler&gt; nameToHandler = targetToHandlersByName.apply(target);</span><br><span class="line">  Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Method, MethodHandler&gt;();</span><br><span class="line">  List&lt;DefaultMethodHandler&gt; defaultMethodHandlers = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;DefaultMethodHandler&gt;();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Method method : target.type().getMethods()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Util.isDefault(method)) &#123;</span><br><span class="line">      <span class="type">DefaultMethodHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultMethodHandler</span>(method);</span><br><span class="line">      defaultMethodHandlers.add(handler);</span><br><span class="line">      methodToHandler.put(method, handler);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      methodToHandler.put(method, nameToHandler.get(Feign.configKey(target.type(), method)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> factory.create(target, methodToHandler);</span><br><span class="line">  <span class="type">T</span> <span class="variable">proxy</span> <span class="operator">=</span> (T) Proxy.newProxyInstance(target.type().getClassLoader(),</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123;target.type()&#125;, handler);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (DefaultMethodHandler defaultMethodHandler : defaultMethodHandlers) &#123;</span><br><span class="line">    defaultMethodHandler.bindTo(proxy);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proxy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此实例化结束</p>
<h2 id="OpenFeign负载均衡源码分析"><a href="#OpenFeign负载均衡源码分析" class="headerlink" title="OpenFeign负载均衡源码分析"></a>OpenFeign负载均衡源码分析</h2><p>前面的创建和实例化都结束了，现在是使用过程</p>
<p><code>feign.SynchronousMethodHandler#invoke</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">  <span class="type">RequestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> buildTemplateFromArgs.create(argv);</span><br><span class="line">  <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> findOptions(argv);</span><br><span class="line">  <span class="type">Retryer</span> <span class="variable">retryer</span> <span class="operator">=</span> <span class="built_in">this</span>.retryer.clone();</span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 核心代码 ①</span></span><br><span class="line">      <span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RetryableException e) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        retryer.continueOrPropagate(e);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (RetryableException th) &#123;</span><br><span class="line">        <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> th.getCause();</span><br><span class="line">        <span class="keyword">if</span> (propagationPolicy == UNWRAP &amp;&amp; cause != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> cause;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> th;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">        logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着会去这个函数：<code>feign.SynchronousMethodHandler#executeAndDecode</code></p>
<p>核心代码是：<code>response = client.execute(request, options);</code></p>
<p>接着进入这里：<code>org.springframework.cloud.openfeign.loadbalancer.FeignBlockingLoadBalancerClient#execute</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">URI</span> <span class="variable">originalUri</span> <span class="operator">=</span> URI.create(request.url());</span><br><span class="line">	<span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> originalUri.getHost();</span><br><span class="line">	Assert.state(serviceId != <span class="literal">null</span>, <span class="string">&quot;Request URI does not contain a valid hostname: &quot;</span> + originalUri);</span><br><span class="line">	<span class="type">String</span> <span class="variable">hint</span> <span class="operator">=</span> getHint(serviceId);</span><br><span class="line">	DefaultRequest&lt;RequestDataContext&gt; lbRequest = <span class="keyword">new</span> <span class="title class_">DefaultRequest</span>&lt;&gt;(</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">RequestDataContext</span>(buildRequestData(request), hint));</span><br><span class="line">	Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = LoadBalancerLifecycleValidator</span><br><span class="line">			.getSupportedLifecycleProcessors(</span><br><span class="line">					loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle.class),</span><br><span class="line">					RequestDataContext.class, ResponseData.class, ServiceInstance.class);</span><br><span class="line">	supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStart(lbRequest));</span><br><span class="line">       <span class="comment">// 核心代码</span></span><br><span class="line">	<span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(serviceId, lbRequest);</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>进入服务选择函数：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; ServiceInstance <span class="title function_">choose</span><span class="params">(String serviceId, Request&lt;T&gt; request)</span> &#123;</span><br><span class="line">       <span class="comment">// 获取 loadbalancer策略 ①</span></span><br><span class="line">	ReactiveLoadBalancer&lt;ServiceInstance&gt; loadBalancer = loadBalancerClientFactory.getInstance(serviceId);</span><br><span class="line">	<span class="keyword">if</span> (loadBalancer == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">       <span class="comment">// 核心代码 ②</span></span><br><span class="line">	Response&lt;ServiceInstance&gt; loadBalancerResponse = Mono.from(loadBalancer.choose(request)).block();</span><br><span class="line">	<span class="keyword">if</span> (loadBalancerResponse == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> loadBalancerResponse.getServer();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>①：<br /><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124233.png" alt="image.png"></p>
<p><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124671.png" alt="image.png"></p>
<p>最终发现负载均衡策略是<code>RoundRobinLoadBalancer</code>轮询</p>
<p>②<code>org.springframework.cloud.loadbalancer.core.RoundRobinLoadBalancer#choose</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Mono&lt;Response&lt;ServiceInstance&gt;&gt; <span class="title function_">choose</span><span class="params">(Request request)</span> &#123;</span><br><span class="line">	<span class="type">ServiceInstanceListSupplier</span> <span class="variable">supplier</span> <span class="operator">=</span> serviceInstanceListSupplierProvider</span><br><span class="line">			.getIfAvailable(NoopServiceInstanceListSupplier::<span class="keyword">new</span>);</span><br><span class="line">	<span class="keyword">return</span> supplier.get(request).next()</span><br><span class="line">			.map(serviceInstances -&gt; processInstanceResponse(supplier, serviceInstances));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>熟悉的接口：<code>org.springframework.cloud.loadbalancer.core.ReactorLoadBalancer</code><br /><img src="https://gcore.jsdelivr.net/gh/bangiao/blog_images@main/blog/202211070124706.png" alt="image.png"></p>
<p>回到<code>org.springframework.cloud.openfeign.loadbalancer.FeignBlockingLoadBalancerClient#execute</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> Response <span class="title function_">execute</span><span class="params">(Request request, Request.Options options)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">URI</span> <span class="variable">originalUri</span> <span class="operator">=</span> URI.create(request.url());</span><br><span class="line">	<span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> originalUri.getHost();</span><br><span class="line">	<span class="type">String</span> <span class="variable">hint</span> <span class="operator">=</span> getHint(serviceId);</span><br><span class="line">	DefaultRequest&lt;RequestDataContext&gt; lbRequest = <span class="keyword">new</span> <span class="title class_">DefaultRequest</span>&lt;&gt;(</span><br><span class="line">			<span class="keyword">new</span> <span class="title class_">RequestDataContext</span>(buildRequestData(request), hint));</span><br><span class="line">	Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors = LoadBalancerLifecycleValidator</span><br><span class="line">			.getSupportedLifecycleProcessors(</span><br><span class="line">					loadBalancerClientFactory.getInstances(serviceId, LoadBalancerLifecycle.class),</span><br><span class="line">					RequestDataContext.class, ResponseData.class, ServiceInstance.class);</span><br><span class="line">	supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStart(lbRequest));</span><br><span class="line">       <span class="comment">// 负载均衡，从多个服务提供者列表中选取一个</span></span><br><span class="line">	<span class="type">ServiceInstance</span> <span class="variable">instance</span> <span class="operator">=</span> loadBalancerClient.choose(serviceId, lbRequest);</span><br><span class="line">	org.springframework.cloud.client.loadbalancer.Response&lt;ServiceInstance&gt; lbResponse = <span class="keyword">new</span> <span class="title class_">DefaultResponse</span>(</span><br><span class="line">			instance);</span><br><span class="line">       <span class="comment">// 有默认的负载均衡策略，所以该分支不走</span></span><br><span class="line">	<span class="keyword">if</span> (instance == <span class="literal">null</span>) &#123;</span><br><span class="line">		<span class="comment">// ...</span></span><br><span class="line">	&#125;</span><br><span class="line">       <span class="comment">// 计算出目标 ip 地址 ①</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">reconstructedUrl</span> <span class="operator">=</span> loadBalancerClient.reconstructURI(instance, originalUri).toString();</span><br><span class="line">       <span class="comment">// 创建请求</span></span><br><span class="line">	<span class="type">Request</span> <span class="variable">newRequest</span> <span class="operator">=</span> buildRequest(request, reconstructedUrl);</span><br><span class="line">	<span class="type">LoadBalancerProperties</span> <span class="variable">loadBalancerProperties</span> <span class="operator">=</span> loadBalancerClientFactory.getProperties(serviceId);</span><br><span class="line">       <span class="comment">// 最后玩这里走，进行请求处理</span></span><br><span class="line">	<span class="keyword">return</span> executeWithLoadBalancerLifecycleProcessing(delegate, options, newRequest, lbRequest, lbResponse,</span><br><span class="line">			supportedLifecycleProcessors, loadBalancerProperties.isUseRawStatusCodeInResponseData());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后就是 ip 从哪里获得？<br />从负载均衡这行<code>ServiceInstance instance = loadBalancerClient.choose(serviceId, lbRequest);</code>获取了目标服务的IP地址</p>
<p>接着在<br /><code>String reconstructedUrl = loadBalancerClient.reconstructURI(instance, originalUri).toString();</code></p>
<p>①<code>reconstructURI</code>源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> URI <span class="title function_">doReconstructURI</span><span class="params">(ServiceInstance serviceInstance, URI original)</span> &#123;</span><br><span class="line">       <span class="comment">// host = 192.168.19.1 这是我们提供服务的服务器 ip 之一</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> serviceInstance.getHost();</span><br><span class="line">       <span class="comment">// scheme = http</span></span><br><span class="line">	<span class="type">String</span> <span class="variable">scheme</span> <span class="operator">=</span> Optional.ofNullable(serviceInstance.getScheme())</span><br><span class="line">			.orElse(computeScheme(original, serviceInstance));</span><br><span class="line">       <span class="comment">// port = 8002</span></span><br><span class="line">	<span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> computePort(serviceInstance.getPort(), scheme);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (Objects.equals(host, original.getHost()) &amp;&amp; port == original.getPort()</span><br><span class="line">			&amp;&amp; Objects.equals(scheme, original.getScheme())) &#123;</span><br><span class="line">		<span class="keyword">return</span> original;</span><br><span class="line">	&#125;</span><br><span class="line">       <span class="comment">// false</span></span><br><span class="line">	<span class="type">boolean</span> <span class="variable">encoded</span> <span class="operator">=</span> containsEncodedParts(original);</span><br><span class="line">       <span class="comment">// 组合完毕：http://192.168.19.1:8002/payment/get/1</span></span><br><span class="line">	<span class="keyword">return</span> UriComponentsBuilder.fromUri(original).scheme(scheme).host(host).port(port).build(encoded).toUri();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最终在这里处理请求：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Response <span class="title function_">executeWithLoadBalancerLifecycleProcessing</span><span class="params">(Client feignClient, Request.Options options,</span></span><br><span class="line"><span class="params">		Request feignRequest, org.springframework.cloud.client.loadbalancer.Request lbRequest,</span></span><br><span class="line"><span class="params">		org.springframework.cloud.client.loadbalancer.Response&lt;ServiceInstance&gt; lbResponse,</span></span><br><span class="line"><span class="params">		Set&lt;LoadBalancerLifecycle&gt; supportedLifecycleProcessors, <span class="type">boolean</span> loadBalanced, <span class="type">boolean</span> useRawStatusCodes)</span></span><br><span class="line">		<span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	supportedLifecycleProcessors.forEach(lifecycle -&gt; lifecycle.onStartRequest(lbRequest, lbResponse));</span><br><span class="line">       <span class="comment">// ...</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>至此，大体上的源码分析完毕</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Bangiao</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://bangiao.github.io/2022/11/07/02springcloud/05OpenFeign服务接口调用/">https://bangiao.github.io/2022/11/07/02springcloud/05OpenFeign服务接口调用/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/">服务发现</a><a class="post-meta__tags" href="/tags/openFeign/">openFeign</a><a class="post-meta__tags" href="/tags/feign/">feign</a></div><div class="social-share pull-right" data-disabled="google,facebook"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/11/07/02springcloud/06%E9%99%90%E6%B5%81%E4%B8%8E%E7%86%94%E6%96%AD%E7%90%86%E8%AE%BA%E9%83%A8%E5%88%86/"><i class="fa fa-chevron-left">  </i><span>06限流与熔断理论部分</span></a></div><div class="next-post pull-right"><a href="/2022/11/07/02springcloud/04%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"><span>04负载均衡</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2014 - 2022 By Bangiao</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">这是博客github仓库地址：<a target="_blank" rel="noopener" href="https://github.com/bangiao/bangiao.github.io">bangiao.github.io</a>，欢迎访问!</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/lib/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.1"></script><script src="/js/fancybox.js?version=1.9.1"></script><script src="/js/sidebar.js?version=1.9.1"></script><script src="/js/copy.js?version=1.9.1"></script><script src="/js/fireworks.js?version=1.9.1"></script><script src="/js/transition.js?version=1.9.1"></script><script src="/js/scroll.js?version=1.9.1"></script><script src="/js/head.js?version=1.9.1"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>